this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r,s,i){"use strict";const n={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const a=i.Extension.getSettings("im.v2.lib.parser");const c=a.get("v2");const o=()=>c?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const l=()=>c?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const g=()=>c?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const u=()=>c?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const d=()=>c?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const p=()=>{if(c){const e=BX.Messenger.v2.Const.Settings.message.bigSmiles;return o().getStore().getters["application/settings/get"](e)}return o().getStore().getters["application/getOption"]("bigSmileEnable")};const m=10;const f={recursiveReplace(e,t,r){if(!i.Type.isStringFilled(e)){return e}let s=0;let n=true;do{n=false;s++;e=e.replace(t,((...e)=>{n=true;return r(...e)}))}while(n&&s<=m);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,n]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(o().getUserId()===s){return`${i}/${n}`}if(o().getUserId()===i){return`${s}/${n}`}return""},getDialogIdFromFinalContextTag(e){if(!/^(chat\d+|\d+)\/\d+$/.test(e)){return""}const[t]=e.split("/");return t},getDialogIdByChatId(e){const t=o().store.getters["chats/getByChatId"](e);if(!t){return""}return t.dialogId}};const{FileType:h,FileIconType:T,AttachDescription:x}=u();const b={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:r,files:s}=e;if(i.Type.isArrayFilled(s)||s===true){t=this.getTextForFile(t,s)}else if(r===true||i.Type.isArrayFilled(r)||i.Type.isStringFilled(r)){t=this.getTextForAttach(t,r)}return t.trim()},getQuoteBlock(){const e=this.getIcon(T.quote);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(T.code);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(T.image);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(T.file);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let r=e;if(i.Type.isArray(t)&&t.length>0){r=this.getIconTextForFile(e,t)}else if(t===true){r=this.getIconTextForFileType(e,T.file)}return r},getTextForAttach(e,t){let r="";if(i.Type.isArray(t)&&t.length>0){const[e]=t;if(i.Type.isStringFilled(e.description)){r=e.description}}else if(i.Type.isStringFilled(t)){r=t}if(i.Type.isStringFilled(r)){if(r===x.skipMessage){r=""}else{r=he.purifyText(r)}}else{const e=this.getIcon(T.attach);if(e){r=`${e} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${r}`.trim()},getIconTextForFileType(e,t=T.file){let r=e;const s=this.getIcon(t);const n=i.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(s){const t=e.replace(/(\s|\n)/gi,"").length>0;const i=t?e:n;r=`${s} ${i}`}else{r=`[${n}] ${e}`}return r.trim()},getIconTextForFile(e,t){const r=e.replace(/(\s|\n)/gi,"").length>0;const[s]=t;if(!s||!s.type){return e}const n=t.every((e=>[T.image,T.video].includes(e.type)));if(s.type===h.image&&t.length===1){return this.getIconTextForFileType(e,T.image)}else if(n&&t.length>1){return this.getIconTextForFileType(e,T.gallery)}else if(s.type===h.audio){return this.getIconTextForFileType(e,T.audio)}else if(s.type===h.video){return this.getIconTextForFileType(e,T.video)}else{const t=this.getIcon(T.file);if(t){const i=r?e:"";e=`${t} ${s.name} ${i}`}else{e=`${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${s.name} ${e}`}return e.trim()}}};let y=e=>e,E,I;const{EventType:M}=u();const _="&gt;&gt;";const S="none";const R={decodeArrowQuote(e){if(!e.includes(_)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(_)){continue}const s=e;const i=`<div data-context="${S}" class="bx-im-message-quote --inline">`;const n='<div class="bx-im-message-quote__wrap">';const a="</div>";r[s]=r[s].replace(_,`${i}${n}`);while(++e<r.length&&r[e].startsWith(_)){r[e]=r[e].replace(_,"")}const c=e-1;r[c]+=`${a}${a}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${_}(.*))`,"gim"),b.getQuoteBlock()+t);return e},decodeQuote(e,{contextDialogId:t=""}={}){return e.replaceAll(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,r,s,n,a,c)=>{const o=L(s,n,c);const l=v(s,n);const g=C(a,t);const u=i.Tag.render(E||(E=y`
					<div class='bx-im-message-quote' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),g,l,o);return u.outerHTML}))},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,b.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,r)=>i.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:r}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,b.getCodeBlock()+t)},executeClickEvent(e){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const t=l().dom.recursiveBackwardNodeSearch(e.target,"bx-im-message-quote");if(!t||t.dataset.context===S){return}const[s,i]=t.dataset.context.split("/");r.EventEmitter.emit(M.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const L=(e,t,r)=>{const s=e&&t;if(!s&&!r){return String(t)}const i="<br />";if(r.endsWith(i)){return r.slice(0,-i.length)}return r};const v=(e,t)=>{const r=e&&t;if(!r){return""}return i.Tag.render(I||(I=y`
		<div class='bx-im-message-quote__name'>
			<div class="bx-im-message-quote__name-text">${0}</div>
			<div class="bx-im-message-quote__name-time">${0}</div>
		</div>
	`),e.trim(),t.trim())};const C=(e,t)=>{if(!e){return S}const r=e.trim().slice(1);const s=f.getFinalContextTag(r);if(!$(s,t)){return S}return s};const $=(e,t)=>{const r=f.getDialogIdFromFinalContextTag(e);return r===t};let A=e=>e,N;const P=Object.freeze({small:"small",medium:"medium",large:"large"});const F={decodeLink(e){return e.replaceAll(/>((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+[^<])?)<\/a>/gi,((e,t)=>{const r=i.Text.decode(t);if(!/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i.test(r)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}if(!l().text.checkUrl(r)){return e}const s=i.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[i.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:r},events:{error(){F.hideErrorImage(this)}}})]}).outerHTML;return`>${s}</a>`}))},purifyLink(e){return e.replaceAll(/(.)?(https?:\/\/\S+)/gi,((e,t,r)=>{if(!O(t,r)){return e}const s=t||"";return`${s}${b.getImageBlock()}`}))},decodeIcon(e){let t=0;const r=p();if(r){t=e.replaceAll(/\[icon=([^\]]*)]/gi,"").trim().length}return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let s=e.match(/icon=(\S+[^\s!"'),.;>?\]])/i);if(s&&s[1]){s=s[1]}else{return""}if(!l().text.checkUrl(s)){return e}const n={src:s,border:0};const a=e.match(/size=(\d+)/i);if(a&&a[1]){n.width=a[1];n.height=a[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){n.width=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){n.height=r[1]}if(n.width&&!n.height){n.height=n.width}else if(n.height&&!n.width){n.width=n.height}else if(n.height&&n.width);else{n.width=20;n.height=20}}n.width=n.width>100?100:n.width;n.height=n.height>100?100:n.height;if(r&&t===0&&n.width===n.height&&n.width===20){n.width=40;n.height=40}let c=e.match(/title=(.*[^\s\]])/i);if(c&&c[1]){c=c[1];if(c.includes("width=")){c=c.slice(0,Math.max(0,c.indexOf("width=")))}if(c.includes("height=")){c=c.slice(0,Math.max(0,c.indexOf("height=")))}if(c.includes("size=")){c=c.slice(0,Math.max(0,c.indexOf("size=")))}if(c){n.title=i.Text.decode(c).trim();n.alt=n.title}}return i.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...n}}).outerHTML}))},purifyIcon(e){return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.includes("width=")){t=t.slice(0,Math.max(0,t.indexOf("width=")))}if(t.includes("height=")){t=t.slice(0,Math.max(0,t.indexOf("height=")))}if(t.includes("size=")){t=t.slice(0,Math.max(0,t.indexOf("size=")))}if(t){t=`(${t.trim()})`}}else{t=`(${i.Loc.getMessage("IM_PARSER_IMAGE_ICON")})`}return t}))},purifyImageBbCode(e){const t=Object.values(P).join("|");const r=new RegExp(`\\[img\\s+size=(${t})]([\\s\\S]*?)\\[\\/img]`,"gi");return e.replaceAll(r,(()=>b.getImageBlock()))},hideErrorImage(e){const t=e;if(t&&t.parentNode){t.parentNode.innerHTML=`<a href="${encodeURI(e.src)}" target="_blank">${e.src}</a>`}},decodeImageBbCode(e,{contextDialogId:t=""}={}){if(!i.Type.isStringFilled(e)){return""}return e.replaceAll(/\[img(?:\s+size=([^\]]+))?]\s*(?:\[url])?([\S\s]*?)(?:\[\/url])?\s*\[\/img]/gi,((e,r,s)=>{const n=i.Text.decode(s);const a=r&&Object.values(P).includes(r.toLowerCase());const c=["/docs/pub/","logout=yes"].includes(n.toLowerCase());const g=l().text.checkUrl(n);const u=U(n);const d=j(n);if(!a||c||!g||!u||d){return e.replaceAll(/\[url]([\S\s]*?)\[\/url]/gi,"$1")}const p=`bx-im-message-image--${r}`;const{file:m}=l();const f=o().store.getters["chats/get"](t,true);const h=f.chatId;const T=m.getViewerDataForImageSrc({src:n,viewerGroupBy:h});const x=i.Tag.render(N||(N=A`
					<a class='bx-im-message-image ${0}'>
						<img
							class='bx-im-message-image-source'
							src="${0}"
						/>
					</a>
				`),p,n);i.Dom.attr(x.firstChild,T);return x.outerHTML}))}};function w(e){return e.toLowerCase().indexOf("/docs/pub/")>0}function D(e){return e.toLowerCase().indexOf("logout=yes")>0}function B(e){const[t]=e.split("?");return/\.(jpg|jpeg|png|gif|webp)$/i.test(t)}function k(e){const t=new Set([">","]"," "]);return i.Type.isStringFilled(e)&&!t.has(e)}function O(e,t){return B(t)&&!w(t)&&!D(t)&&!k(e)}function U(e){return/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i.test(e.trim())}function j(e){return/\[img/i.test(e.trim())}let H=e=>e,X;const z=Object.freeze({Default:1,Big:1.6});const q=(e,t,r=z)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const n=new RegExp(`(?:(?:${t})\\s*){4,}`);if(i&&!n.test(e)){return r.Big}return r.Default};const Q=e=>{const t=e.reduce(((e,t)=>{const{image:r,typing:s,definition:n,name:a,width:c,height:o}=t;const l=i.Tag.render(X||(X=H`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
				draggable="false"
			/>
		`),r,s,n,a!=null?a:s,s,c,o);return{...e,[s]:l}}),{});return t};const W=function(e,t,r){const s=e.slice(0,r+t.length);const i=l().text.escapeRegex(t);const n=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(n)};const G={typings:null,pattern:"",loadSmilePatterns(){var e,t;if(!d()){return}const r=d().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];if(s.length===0){return}const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>l().text.escapeRegex(e.typing))).join("|");this.typings=Q(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let r;if(i.Type.isBoolean(t.enableBigSmile)){r=t.enableBigSmile}else{r=p()}const s=i.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:z;const n=r?q(e,this.pattern,s):s.Default;const a=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const c=new RegExp(a,"g");const o=e.replaceAll(c,((t,r)=>{const s=W.call(this,e,t,r);if(!s){return t}const a=this.typings[t].cloneNode();const{width:c,height:o}=a.style;i.Dom.style(a,"width",`${Number.parseInt(c,10)*n}px`);i.Dom.style(a,"height",`${Number.parseInt(o,10)*n}px`);return a.outerHTML}));return o}};const Y={decode(e,t={}){const{urlTarget:r="_blank",removeLinks:s=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,s)=>{const n=i.Text.decode(t||s);if(!l().text.checkUrl(n)){return s}return i.Dom.create({tag:"a",attrs:{href:n,target:r},html:s}).outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,s)=>{let n=i.Text.decode(t||s);if(!l().text.checkUrl(n)){return s}if(!n.slice(n.lastIndexOf("[")).includes("]")){if(s.startsWith("]")){n=`${n}]`;s=s.slice(1)}else if(s.startsWith("=")){const e=i.Text.decode(s.slice(1,s.lastIndexOf("]")));n=`${n}]=${e}`;s=s.slice(s.lastIndexOf("]")+1)}}return i.Dom.create({tag:"a",attrs:{href:n,target:r},html:s}).outerHTML}));if(s){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e}};const K={decode(e){e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return i.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:r}).outerHTML}));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>i.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));return e},purify(e,t=true){if(t){e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};let V=e=>e,J;const Z={decode(e){let t=e;t=t.replaceAll(/\[like]/gi,`<span class="bx-im-lines-vote-like" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}"></span>`);t=t.replaceAll(/\[dislike]/gi,`<span class="bx-im-lines-vote-dislike" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}"></span>`);t=t.replaceAll(/\[rating=([1-5])]/gi,((e,t)=>{const r=i.Tag.render(J||(J=V`
				<span class="bx-im-lines-rating" title="${0} - ${0}">
					<span class="bx-im-lines-rating-selected" style="width: ${0}%"></span>
				</span>
			`),i.Loc.getMessage("IM_PARSER_LINES_RATING"),t,t*20);return r.outerHTML}));return t},purify(e){let t=e;t=t.replaceAll(/\[like]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));t=t.replaceAll(/\[dislike]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));t=t.replaceAll(/\[rating=([1-5])]/gi,(()=>`[${i.Loc.getMessage("IM_PARSER_LINES_RATING")}] `));return t}};const{EventType:ee}=u();const te={put:"put",send:"send"};const re={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("put",r,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",r,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},_getHtmlForAction(e,t,r){return i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:r})]}).outerHTML},executeClickEvent(e){var t;if(!i.Dom.hasClass(e.target,"bx-im-message-command")){return}const s=e.target;const n=se(s);const a=(t=ie(n))!=null?t:"";if(s.dataset.entity===te.put){const{innerText:e=""}=s.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(ee.textarea.insertText,{text:e,dialogId:a})}else if(s.dataset.entity===te.send){const{innerText:e=""}=s.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(ee.textarea.sendMessage,{text:e,dialogId:a})}}};const se=e=>{const t=e.closest(".bx-im-message-base__wrap");if(!t||!t.dataset.id){return null}return t.dataset.id};const ie=e=>{const t=o().getStore().getters["messages/getById"](e);if(!t){return null}const r=o().getStore().getters["chats/getByChatId"](t.chatId);if(!r){return null}return r.dialogId};const{MessageMentionType:ne}=u();const ae={decode(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>{if(!r){return e}let s="";if(t){s=t}else if(l.call.isNumber(r)){s=r}else{return e}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":ne.call,"data-destination":s},text:i.Text.decode(r)}).outerHTML}));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>""));return t},purify(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>r||t));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>r));return t}};const{UserType:ce,EventType:oe,MessageMentionType:le}=u();const ge={decode(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}const n=o().getStore().getters["users/get"](t);if(r||!s){if(n){s=n.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}let a="bx-im-mention";if(o().getUserId()===t){a+=" --highlight"}if(n&&n.type===ce.extranet){a+=" --extranet"}return i.Dom.create({tag:"span",attrs:{className:a,"data-type":le.user,"data-value":t},text:s}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,r,s)=>{if(r===0){return s}let n=s;if(n){n=i.Text.decode(n)}else{const e=o().store.getters["chats/get"](`chat${r}`);n=e?e.name:`Chat ${r}`}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":t?le.lines:le.chat,"data-value":t?`imol|${r}`:`chat${r}`},text:n}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){return""}s=i.Text.decode(s);t=f.getFinalContextTag(t);if(!t){return s}const n=t.split("/")[0];let a="";r=Number.parseInt(r,10);if(i.Type.isNumber(r)&&r>0){const e=o().store.getters["messages/getById"](r);if(e){a=he.purifyMessage(e);const t=o().store.getters["users/get"](e.authorId);if(t){a=`${t.name}: ${a}`}}}if(!i.Type.isStringFilled(a)){a=i.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":le.context,"data-dialog-id":n,"data-message-id":r,title:a},text:s}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}if(r||!s){const e=o().getStore().getters["users/get"](t);if(e){s=e.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}return s}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=o().store.getters["chats/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=o().store.getters["chats/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e){if(!i.Dom.hasClass(e.target,"bx-im-mention")){return}if(e.target.dataset.type===le.user||e.target.dataset.type===le.chat){void s.Messenger.openChat(e.target.dataset.value)}else if(e.target.dataset.type===le.lines){const t=e.target.dataset.value;if(l().dialog.isLinesHistoryId(t)){void s.Messenger.openLinesHistory(t)}else if(l().dialog.isLinesExternalId(t)){void s.Messenger.openLines(t)}}else if(e.target.dataset.type===le.context){r.EventEmitter.emit(oe.dialog.goToMessageContext,{messageId:Number.parseInt(e.target.dataset.messageId,10),dialogId:e.target.dataset.dialogId.toString()})}else if(e.target.dataset.type===le.call){if(l().call.isNumber(e.target.dataset.destination)){void s.Messenger.startPhoneCall(e.target.dataset.destination)}}}};const ue={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const de={decode(e){const t=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`;return e.replaceAll(/\[disk=\d+]/gi,t)},purify(e){return this.decode(e)}};const pe={decode(e){return me(e)},purify(e){return me(e)}};const me=e=>{const t=/\[timestamp=(?<timestamp>\d+)\s+format=(?<format>[_a-z]+)]/gi;return e.replaceAll(t,((e,...t)=>{const{timestamp:r,format:s}=t.at(-1);const n=i.Reflection.getClass("BX.Messenger.v2.Lib.DateFormatter");const a=i.Reflection.getClass("BX.Messenger.v2.Lib.DateFormat");const c=i.Reflection.getClass("BX.Messenger.v2.Lib.DateCode");if(!n){return e}const o=Number(r)*1e3;const l=new Date(o);const g=i.Text.toCamelCase(s);const u=Object.keys(a);if(!u.includes(g)){return e}return n.formatByCode(l,c[g])}))};const fe={putReplacement:[],sendReplacement:[],codeReplacement:[],clean(){this.putReplacement=[];this.sendReplacement=[];this.codeReplacement=[]},cutPutTag(e){return e.replaceAll(/\[put(?:=(.+?))?](.+?)?\[\/put]/gi,(e=>{const t=this.putReplacement.length;this.putReplacement.push(e);return`####REPLACEMENT_PUT_${t}####`}))},recoverPutTag(e){this.putReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_PUT_${r}####`,t)}));return e},cutSendTag(e){e=e.replaceAll(/\[send(?:=(.+?))?](.+?)?\[\/send]/gi,(e=>{const t=this.sendReplacement.length;this.sendReplacement.push(e);return`####REPLACEMENT_SEND_${t}####`}));return e},recoverSendTag(e){this.sendReplacement.forEach(((t,r)=>{const s=`####REPLACEMENT_SEND_${r}####`;e=e.split(s).join(t)}));return e},cutCodeTag(e){e=e.replaceAll(/\[code](<br \/>)?(.*?)\[\/code]/gis,(e=>{const t=this.codeReplacement.length;this.codeReplacement.push(e);return`####REPLACEMENT_CODE_${t}####`}));return e},recoverCodeTag(e){this.codeReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_CODE_${r}####`,t)}));this.sendReplacement.forEach(((t,r)=>{e=e.replaceAll(`####REPLACEMENT_SEND_${r}####`,t)}));return e},recoverRecursionTag(e){if(this.sendReplacement.length>0){this.sendReplacement.forEach(((t,r)=>{e=e.replaceAll(`####REPLACEMENT_SEND_${r}####`,t)}))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this.putReplacement.length>0){do{this.putReplacement.forEach(((t,r)=>{e=e.replace(`####REPLACEMENT_PUT_${r}####`,t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const he={decodeMessage(e){const t=o().store.getters["messages/getMessageFiles"](e.id);const r=f.getDialogIdByChatId(e.chatId);return this.decode({text:e.text,attach:e.attach,files:t,showIconIfEmptyText:false,contextDialogId:r})},decodeNotification(e){var r;return this.decode({text:e.text,attach:(r=e.params.attach)!=null?r:false,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:t.DesktopApi.isDesktop()?"_blank":"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmile(e,t){return G.decodeSmile(e,t)},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return G.decodeSmile(e,r)},decode(e){if(!i.Type.isPlainObject(e)){g().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:r=false,files:s=false,removeLinks:a=false,showIconIfEmptyText:c=true,showImageFromLink:o=true,contextDialogId:l="",urlTarget:u="_blank"}=e;if(!i.Type.isString(t)){if(i.Type.isNumber(t)){return t.toString()}return""}if(!t){if(c){t=b.addIconToShortText({text:t,attach:r,files:s})}return t.trim()}t=i.Text.encode(t.trim());t=ue.decodeNewLine(t);t=ue.decodeTabulation(t);t=fe.cutPutTag(t);t=fe.cutSendTag(t);t=fe.cutCodeTag(t);t=G.decodeSmile(t);t=n.decode(t);t=F.decodeImageBbCode(t,{contextDialogId:l});t=Y.decode(t,{urlTarget:u,removeLinks:a});t=K.decode(t);t=Z.decode(t);t=ge.decode(t);t=ae.decode(t);t=F.decodeIcon(t);if(o){t=F.decodeLink(t)}t=de.decode(t);t=pe.decode(t);t=R.decodeArrowQuote(t);t=R.decodeQuote(t,{contextDialogId:l});t=fe.recoverSendTag(t);t=re.decodeSend(t);t=fe.recoverPutTag(t);t=re.decodePut(t);t=fe.recoverCodeTag(t);t=R.decodeCode(t);t=fe.recoverRecursionTag(t);t=ue.removeDuplicateTags(t);fe.clean();return t},purifyMessage(e){const t=o().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:e.attach,files:t})},purifyNotification(e){var t;const r=o().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.attach)!=null?t:false,files:r})},purifyRecent(e){const t=i.Extension.getSettings("im.v2.lib.parser");const r=t.get("v2");if(!r){const{files:t,attach:r,text:s}=this.prepareLegacyConfigForRecent(e);return this.purify({text:s,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})}const{files:s,attach:n,text:a}=this.prepareConfigForRecent(e);return this.purify({text:a,attach:n,files:s,showPhraseMessageWasDeleted:e.messageId!==0})},purifyText(e){return this.purify({text:e})},purify(e){if(!i.Type.isPlainObject(e)){g().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:r=false,files:s=false,showPhraseMessageWasDeleted:a=true}=e;if(!i.Type.isString(t)){t=i.Type.isNumber(t)?t.toString():""}if(!t){t=b.addIconToShortText({text:t,attach:r,files:s});return t.trim()}t=i.Text.encode(t.trim());t=ue.purifyNewLine(t,"\n");t=n.purify(t);t=R.purifyArrowQuote(t);t=R.purifyQuote(t);t=R.purifyCode(t);t=re.purifyPut(t);t=re.purifySend(t);t=ge.purify(t);t=K.purify(t);t=Z.purify(t);t=ae.purify(t);t=Y.purify(t);t=F.purifyLink(t);t=F.purifyIcon(t);t=F.purifyImageBbCode(t);t=de.purify(t);t=pe.purify(t);t=ue.purifyNewLine(t);t=b.addIconToShortText({text:t,attach:r,files:s});if(t.length>0){t=i.Text.decode(t)}else if(a){t=i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e,t=""){const{id:r,attach:s}=e;let n=t===""?e.text:t;const a=o().store.getters["messages/getMessageFiles"](r);n=i.Text.encode(n.trim());n=ge.purify(n);n=ae.purify(n);n=Z.purify(n);n=ue.purifyBreakLine(n,"\n");n=ue.purifyNbsp(n);n=Y.removeSimpleUrlTag(n);n=R.purifyCode(n," ");n=R.purifyQuote(n," ");n=R.purifyArrowQuote(n," ");if(t===""){n=b.addIconToShortText({text:n,attach:s,files:a})}n=n.length>0?i.Text.decode(n):i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return n.trim()},prepareEdit(e){let{text:t}=e;t=Y.removeSimpleUrlTag(t);t=ge.purify(t);return t.trim()},prepareCopy(e){let{text:t}=e;t=Y.removeSimpleUrlTag(t);return t.trim()},prepareCopyFile(e){const{id:t}=e;const r=o().store.getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));return r.join("\n").trim()},prepareConfigForRecent(e){let t=o().store.getters["messages/getMessageFiles"](e.messageId);if(t.length===0){t=false}const r=o().store.getters["messages/getById"](e.messageId);let s=false;if(i.Type.isBoolean(r==null?void 0:r.attach)||i.Type.isStringFilled(r==null?void 0:r.attach)||i.Type.isArray(r==null?void 0:r.attach)){s=r.attach}else if(i.Type.isPlainObject(r==null?void 0:r.attach)){s=[r.attach]}return{files:t,attach:s,text:r.text}},prepareLegacyConfigForRecent(e){let t=false;const r=e.message.params.withFile;if(i.Type.isBoolean(r)){t=r}else if(i.Type.isPlainObject(r)){t=[r]}let s=false;const n=e.message.params.withAttach;if(i.Type.isBoolean(n)||i.Type.isStringFilled(n)||i.Type.isArray(n)){s=n}else if(i.Type.isPlainObject(n)){s=[n]}return{files:t,attach:s,text:e.message.text}},executeClickEvent(e){ge.executeClickEvent(e);R.executeClickEvent(e);re.executeClickEvent(e)},getContextCodeFromForwardId(e){return f.getFinalContextTag(e)}};e.Parser=he})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=parser.bundle.map.js