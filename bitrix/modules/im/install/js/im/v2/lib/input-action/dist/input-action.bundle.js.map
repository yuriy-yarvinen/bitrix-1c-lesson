{"version":3,"file":"input-action.bundle.js","sources":["../src/input-action.js"],"sourcesContent":["import { Core } from 'im.v2.application.core';\nimport { ChatType } from 'im.v2.const';\n\nimport type { ImModelChat } from 'im.v2.model';\n\nexport const InputAction = {\n\twriting: 'writing',\n\trecordingVoice: 'recordingVoice',\n\tsendingFile: 'sendingFile',\n};\n\nexport type InputActionType = $Values<typeof InputAction>;\n\ntype ActionPayload = {\n\ttype: InputActionType,\n\tdialogId: string,\n\tuserId: number,\n\tuserName?: string,\n\tstatusMessageCode: string | null,\n\tuserFirstName: string,\n\tduration: number | null,\n};\n\nconst DEFAULT_ACTION_DURATION = 25000;\nconst ActionDurationMap = {\n\t[InputAction.writing]: {\n\t\t[ChatType.copilot]: 180_000,\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n\t[InputAction.recordingVoice]: {\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n\t[InputAction.sendingFile]: {\n\t\tdefault: DEFAULT_ACTION_DURATION,\n\t},\n};\n\nexport class InputActionListener\n{\n\tstatic #instance: InputActionListener;\n\n\t#actionTimers: {[timerId: string]: number} = {};\n\n\tstatic getInstance(): InputActionListener\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstartAction(actionPayload: ActionPayload)\n\t{\n\t\tif (this.#isAlreadyActive(actionPayload))\n\t\t{\n\t\t\tthis.stopAction(actionPayload);\n\t\t}\n\n\t\tvoid Core.getStore().dispatch('chats/inputActions/start', actionPayload);\n\t\tconst timerId = this.#buildTimerId(actionPayload);\n\t\tthis.#actionTimers[timerId] = this.#setTimer(actionPayload);\n\t}\n\n\tstopAction(actionPayload: { userId: number, dialogId: string })\n\t{\n\t\tif (!this.#isAlreadyActive(actionPayload))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst timerId = this.#buildTimerId(actionPayload);\n\t\tthis.#clearTimer(timerId);\n\n\t\tvoid Core.getStore().dispatch('chats/inputActions/stop', actionPayload);\n\t}\n\n\tclear()\n\t{\n\t\tObject.values(this.#actionTimers).forEach((timerId) => {\n\t\t\tclearTimeout(timerId);\n\t\t});\n\t\tthis.#actionTimers = {};\n\t}\n\n\t#isAlreadyActive(payload: ActionPayload): boolean\n\t{\n\t\treturn Core.getStore().getters['chats/inputActions/isActionActive'](payload);\n\t}\n\n\t#buildTimerId(payload: ActionPayload): string\n\t{\n\t\tconst { dialogId, userId } = payload;\n\n\t\treturn `${dialogId}|${userId}`;\n\t}\n\n\t#setTimer(payload: ActionPayload): number\n\t{\n\t\tconst actionDuration = this.#getActionDuration(payload);\n\n\t\treturn setTimeout(() => {\n\t\t\tthis.stopAction(payload);\n\t\t}, actionDuration);\n\t}\n\n\t#clearTimer(timerId: string): void\n\t{\n\t\tclearTimeout(this.#actionTimers[timerId]);\n\t\tdelete this.#actionTimers[timerId];\n\t}\n\n\t#getActionDuration(payload: ActionPayload): number\n\t{\n\t\tconst { type, dialogId, duration } = payload;\n\t\tif (duration && duration > 0)\n\t\t{\n\t\t\treturn duration;\n\t\t}\n\n\t\tconst typeDurationMap = ActionDurationMap[type];\n\t\tconst chat: ImModelChat = Core.getStore().getters['chats/get'](dialogId, true);\n\n\t\treturn typeDurationMap[chat.type] ?? typeDurationMap.default;\n\t}\n}\n"],"names":["InputAction","writing","recordingVoice","sendingFile","DEFAULT_ACTION_DURATION","ActionDurationMap","ChatType","copilot","default","InputActionListener","getInstance","startAction","actionPayload","stopAction","Core","getStore","dispatch","timerId","clear","Object","values","forEach","clearTimeout","payload","getters","dialogId","userId","actionDuration","setTimeout","type","duration","typeDurationMap","chat"],"mappings":"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"}