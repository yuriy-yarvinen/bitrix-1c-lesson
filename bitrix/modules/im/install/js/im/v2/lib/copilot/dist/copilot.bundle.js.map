{"version":3,"file":"copilot.bundle.js","sources":["../src/copilot.js"],"sourcesContent":["import { ChatType, MessageComponent } from 'im.v2.const';\nimport { Core } from 'im.v2.application.core';\nimport { Feature, FeatureManager } from 'im.v2.lib.feature';\n\nimport type { JsonObject } from 'main.core';\nimport type { Store } from 'ui.vue3.vuex';\nimport type { ImModelMessage, ImModelUser, ImModelChat } from 'im.v2.model';\n\nexport class CopilotManager\n{\n\tstore: Store;\n\n\tconstructor()\n\t{\n\t\tthis.store = Core.getStore();\n\t}\n\n\tasync handleRecentListResponse(copilotData: JsonObject): Promise\n\t{\n\t\tif (!copilotData)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst { recommendedRoles, roles, chats, messages } = copilotData;\n\t\tif (!roles)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn Promise.all([\n\t\t\tthis.store.dispatch('copilot/chats/add', chats),\n\t\t\tthis.store.dispatch('copilot/roles/add', roles),\n\t\t\tthis.store.dispatch('copilot/setRecommendedRoles', recommendedRoles),\n\t\t\tthis.store.dispatch('copilot/messages/add', messages),\n\t\t]);\n\t}\n\n\tasync handleChatLoadResponse(copilotData: JsonObject): Promise\n\t{\n\t\tif (!copilotData)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst { aiProvider, chats, roles, messages } = copilotData;\n\t\tif (!roles)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn Promise.all([\n\t\t\tthis.store.dispatch('copilot/setProvider', aiProvider),\n\t\t\tthis.store.dispatch('copilot/roles/add', roles),\n\t\t\tthis.store.dispatch('copilot/chats/add', chats),\n\t\t\tthis.store.dispatch('copilot/messages/add', messages),\n\t\t]);\n\t}\n\n\tasync handleRoleUpdate(copilotData: JsonObject): Promise\n\t{\n\t\tconst { chats, roles } = copilotData;\n\t\tif (!roles)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn Promise.all([\n\t\t\tthis.store.dispatch('copilot/roles/add', roles),\n\t\t\tthis.store.dispatch('copilot/chats/add', chats),\n\t\t]);\n\t}\n\n\tasync handleMessageAdd(copilotData): Promise\n\t{\n\t\tconst { chats, roles, messages } = copilotData;\n\t\tif (!roles)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn Promise.all([\n\t\t\tthis.store.dispatch('copilot/roles/add', roles),\n\t\t\tthis.store.dispatch('copilot/chats/add', chats),\n\t\t\tthis.store.dispatch('copilot/messages/add', messages),\n\t\t]);\n\t}\n\n\tgetRoleAvatarUrl({ avatarDialogId, contextDialogId }: { avatarDialogId: string, contextDialogId: string }): ?string\n\t{\n\t\tif (!this.isCopilotChatOrBot(avatarDialogId))\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn this.store.getters['copilot/chats/getRoleAvatar'](contextDialogId);\n\t}\n\n\tisCopilotBot(userId: string | number): boolean\n\t{\n\t\treturn this.store.getters['users/bots/isCopilot'](userId);\n\t}\n\n\tisCopilotChat(dialogId: string): boolean\n\t{\n\t\treturn this.store.getters['chats/get'](dialogId)?.type === ChatType.copilot;\n\t}\n\n\tisCopilotChatOrBot(dialogId: string): boolean\n\t{\n\t\treturn this.isCopilotChat(dialogId) || this.isCopilotBot(dialogId);\n\t}\n\n\tisGroupCopilotChat(dialogId: string): boolean\n\t{\n\t\tconst { userCounter }: ImModelChat = this.store.getters['chats/get'](dialogId);\n\n\t\treturn this.isCopilotChat(dialogId) && userCounter > 2;\n\t}\n\n\tisCopilotMessage(messageId: number): boolean\n\t{\n\t\tconst message: ImModelMessage = this.store.getters['messages/getById'](messageId);\n\t\tif (!message)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.isCopilotBot(message.authorId))\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn message.componentId === MessageComponent.copilotCreation;\n\t}\n\n\tgetMessageRoleAvatar(messageId: number): ?string\n\t{\n\t\treturn this.store.getters['copilot/messages/getRole'](messageId)?.avatar?.medium;\n\t}\n\n\tgetNameWithRole({ dialogId, messageId }): string\n\t{\n\t\tconst user: ImModelUser = this.store.getters['users/get'](dialogId);\n\t\tconst roleName = this.store.getters['copilot/messages/getRole'](messageId).name;\n\n\t\treturn `${user.name} (${roleName})`;\n\t}\n\n\tgetAIModelName(dialogId: string): string\n\t{\n\t\tconst isAIModelChangeAllowed = FeatureManager.isFeatureAvailable(Feature.isAIModelChangeAllowed);\n\n\t\tif (isAIModelChangeAllowed)\n\t\t{\n\t\t\tconst currentAIModel = Core.getStore().getters['copilot/chats/getAIModel'](dialogId);\n\n\t\t\treturn currentAIModel.name;\n\t\t}\n\n\t\treturn Core.getStore().getters['copilot/getProvider'];\n\t}\n}\n"],"names":["CopilotManager","constructor","store","Core","getStore","handleRecentListResponse","copilotData","Promise","resolve","recommendedRoles","roles","chats","messages","all","dispatch","handleChatLoadResponse","aiProvider","handleRoleUpdate","handleMessageAdd","getRoleAvatarUrl","avatarDialogId","contextDialogId","isCopilotChatOrBot","getters","isCopilotBot","userId","isCopilotChat","dialogId","type","ChatType","copilot","isGroupCopilotChat","userCounter","isCopilotMessage","messageId","message","authorId","componentId","MessageComponent","copilotCreation","getMessageRoleAvatar","avatar","medium","getNameWithRole","user","roleName","name","getAIModelName","isAIModelChangeAllowed","FeatureManager","isFeatureAvailable","Feature","currentAIModel"],"mappings":";;;;;;;CAQO,MAAMA,cAAc,CAC3B;GAGCC,WAAW,GACX;KACC,IAAI,CAACC,KAAK,GAAGC,2BAAI,CAACC,QAAQ,EAAE;;GAG7B,MAAMC,wBAAwB,CAACC,WAAuB,EACtD;KACC,IAAI,CAACA,WAAW,EAChB;OACC,OAAOC,OAAO,CAACC,OAAO,EAAE;;KAGzB,MAAM;OAAEC,gBAAgB;OAAEC,KAAK;OAAEC,KAAK;OAAEC;MAAU,GAAGN,WAAW;KAChE,IAAI,CAACI,KAAK,EACV;OACC,OAAOH,OAAO,CAACC,OAAO,EAAE;;KAGzB,OAAOD,OAAO,CAACM,GAAG,CAAC,CAClB,IAAI,CAACX,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEH,KAAK,CAAC,EAC/C,IAAI,CAACT,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEJ,KAAK,CAAC,EAC/C,IAAI,CAACR,KAAK,CAACY,QAAQ,CAAC,6BAA6B,EAAEL,gBAAgB,CAAC,EACpE,IAAI,CAACP,KAAK,CAACY,QAAQ,CAAC,sBAAsB,EAAEF,QAAQ,CAAC,CACrD,CAAC;;GAGH,MAAMG,sBAAsB,CAACT,WAAuB,EACpD;KACC,IAAI,CAACA,WAAW,EAChB;OACC,OAAOC,OAAO,CAACC,OAAO,EAAE;;KAGzB,MAAM;OAAEQ,UAAU;OAAEL,KAAK;OAAED,KAAK;OAAEE;MAAU,GAAGN,WAAW;KAC1D,IAAI,CAACI,KAAK,EACV;OACC,OAAOH,OAAO,CAACC,OAAO,EAAE;;KAGzB,OAAOD,OAAO,CAACM,GAAG,CAAC,CAClB,IAAI,CAACX,KAAK,CAACY,QAAQ,CAAC,qBAAqB,EAAEE,UAAU,CAAC,EACtD,IAAI,CAACd,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEJ,KAAK,CAAC,EAC/C,IAAI,CAACR,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEH,KAAK,CAAC,EAC/C,IAAI,CAACT,KAAK,CAACY,QAAQ,CAAC,sBAAsB,EAAEF,QAAQ,CAAC,CACrD,CAAC;;GAGH,MAAMK,gBAAgB,CAACX,WAAuB,EAC9C;KACC,MAAM;OAAEK,KAAK;OAAED;MAAO,GAAGJ,WAAW;KACpC,IAAI,CAACI,KAAK,EACV;OACC,OAAOH,OAAO,CAACC,OAAO,EAAE;;KAGzB,OAAOD,OAAO,CAACM,GAAG,CAAC,CAClB,IAAI,CAACX,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEJ,KAAK,CAAC,EAC/C,IAAI,CAACR,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEH,KAAK,CAAC,CAC/C,CAAC;;GAGH,MAAMO,gBAAgB,CAACZ,WAAW,EAClC;KACC,MAAM;OAAEK,KAAK;OAAED,KAAK;OAAEE;MAAU,GAAGN,WAAW;KAC9C,IAAI,CAACI,KAAK,EACV;OACC,OAAOH,OAAO,CAACC,OAAO,EAAE;;KAGzB,OAAOD,OAAO,CAACM,GAAG,CAAC,CAClB,IAAI,CAACX,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEJ,KAAK,CAAC,EAC/C,IAAI,CAACR,KAAK,CAACY,QAAQ,CAAC,mBAAmB,EAAEH,KAAK,CAAC,EAC/C,IAAI,CAACT,KAAK,CAACY,QAAQ,CAAC,sBAAsB,EAAEF,QAAQ,CAAC,CACrD,CAAC;;GAGHO,gBAAgB,CAAC;KAAEC,cAAc;KAAEC;IAAsE,EACzG;KACC,IAAI,CAAC,IAAI,CAACC,kBAAkB,CAACF,cAAc,CAAC,EAC5C;OACC,OAAO,EAAE;;KAGV,OAAO,IAAI,CAAClB,KAAK,CAACqB,OAAO,CAAC,6BAA6B,CAAC,CAACF,eAAe,CAAC;;GAG1EG,YAAY,CAACC,MAAuB,EACpC;KACC,OAAO,IAAI,CAACvB,KAAK,CAACqB,OAAO,CAAC,sBAAsB,CAAC,CAACE,MAAM,CAAC;;GAG1DC,aAAa,CAACC,QAAgB,EAC9B;KAAA;KACC,OAAO,8BAAI,CAACzB,KAAK,CAACqB,OAAO,CAAC,WAAW,CAAC,CAACI,QAAQ,CAAC,qBAAzC,sBAA2CC,IAAI,MAAKC,oBAAQ,CAACC,OAAO;;GAG5ER,kBAAkB,CAACK,QAAgB,EACnC;KACC,OAAO,IAAI,CAACD,aAAa,CAACC,QAAQ,CAAC,IAAI,IAAI,CAACH,YAAY,CAACG,QAAQ,CAAC;;GAGnEI,kBAAkB,CAACJ,QAAgB,EACnC;KACC,MAAM;OAAEK;MAA0B,GAAG,IAAI,CAAC9B,KAAK,CAACqB,OAAO,CAAC,WAAW,CAAC,CAACI,QAAQ,CAAC;KAE9E,OAAO,IAAI,CAACD,aAAa,CAACC,QAAQ,CAAC,IAAIK,WAAW,GAAG,CAAC;;GAGvDC,gBAAgB,CAACC,SAAiB,EAClC;KACC,MAAMC,OAAuB,GAAG,IAAI,CAACjC,KAAK,CAACqB,OAAO,CAAC,kBAAkB,CAAC,CAACW,SAAS,CAAC;KACjF,IAAI,CAACC,OAAO,EACZ;OACC,OAAO,KAAK;;KAGb,IAAI,IAAI,CAACX,YAAY,CAACW,OAAO,CAACC,QAAQ,CAAC,EACvC;OACC,OAAO,IAAI;;KAGZ,OAAOD,OAAO,CAACE,WAAW,KAAKC,4BAAgB,CAACC,eAAe;;GAGhEC,oBAAoB,CAACN,SAAiB,EACtC;KAAA;KACC,iCAAO,IAAI,CAAChC,KAAK,CAACqB,OAAO,CAAC,0BAA0B,CAAC,CAACW,SAAS,CAAC,+CAAzD,uBAA2DO,MAAM,qBAAjE,uBAAmEC,MAAM;;GAGjFC,eAAe,CAAC;KAAEhB,QAAQ;KAAEO;IAAW,EACvC;KACC,MAAMU,IAAiB,GAAG,IAAI,CAAC1C,KAAK,CAACqB,OAAO,CAAC,WAAW,CAAC,CAACI,QAAQ,CAAC;KACnE,MAAMkB,QAAQ,GAAG,IAAI,CAAC3C,KAAK,CAACqB,OAAO,CAAC,0BAA0B,CAAC,CAACW,SAAS,CAAC,CAACY,IAAI;KAE/E,OAAQ,GAAEF,IAAI,CAACE,IAAK,KAAID,QAAS,GAAE;;GAGpCE,cAAc,CAACpB,QAAgB,EAC/B;KACC,MAAMqB,sBAAsB,GAAGC,gCAAc,CAACC,kBAAkB,CAACC,yBAAO,CAACH,sBAAsB,CAAC;KAEhG,IAAIA,sBAAsB,EAC1B;OACC,MAAMI,cAAc,GAAGjD,2BAAI,CAACC,QAAQ,EAAE,CAACmB,OAAO,CAAC,0BAA0B,CAAC,CAACI,QAAQ,CAAC;OAEpF,OAAOyB,cAAc,CAACN,IAAI;;KAG3B,OAAO3C,2BAAI,CAACC,QAAQ,EAAE,CAACmB,OAAO,CAAC,qBAAqB,CAAC;;CAEvD;;;;;;;;"}