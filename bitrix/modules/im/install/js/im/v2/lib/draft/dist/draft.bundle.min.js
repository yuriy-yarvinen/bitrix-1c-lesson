this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(t,e,s,r,a,i,n,o){"use strict";const c="bx-im-drafts";const h="recentDraft";const f="copilotDraft";class g{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){this.db=new n.Dexie(c);this.db.version(1).stores({drafts:""})}async migrateFromLocalStorage(){const t=await this.db.drafts.get("migration_status");if(t){return}const e=o.LocalStorageManager.getInstance().get(h,{});this.set(h,e);o.LocalStorageManager.getInstance().remove(h);const s=o.LocalStorageManager.getInstance().get(f,{});this.set(f,s);o.LocalStorageManager.getInstance().remove(f);this.setMigrationFinished()}set(t,e){this.db.drafts.put(e,t)}setMigrationFinished(){const t={[h]:true,[f]:true};this.db.drafts.put(t,"migration_status")}async get(t,e=null){await this.migrateFromLocalStorage();const s=await this.db.drafts.get(t);return s||e}}const l=1e3;const d=1500;const u="recentDraft";const m=new Set([i.ChatType.comment]);const D=new Set([i.ChatType.taskComments]);var T=babelHelpers.classPrivateFieldLooseKey("getChat");class p{static getInstance(){if(!p.instance){p.instance=new p}return p.instance}constructor(){Object.defineProperty(this,T,{value:b});this.inited=false;this.drafts={};s.EventEmitter.subscribe(i.EventType.layout.onLayoutChange,this.onLayoutChange.bind(this))}async initDraftHistory(){let t=null;try{t=await g.getInstance().get(u,{})}catch(t){console.error("DraftManager: error initing draft history",t);return}this.fillDraftsFromStorage(t);r.Logger.warn("DraftManager: initDrafts:",this.drafts);this.setRecentListDraftText();this.inited=true}fillDraftsFromStorage(t){if(!e.Type.isPlainObject(t)){return}Object.entries(t).forEach((([t,s])=>{if(!e.Type.isPlainObject(s)){return}this.drafts[t]=s}))}setDraftText(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].text=e.trim();this.refreshSaveTimeout()}setDraftPanel(t,e,s){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].panelType=e;this.drafts[t].panelContext=s;this.refreshSaveTimeout()}setDraftMentions(t,e){if(!this.drafts[t]){this.drafts[t]={}}this.drafts[t].mentions=e;this.refreshSaveTimeout()}async getDraft(t){var e;if(!this.inited){await this.initDraftHistory()}return(e=this.drafts[t])!=null?e:{}}clearDraft(t){delete this.drafts[t];this.setRecentItemDraftText(t,"")}setRecentListDraftText(){Object.entries(this.drafts).forEach((([t,e])=>{var s;this.setRecentItemDraftText(t,(s=e.text)!=null?s:"")}))}setRecentItemDraftText(t,e){if(!this.canSetRecentItemDraftText(t)){return}const{type:s}=babelHelpers.classPrivateFieldLooseBase(this,T)[T](t);void a.Core.getStore().dispatch("recent/setDraft",{id:t,text:e,addFakeItems:!D.has(s)})}onLayoutChange(t){const{from:e}=t.getData();const s=e.entityId;if(s===""){return}setTimeout((async()=>{const{text:t=""}=await this.getDraft(s);this.setRecentItemDraftText(s,t)}),d)}refreshSaveTimeout(){clearTimeout(this.writeToStorageTimeout);this.writeToStorageTimeout=setTimeout((()=>{this.saveToIndexedDb()}),l)}saveToIndexedDb(){g.getInstance().set(u,this.prepareDrafts())}prepareDrafts(){const t={};Object.entries(this.drafts).forEach((([e,s])=>{if(!s.text&&!s.panelType){return}if(s.panelType===i.TextareaPanelType.edit){return}t[e]={text:s.text,mentions:s.mentions}}));return t}canSetRecentItemDraftText(t){const e=babelHelpers.classPrivateFieldLooseBase(this,T)[T](t);if(!e){return false}return!m.has(e.type)}}function b(t){return a.Core.getStore().getters["chats/get"](t)}p.instance=null;t.DraftManager=p})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.DexieExport,BX.Messenger.v2.Lib);
//# sourceMappingURL=draft.bundle.map.js