this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,i,r,o,d,n,p,c){"use strict";var b=babelHelpers.classPrivateFieldLooseKey("store");class v extends n.Filter{constructor(...e){super(...e);Object.defineProperty(this,b,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,b)[b]=r.Core.getStore()}async apply(e){if(e.isVideo()&&!e.shouldTreatImageAsFile()&&d.DesktopApi.isMediaCompressorAvailable()){await this.setModelFileStatus(e.getId(),o.FileStatus.preparing);const s=d.DesktopApi.createMediaCompressor();const t=new Promise((t=>{e.subscribeOnce(n.FileEvent.REMOVE_COMPLETE,(()=>{s.cancel();s.removeCompressedFile();e.remove();t(null)}))}));const a=await Promise.race([s.compress(e.getBinary()),t]);if(a){e.setFile(a);e.setName(a.name);e.subscribeOnce(n.FileEvent.UPLOAD_COMPLETE,(()=>{s.removeCompressedFile()}))}}}setModelFileStatus(e,s){return babelHelpers.classPrivateFieldLooseBase(this,b)[b].dispatch("files/update",{id:e,fields:{status:s}})}}var F=babelHelpers.classPrivateFieldLooseKey("id");var u=babelHelpers.classPrivateFieldLooseKey("uploader");var h=babelHelpers.classPrivateFieldLooseKey("customData");class g extends i.EventEmitter{constructor({uploaderId:e,uploaderOptions:s,events:t,customData:a}){super();Object.defineProperty(this,F,{writable:true,value:void 0});Object.defineProperty(this,u,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:{}});this.setEventNamespace(g.EVENT_NAMESPACE);this.subscribeFromOptions(t);babelHelpers.classPrivateFieldLooseBase(this,F)[F]=e;babelHelpers.classPrivateFieldLooseBase(this,u)[u]=new n.Uploader({controller:g.CONTROLLER,multiple:true,imageResizeWidth:1280,imageResizeHeight:1280,imageResizeMode:"contain",imageResizeMimeType:"image/jpeg",imageResizeMimeTypeMode:"force",imagePreviewHeight:720,imagePreviewWidth:720,treatOversizeImageAsFile:true,ignoreUnknownImageTypes:true,maxFileSize:null,imageResizeFilter:e=>!e.getCustomData("sendAsFile")&&!e.isAnimated(),...s,events:{[n.UploaderEvent.FILE_ADD_START]:s=>{this.emit(g.Event.onFileAddStart,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_ADD]:s=>{this.emit(g.Event.onFileAdd,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_LOAD_COMPLETE]:s=>{this.emit(g.Event.onFileLoadComplete,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_STATE_CHANGE]:s=>{this.emit(g.Event.onFileStateChange,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_STATUS_CHANGE]:s=>{this.emit(g.Event.onFileStatusChange,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_UPLOAD_START]:s=>{this.emit(g.Event.onFileUploadStart,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_UPLOAD_PROGRESS]:s=>{this.emit(g.Event.onFileUploadProgress,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_UPLOAD_COMPLETE]:s=>{this.emit(g.Event.onFileUploadComplete,{...s.getData(),uploaderId:e})},[n.UploaderEvent.ERROR]:s=>{this.emit(g.Event.onFileUploadError,{...s.getData(),uploaderId:e})},[n.UploaderEvent.FILE_ERROR]:s=>{this.emit(g.Event.onFileUploadError,{...s.getData(),uploaderId:e})},[n.UploaderEvent.MAX_FILE_COUNT_EXCEEDED]:s=>{this.emit(g.Event.onMaxFileCountExceeded,{...s.getData(),uploaderId:e})},[n.UploaderEvent.UPLOAD_COMPLETE]:s=>{this.emit(g.Event.onUploadComplete,{...s.getData(),uploaderId:e})}},filters:[{type:n.FilterType.PREPARATION,filter:v}]});if(c.Type.isPlainObject(a)){babelHelpers.classPrivateFieldLooseBase(this,h)[h]=a}}getId(){return babelHelpers.classPrivateFieldLooseBase(this,F)[F]}setCustomData(e,s){babelHelpers.classPrivateFieldLooseBase(this,h)[h][e]=s}getCustomData(e){return babelHelpers.classPrivateFieldLooseBase(this,h)[h][e]}addFiles(e){const s=e.map((e=>Object.values(e)));return babelHelpers.classPrivateFieldLooseBase(this,u)[u].addFiles(s)}removeFile(e){var s;(s=babelHelpers.classPrivateFieldLooseBase(this,u)[u].getFile(e))==null?void 0:s.remove==null?void 0:s.remove()}getFiles(){return babelHelpers.classPrivateFieldLooseBase(this,u)[u].getFiles()}getFilesIds(){return this.getFiles().map((e=>e.getId()))}isAllPending(){return this.getFiles().every((e=>e.getStatus()===n.FileStatus.PENDING))}isAllCompleted(){return this.getFiles().every((e=>e.getStatus()===n.FileStatus.COMPLETE))}getServerFilesIds(){return this.getFiles().map((e=>e.getServerFileId().toString().slice(1)))}getBinaryFiles(){return this.getFiles().map((e=>e.getBinary()))}start(){babelHelpers.classPrivateFieldLooseBase(this,u)[u].setAutoUpload(true);babelHelpers.classPrivateFieldLooseBase(this,u)[u].start()}stop(){babelHelpers.classPrivateFieldLooseBase(this,u)[u].stop()}destroy(){babelHelpers.classPrivateFieldLooseBase(this,u)[u].destroy({removeFilesFromServer:false})}}g.EVENT_NAMESPACE="BX.Messenger.v2.Service.Uploading.UploaderWrapper";g.CONTROLLER="disk.uf.integration.diskUploaderController";g.Event={onFileAddStart:"onFileAddStart",onFileAdd:"onFileAdd",onFileLoadComplete:"onFileLoadComplete",onFileStateChange:"onFileStateChange",onFileStatusChange:"onFileStatusChange",onFileUploadStart:"onFileUploadStart",onFileUploadProgress:"onFileUploadProgress",onFileUploadComplete:"onFileUploadComplete",onFileUploadError:"onFileUploadError",onFileUploadCancel:"onFileUploadCancel",onMaxFileCountExceeded:"onMaxFileCountExceeded",onUploadComplete:"onUploadComplete"};function P(){let e;let s;const t=new Promise(((t,a)=>{e=t;s=a}));return{promise:t,resolve:e,reject:s}}const m="BX.Messenger.v2.Service.UploadingService";var L=babelHelpers.classPrivateFieldLooseKey("store");var f=babelHelpers.classPrivateFieldLooseKey("restClient");var H=babelHelpers.classPrivateFieldLooseKey("isRequestingDiskFolderId");var I=babelHelpers.classPrivateFieldLooseKey("diskFolderIdRequestPromise");var B=babelHelpers.classPrivateFieldLooseKey("uploaderWrappers");var y=babelHelpers.classPrivateFieldLooseKey("sendingService");var E=babelHelpers.classPrivateFieldLooseKey("queue");var C=babelHelpers.classPrivateFieldLooseKey("isUploading");var U=babelHelpers.classPrivateFieldLooseKey("createUploader");var S=babelHelpers.classPrivateFieldLooseKey("addToQueue");var D=babelHelpers.classPrivateFieldLooseKey("processQueue");var M=babelHelpers.classPrivateFieldLooseKey("addFileFromDiskToModel");var O=babelHelpers.classPrivateFieldLooseKey("isMediaFile");var A=babelHelpers.classPrivateFieldLooseKey("setFileMapping");var w=babelHelpers.classPrivateFieldLooseKey("requestDiskFolderId");var T=babelHelpers.classPrivateFieldLooseKey("uploadPreview");var j=babelHelpers.classPrivateFieldLooseKey("updateFileProgress");var x=babelHelpers.classPrivateFieldLooseKey("cancelUpload");var K=babelHelpers.classPrivateFieldLooseKey("getFileType");var _=babelHelpers.classPrivateFieldLooseKey("addFileToStore");var R=babelHelpers.classPrivateFieldLooseKey("updateFilePreviewInStore");var k=babelHelpers.classPrivateFieldLooseKey("updateFileTypeInStore");var N=babelHelpers.classPrivateFieldLooseKey("updateFileSizeInStore");var X=babelHelpers.classPrivateFieldLooseKey("getDiskFolderId");var z=babelHelpers.classPrivateFieldLooseKey("getDialog");var W=babelHelpers.classPrivateFieldLooseKey("getCurrentUser");var V=babelHelpers.classPrivateFieldLooseKey("getChatId");var G=babelHelpers.classPrivateFieldLooseKey("setMessagesText");var q=babelHelpers.classPrivateFieldLooseKey("createMessageFromFiles");var $=babelHelpers.classPrivateFieldLooseKey("tryToSendMessage");var Q=babelHelpers.classPrivateFieldLooseKey("prepareFileFromDisk");var Y=babelHelpers.classPrivateFieldLooseKey("isMaxFileSizeExceeded");var J=babelHelpers.classPrivateFieldLooseKey("setMessageError");var Z=babelHelpers.classPrivateFieldLooseKey("destroyUploader");class ee extends i.EventEmitter{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){super();Object.defineProperty(this,Z,{value:Ee});Object.defineProperty(this,J,{value:ye});Object.defineProperty(this,Y,{value:Be});Object.defineProperty(this,Q,{value:Ie});Object.defineProperty(this,$,{value:He});Object.defineProperty(this,q,{value:fe});Object.defineProperty(this,G,{value:Le});Object.defineProperty(this,V,{value:me});Object.defineProperty(this,W,{value:Pe});Object.defineProperty(this,z,{value:ge});Object.defineProperty(this,X,{value:he});Object.defineProperty(this,N,{value:ue});Object.defineProperty(this,k,{value:Fe});Object.defineProperty(this,R,{value:ve});Object.defineProperty(this,_,{value:be});Object.defineProperty(this,K,{value:ce});Object.defineProperty(this,x,{value:pe});Object.defineProperty(this,j,{value:ne});Object.defineProperty(this,T,{value:de});Object.defineProperty(this,w,{value:oe});Object.defineProperty(this,A,{value:re});Object.defineProperty(this,O,{value:ie});Object.defineProperty(this,M,{value:le});Object.defineProperty(this,D,{value:ae});Object.defineProperty(this,S,{value:te});Object.defineProperty(this,U,{value:se});Object.defineProperty(this,L,{writable:true,value:void 0});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,H,{writable:true,value:false});Object.defineProperty(this,I,{writable:true,value:{}});Object.defineProperty(this,B,{writable:true,value:new Map});Object.defineProperty(this,y,{writable:true,value:void 0});Object.defineProperty(this,E,{writable:true,value:[]});Object.defineProperty(this,C,{writable:true,value:false});this.setEventNamespace(m);babelHelpers.classPrivateFieldLooseBase(this,L)[L]=r.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,f)[f]=r.Core.getRestClient();babelHelpers.classPrivateFieldLooseBase(this,y)[y]=l.SendingService.getInstance()}prepareFilesOptions(e,s,t){return e.map((e=>{const a=p.Utils.text.getUuidV4();if(c.Type.isFunction(e.getBinary)){return{file:e.getBinary(),options:{...e.toJSON(),clientPreview:e.getClientPreview(),id:a,customData:{...s},treatImageAsFile:t}}}return{file:e,options:{id:a,customData:{...s},downloadUrl:URL.createObjectURL(e)}}}))}async addFiles(e){const{files:s,dialogId:t,autoUpload:a,sendAsFile:l=false,maxParallelUploads:i,maxParallelLoads:r}=e;const{uploaderWrapper:o,loadAllComplete:d,uploadAllComplete:n}=await babelHelpers.classPrivateFieldLooseBase(this,U)[U]({dialogId:t,autoUpload:a,sendAsFile:l,maxParallelUploads:i,maxParallelLoads:r});const p=o.getId();const c=babelHelpers.classPrivateFieldLooseBase(this,V)[V](t);babelHelpers.classPrivateFieldLooseBase(this,B)[B].set(p,o);const b=this.prepareFilesOptions(s,{chatId:c,dialogId:t},l);const v=o.addFiles(b);return{uploaderFiles:v,uploaderId:p,loadAllComplete:d,uploadAllComplete:n}}getFiles(e){return babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).getFiles()}start(e){this.getFiles(e).forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,j)[j](e.getId(),0,o.FileStatus.progress)}));babelHelpers.classPrivateFieldLooseBase(this,S)[S](e)}stop(e){babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).stop()}uploadFileFromDisk(e,s){Object.values(e).forEach((e=>{const t=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e,s);babelHelpers.classPrivateFieldLooseBase(this,M)[M](t).then((()=>{const e={tempMessageId:t.tempMessageId,fileIds:[t.tempFileId],dialogId:t.dialogId};return babelHelpers.classPrivateFieldLooseBase(this,y)[y].sendMessageWithFiles(e)})).then((()=>{this.commitFile({chatId:t.chatId,temporaryFileId:t.tempFileId,tempMessageId:t.tempMessageId,realFileId:t.file.id.slice(1),fromDisk:true})})).catch((e=>{console.error("SendingService: sendFilesFromDisk error:",e)}))}))}checkDiskFolderId(e){if(babelHelpers.classPrivateFieldLooseBase(this,X)[X](e)>0){return Promise.resolve(babelHelpers.classPrivateFieldLooseBase(this,X)[X](e))}if(babelHelpers.classPrivateFieldLooseBase(this,H)[H]){return babelHelpers.classPrivateFieldLooseBase(this,I)[I][e]}babelHelpers.classPrivateFieldLooseBase(this,I)[I][e]=babelHelpers.classPrivateFieldLooseBase(this,w)[w](e);return babelHelpers.classPrivateFieldLooseBase(this,I)[I][e]}commitFile(e){const{temporaryFileId:s,tempMessageId:t,chatId:a,realFileId:l,fromDisk:i,messageText:r="",sendAsFile:d=false}=e;const n={};if(i){n.disk_id=l}else{n.upload_id=l.toString().slice(1)}babelHelpers.classPrivateFieldLooseBase(this,f)[f].callMethod(o.RestMethod.imDiskFileCommit,{chat_id:a,message:r,template_id:t,file_template_id:s,as_file:d?"Y":"N",...n}).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,J)[J](t);babelHelpers.classPrivateFieldLooseBase(this,j)[j](s,0,o.FileStatus.error);console.error("commitFile error",e)}))}commitMessage(e){const s=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e);const t=s.getCustomData("chatId");const a=s.getCustomData("sendAsFile");const l=s.getCustomData("text");const i=s.getCustomData("tempMessageId");const r=s.getServerFilesIds();return babelHelpers.classPrivateFieldLooseBase(this,f)[f].callMethod(o.RestMethod.imDiskFileCommit,{chat_id:t,message:l,template_id:i,as_file:a?"Y":"N",upload_id:r})}sendMessageWithFiles(e){const{uploaderId:s,text:t}=e;babelHelpers.classPrivateFieldLooseBase(this,G)[G](s,t);babelHelpers.classPrivateFieldLooseBase(this,$)[$](s)}getUploaderIdByFileId(e){const s=[...babelHelpers.classPrivateFieldLooseBase(this,B)[B].keys()];return s.find((s=>this.getFiles(s).some((s=>s.getId()===e))))}removeFileFromUploader(e){const{uploaderId:s,filesIds:t,restartUploading:a=false}=e;const l=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(s).getFiles().filter((e=>t.includes(e.getId())));l.forEach((e=>{e.remove();e.abort()}));if(a){const[e]=this.getFiles(s);if(e){e.upload()}else{babelHelpers.classPrivateFieldLooseBase(this,C)[C]=false;babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}}}async retry(e){const s=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e);const t=s.getCustomData("dialogId");const a=s.getCustomData("text");const l=s.getCustomData("tempMessageId");const i=s.getBinaryFiles();const{uploaderId:r,loadAllComplete:o}=await this.addFiles({dialogId:t,files:i});void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/deleteLoadingMessageByMessageId",{messageId:l});await o;this.sendMessageWithFiles({uploaderId:r,text:a});babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](e)}}async function se(e){const{dialogId:s,autoUpload:l=false,sendAsFile:i=false,maxParallelUploads:r,maxParallelLoads:d}=e;const c=p.Utils.text.getUuidV4();const b=babelHelpers.classPrivateFieldLooseBase(this,V)[V](s);const v=await this.checkDiskFolderId(s);const F=p.Utils.text.getUuidV4();const u=P();const h=P();const m=[];const L=new g({uploaderId:c,uploaderOptions:{autoUpload:l,maxParallelLoads:d,maxParallelUploads:r,controllerOptions:{folderId:v,chat:{chatId:b,dialogId:s}}},customData:{chatId:b,dialogId:s,tempMessageId:F,sendAsFile:i},events:{[g.Event.onFileAddStart]:e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,_)[_](s,i)},[g.Event.onFileStatusChange]:e=>{const{file:s}=e.getData();if(s.getStatus()===n.FileStatus.PENDING){if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](s)){babelHelpers.classPrivateFieldLooseBase(this,R)[R](s,i)}else{babelHelpers.classPrivateFieldLooseBase(this,R)[R](s,i);babelHelpers.classPrivateFieldLooseBase(this,k)[k](s,o.FileType.file);s.setTreatImageAsFile(true);s.setCustomData("sendAsFile",true)}const t=e.getTarget();if(t.isAllPending()){u.resolve()}}},[g.Event.onFileUploadStart]:e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,N)[N](s);this.emit(ee.event.uploadStart)},[g.Event.onFileUploadProgress]:e=>{const{file:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,j)[j](s.getId(),s.getProgress(),o.FileStatus.upload)},[g.Event.onFileUploadComplete]:async e=>{const{file:s}=e.getData();const t=s.getServerFileId().toString().slice(1);const a=s.getId();if(babelHelpers.classPrivateFieldLooseBase(this,O)[O](s)){babelHelpers.classPrivateFieldLooseBase(this,A)[A]({serverFileId:t,temporaryFileId:a})}babelHelpers.classPrivateFieldLooseBase(this,j)[j](a,s.getProgress(),o.FileStatus.wait);m.push(babelHelpers.classPrivateFieldLooseBase(this,T)[T](s));this.emit(ee.event.uploadComplete)},[g.Event.onFileUploadError]:e=>{const{error:s}=e.getData();const l=e.getTarget();babelHelpers.classPrivateFieldLooseBase(this,J)[J](l.getCustomData("tempMessageId"));l.getFiles().forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,j)[j](e.getId(),0,o.FileStatus.error)}));if(babelHelpers.classPrivateFieldLooseBase(this,Y)[Y](s)){a.Notifier.file.handleUploadError(s)}t.Logger.error("UploadingService: upload error",s);this.emit(ee.event.uploadError);babelHelpers.classPrivateFieldLooseBase(this,C)[C]=false;babelHelpers.classPrivateFieldLooseBase(this,D)[D]();this.stop(c)},[g.Event.onFileUploadCancel]:e=>{const{tempFileId:s}=e.getData();babelHelpers.classPrivateFieldLooseBase(this,x)[x](F,s);this.emit(ee.event.uploadCancel)},[g.Event.onUploadComplete]:async e=>{babelHelpers.classPrivateFieldLooseBase(this,C)[C]=false;babelHelpers.classPrivateFieldLooseBase(this,D)[D]();const s=e.getTarget();if(s.isAllCompleted()){await Promise.all(m);h.resolve();await this.commitMessage(c);babelHelpers.classPrivateFieldLooseBase(this,Z)[Z](c)}}}});return{uploaderWrapper:L,loadAllComplete:u.promise,uploadAllComplete:h.promise}}function te(e){babelHelpers.classPrivateFieldLooseBase(this,E)[E].push(e);babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}function ae(){if(babelHelpers.classPrivateFieldLooseBase(this,C)[C]||babelHelpers.classPrivateFieldLooseBase(this,E)[E].length===0){return}babelHelpers.classPrivateFieldLooseBase(this,C)[C]=true;const e=babelHelpers.classPrivateFieldLooseBase(this,E)[E].shift();babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).start()}function le(e){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/add",{id:e.tempFileId,chatId:e.chatId,authorId:r.Core.getUserId(),name:e.file.name,type:p.Utils.file.getFileTypeByExtension(e.file.ext),extension:e.file.ext,size:e.file.sizeInt,status:o.FileStatus.wait,progress:0,authorName:babelHelpers.classPrivateFieldLooseBase(this,W)[W]().name})}function ie(e){return n.isResizableImage(e.getBinary())||e.isVideo()&&c.Type.isStringFilled(e.getPreviewUrl())}function re(e){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/setTemporaryFileMapping",e)}function oe(e){return new Promise(((s,t)=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H]=true;const a=babelHelpers.classPrivateFieldLooseBase(this,V)[V](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f].callMethod(o.RestMethod.imDiskFolderGet,{chat_id:a}).then((t=>{const{ID:a}=t.data();babelHelpers.classPrivateFieldLooseBase(this,H)[H]=false;void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("chats/update",{dialogId:e,fields:{diskFolderId:a}});s(a)})).catch((e=>{babelHelpers.classPrivateFieldLooseBase(this,H)[H]=false;t(e)}))}))}async function de(e){const t=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)===o.FileType.video||e.isAnimated();if(!t){return Promise.resolve()}const a=e.getServerFileId().toString().slice(1);const l=e.getClientPreview();if(!l){e.setCustomData("sendAsFile",true);return Promise.resolve()}const i=new FormData;i.append("id",a);i.append("previewFile",l,`preview_${e.getName()}.jpg`);return s.runAction(o.RestMethod.imDiskFilePreviewUpload,{data:i}).catch((([e])=>{console.error("imDiskFilePreviewUpload request error",e)}))}function ne(e,s,t){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/update",{id:e,fields:{progress:s===100?99:s,status:t}})}function pe(e,s){const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L].getters["messages/getById"](e);if(t){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/delete",{id:e});void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/delete",{id:s});const a=babelHelpers.classPrivateFieldLooseBase(this,L)[L].getters["chats/getByChatId"](t.chatId);const l=babelHelpers.classPrivateFieldLooseBase(this,L)[L].getters["messages/findLastChatMessageId"](t.chatId);if(c.Type.isString(l)||c.Type.isNumber(l)){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("recent/update",{id:a.dialogId,fields:{messageId:l}})}else{void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("recent/delete",{id:a.dialogId})}}}function ce(e){if(n.isResizableImage(e.getBinary())){return o.FileType.image}if(e.isVideo()){return o.FileType.video}if(e.getType().startsWith("audio")){return o.FileType.audio}return o.FileType.file}function be(e,s){const t=babelHelpers.classPrivateFieldLooseBase(this,K)[K](e);const a=babelHelpers.classPrivateFieldLooseBase(this,W)[W]();const l=![o.FileType.image,o.FileType.video].includes(t);void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/add",{id:e.getId(),name:e.getName(),size:e.getSize(),type:t,extension:e.getExtension(),chatId:e.getCustomData("chatId"),authorId:a.id,authorName:a.name,status:e.isFailed()?o.FileStatus.error:o.FileStatus.wait,progress:0,urlDownload:e.getDownloadUrl(),...(()=>{if(l||s){return{image:false}}return{}})()})}function ve(e,s){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/update",{id:e.getId(),fields:{urlPreview:(()=>{if(e.isImage()){return e.getPreviewUrl()||e.getDownloadUrl()}return e.getPreviewUrl()})(),...(()=>{if(s){return{image:false}}return{image:{width:e.getPreviewWidth(),height:e.getPreviewHeight()}}})()}})}function Fe(e,s){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/update",{id:e.getId(),fields:{type:s}})}function ue(e){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("files/update",{id:e.getId(),fields:{size:e.getSize()}})}function he(e){return babelHelpers.classPrivateFieldLooseBase(this,z)[z](e).diskFolderId}function ge(e){return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getters["chats/get"](e)}function Pe(){const e=r.Core.getUserId();return babelHelpers.classPrivateFieldLooseBase(this,L)[L].getters["users/get"](e)}function me(e){var s;return(s=babelHelpers.classPrivateFieldLooseBase(this,z)[z](e))==null?void 0:s.chatId}function Le(e,s){babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).setCustomData("text",s)}function fe(e){const s=[];const t=this.getFiles(e);t.forEach((e=>{if(!e.getError()){s.push(e.getId())}}));const a=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).getCustomData("text");const l=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).getCustomData("dialogId");const i=babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).getCustomData("tempMessageId");return{fileIds:s,tempMessageId:i,dialogId:l,text:a}}function He(e){const s=babelHelpers.classPrivateFieldLooseBase(this,q)[q](e);void babelHelpers.classPrivateFieldLooseBase(this,y)[y].sendMessageWithFiles(s);this.start(e)}function Ie(e,s){const t=p.Utils.text.getUuidV4();const a=e.id.slice(1);const l=`${t}|${a}`;return{tempMessageId:t,tempFileId:l,dialogId:s,file:e,chatId:babelHelpers.classPrivateFieldLooseBase(this,z)[z](s).chatId}}function Be(e){return e.getCode()==="MAX_FILE_SIZE_EXCEEDED"}function ye(e){void babelHelpers.classPrivateFieldLooseBase(this,L)[L].dispatch("messages/update",{id:e,fields:{error:true}})}function Ee(e){babelHelpers.classPrivateFieldLooseBase(this,B)[B].get(e).destroy();babelHelpers.classPrivateFieldLooseBase(this,B)[B].delete(e)}ee.event={uploadStart:"uploadStart",uploadComplete:"uploadComplete",uploadError:"uploadError",uploadCancel:"uploadCancel"};ee.instance=null;const Ce=10;const Ue=100;const Se=10;const De=3;var Me=babelHelpers.classPrivateFieldLooseKey("getUploadingService");var Oe=babelHelpers.classPrivateFieldLooseKey("createUploadingId");var Ae=babelHelpers.classPrivateFieldLooseKey("addFiles");class we{constructor(){Object.defineProperty(this,Ae,{value:xe});Object.defineProperty(this,Oe,{value:je});Object.defineProperty(this,Me,{value:Te})}static makeChunks(e){const{files:s,chunkSize:t=Ce,maxFilesCount:a=Ue}=e;const l=[];if(c.Type.isArray(s)){const e=s.slice(0,a);for(let s=0;s<e.length;s+=t){const a=e.slice(s,s+t);l.push(a)}}return l}static getMaxParallelLoads(e){return Math.floor(Se/e.length)}async upload({files:e,dialogId:s,autoUpload:t,sendAsFile:a}){const l=we.makeChunks({files:e});const i=await Promise.all(l.map((e=>babelHelpers.classPrivateFieldLooseBase(this,Ae)[Ae]({files:e,maxParallelLoads:we.getMaxParallelLoads(l),maxParallelUploads:De,dialogId:s,autoUpload:t,sendAsFile:a}))));const r=babelHelpers.classPrivateFieldLooseBase(this,Oe)[Oe]();const o=[];const d=[];const n=[];i.forEach((({uploaderId:e,uploaderFiles:s,loadAllComplete:t,uploadAllComplete:a})=>{if(c.Type.isArrayFilled(s)){o.push(e);d.push(t);n.push(a)}}));const p=Promise.all(d);const b=Promise.all(n);const v=e.length;return{uploadingId:r,uploaderIds:o,sourceFilesCount:v,loadAllComplete:p,uploadAllComplete:b}}}function Te(){return ee.getInstance()}function je(){return p.Utils.text.getUuidV4()}async function xe(e){return babelHelpers.classPrivateFieldLooseBase(this,Me)[Me]().addFiles(e)}e.UploadingService=ee;e.MultiUploadingService=we})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Event,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.UI.Uploader,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=uploading.bundle.map.js