{"version":3,"file":"uploading.bundle.js","sources":["../src/classes/video-compression-filter.js","../src/classes/uploader-wrapper.js","../src/utils/deferred-promise.js","../src/uploading.js","../src/multi-uploading.js"],"sourcesContent":["import { Core } from 'im.v2.application.core';\nimport { FileStatus } from 'im.v2.const';\nimport { DesktopApi } from 'im.v2.lib.desktop-api';\nimport { type UploaderFile, Filter, FileEvent } from 'ui.uploader.core';\n\nimport type { Store } from 'ui.vue3.vuex';\n\nexport class UploaderVideoCompressionFilter extends Filter\n{\n\t#store: Store = null;\n\n\tconstructor(...args)\n\t{\n\t\tsuper(...args);\n\t\tthis.#store = Core.getStore();\n\t}\n\n\tasync apply(file: UploaderFile): Promise<void>\n\t{\n\t\tif (\n\t\t\tfile.isVideo()\n\t\t\t&& !file.shouldTreatImageAsFile()\n\t\t\t&& DesktopApi.isMediaCompressorAvailable()\n\t\t)\n\t\t{\n\t\t\tawait this.setModelFileStatus(file.getId(), FileStatus.preparing);\n\t\t\tconst compressor = DesktopApi.createMediaCompressor();\n\n\t\t\tconst cancelPromise: Promise<null> = new Promise((resolve) => {\n\t\t\t\tfile.subscribeOnce(FileEvent.REMOVE_COMPLETE, () => {\n\t\t\t\t\tcompressor.cancel();\n\t\t\t\t\tcompressor.removeCompressedFile();\n\t\t\t\t\tfile.remove();\n\t\t\t\t\tresolve(null);\n\t\t\t\t});\n\t\t\t});\n\n\t\t\tconst compressedFile: ?File = await Promise.race([\n\t\t\t\tcompressor.compress(file.getBinary()),\n\t\t\t\tcancelPromise,\n\t\t\t]);\n\n\t\t\tif (compressedFile)\n\t\t\t{\n\t\t\t\tfile.setFile(compressedFile);\n\t\t\t\tfile.setName(compressedFile.name);\n\t\t\t\tfile.subscribeOnce(FileEvent.UPLOAD_COMPLETE, () => {\n\t\t\t\t\tcompressor.removeCompressedFile();\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\tsetModelFileStatus(id: string, status: $Values<FileStatus>): Promise<any>\n\t{\n\t\treturn this.#store.dispatch('files/update', {\n\t\t\tid,\n\t\t\tfields: { status },\n\t\t});\n\t}\n}\n","import { Type } from 'main.core';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\nimport {\n\tUploader,\n\tUploaderEvent,\n\tFilterType,\n\ttype UploaderFile,\n\ttype UploaderFileOptions,\n\tFileStatus as UploaderFileStatus,\n} from 'ui.uploader.core';\n\nimport { UploaderVideoCompressionFilter } from './video-compression-filter';\n\nimport type { UploaderWrapperFileOptions, UploaderWrapperOptions } from './types/uploader-wrapper';\n\nexport class UploaderWrapper extends EventEmitter\n{\n\tstatic EVENT_NAMESPACE = 'BX.Messenger.v2.Service.Uploading.UploaderWrapper';\n\tstatic CONTROLLER = 'disk.uf.integration.diskUploaderController';\n\tstatic Event = {\n\t\tonFileAddStart: 'onFileAddStart',\n\t\tonFileAdd: 'onFileAdd',\n\t\tonFileLoadComplete: 'onFileLoadComplete',\n\t\tonFileStateChange: 'onFileStateChange',\n\t\tonFileStatusChange: 'onFileStatusChange',\n\t\tonFileUploadStart: 'onFileUploadStart',\n\t\tonFileUploadProgress: 'onFileUploadProgress',\n\t\tonFileUploadComplete: 'onFileUploadComplete',\n\t\tonFileUploadError: 'onFileUploadError',\n\t\tonFileUploadCancel: 'onFileUploadCancel',\n\t\tonMaxFileCountExceeded: 'onMaxFileCountExceeded',\n\t\tonUploadComplete: 'onUploadComplete',\n\t};\n\n\t#id: string;\n\t#uploader: Uploader;\n\t#customData: { [key: string]: any } = {};\n\n\tconstructor({ uploaderId, uploaderOptions, events, customData }: UploaderWrapperOptions)\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(UploaderWrapper.EVENT_NAMESPACE);\n\t\tthis.subscribeFromOptions(events);\n\n\t\tthis.#id = uploaderId;\n\t\tthis.#uploader = new Uploader({\n\t\t\tcontroller: UploaderWrapper.CONTROLLER,\n\t\t\tmultiple: true,\n\t\t\timageResizeWidth: 1280,\n\t\t\timageResizeHeight: 1280,\n\t\t\timageResizeMode: 'contain',\n\t\t\timageResizeMimeType: 'image/jpeg',\n\t\t\timageResizeMimeTypeMode: 'force',\n\t\t\timagePreviewHeight: 720,\n\t\t\timagePreviewWidth: 720,\n\t\t\ttreatOversizeImageAsFile: true,\n\t\t\tignoreUnknownImageTypes: true,\n\t\t\tmaxFileSize: null,\n\t\t\timageResizeFilter: (file: UploaderFile) => {\n\t\t\t\treturn !file.getCustomData('sendAsFile') && !file.isAnimated();\n\t\t\t},\n\t\t\t...uploaderOptions,\n\t\t\tevents: {\n\t\t\t\t[UploaderEvent.FILE_ADD_START]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileAddStart, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_ADD]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileAdd, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_LOAD_COMPLETE]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileLoadComplete, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_STATE_CHANGE]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileStateChange, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_STATUS_CHANGE]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileStatusChange, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_UPLOAD_START]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileUploadStart, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_UPLOAD_PROGRESS]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileUploadProgress, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_UPLOAD_COMPLETE]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileUploadComplete, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.ERROR]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileUploadError, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.FILE_ERROR]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onFileUploadError, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.MAX_FILE_COUNT_EXCEEDED]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onMaxFileCountExceeded, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t\t[UploaderEvent.UPLOAD_COMPLETE]: (event: BaseEvent) => {\n\t\t\t\t\tthis.emit(UploaderWrapper.Event.onUploadComplete, { ...event.getData(), uploaderId });\n\t\t\t\t},\n\t\t\t},\n\t\t\tfilters: [\n\t\t\t\t{\n\t\t\t\t\ttype: FilterType.PREPARATION,\n\t\t\t\t\tfilter: UploaderVideoCompressionFilter,\n\t\t\t\t},\n\t\t\t],\n\t\t});\n\n\t\tif (Type.isPlainObject(customData))\n\t\t{\n\t\t\tthis.#customData = customData;\n\t\t}\n\t}\n\n\tgetId(): string\n\t{\n\t\treturn this.#id;\n\t}\n\n\tsetCustomData(key, value)\n\t{\n\t\tthis.#customData[key] = value;\n\t}\n\n\tgetCustomData(key: string): any\n\t{\n\t\treturn this.#customData[key];\n\t}\n\n\taddFiles(filesOptions: Array<UploaderWrapperFileOptions>): Array<UploaderFile>\n\t{\n\t\tconst filesEntries: Array<Array<File | Blob, UploaderFileOptions>> = filesOptions.map((fileOption) => {\n\t\t\treturn Object.values(fileOption);\n\t\t});\n\n\t\treturn this.#uploader.addFiles(filesEntries);\n\t}\n\n\tremoveFile(fileId: string)\n\t{\n\t\tthis.#uploader.getFile(fileId)?.remove?.();\n\t}\n\n\tgetFiles(): Array<UploaderFile>\n\t{\n\t\treturn this.#uploader.getFiles();\n\t}\n\n\tgetFilesIds(): Array<string>\n\t{\n\t\treturn this.getFiles().map((file: UploaderFile) => {\n\t\t\treturn file.getId();\n\t\t});\n\t}\n\n\tisAllPending(): boolean\n\t{\n\t\treturn this.getFiles().every((currentFile: UploaderFile) => {\n\t\t\treturn currentFile.getStatus() === UploaderFileStatus.PENDING;\n\t\t});\n\t}\n\n\tisAllCompleted(): boolean\n\t{\n\t\treturn this.getFiles().every((currentFile: UploaderFile) => {\n\t\t\treturn currentFile.getStatus() === UploaderFileStatus.COMPLETE;\n\t\t});\n\t}\n\n\tgetServerFilesIds(): Array<string>\n\t{\n\t\treturn this.getFiles().map((file: UploaderFile) => {\n\t\t\treturn file.getServerFileId().toString().slice(1);\n\t\t});\n\t}\n\n\tgetBinaryFiles(): Array<File>\n\t{\n\t\treturn this.getFiles().map((file: UploaderFile) => {\n\t\t\treturn file.getBinary();\n\t\t});\n\t}\n\n\tstart()\n\t{\n\t\tthis.#uploader.setAutoUpload(true);\n\t\tthis.#uploader.start();\n\t}\n\n\tstop()\n\t{\n\t\tthis.#uploader.stop();\n\t}\n\n\tdestroy()\n\t{\n\t\tthis.#uploader.destroy({ removeFilesFromServer: false });\n\t}\n}\n","export function createDeferredPromise(): { promise: Promise<any>, resolve: () => void, reject: () => void }\n{\n\tlet resolve;\n\tlet reject;\n\tconst promise = new Promise((resolveRef, rejectRef) => {\n\t\tresolve = resolveRef;\n\t\treject = rejectRef;\n\t});\n\n\treturn {\n\t\tpromise,\n\t\tresolve,\n\t\treject,\n\t};\n}\n","import { Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { FileStatus as UploaderFileStatus, isResizableImage } from 'ui.uploader.core';\nimport { runAction } from 'im.v2.lib.rest';\n\nimport { Core } from 'im.v2.application.core';\nimport { FileStatus, FileType, RestMethod } from 'im.v2.const';\nimport { Utils } from 'im.v2.lib.utils';\nimport { Logger } from 'im.v2.lib.logger';\nimport { Notifier } from 'im.v2.lib.notifier';\nimport { SendingService } from 'im.v2.provider.service.sending';\n\nimport { UploaderWrapper } from './classes/uploader-wrapper';\nimport { createDeferredPromise } from './utils/deferred-promise';\n\nimport type { ImModelChat, ImModelUser, ImModelMessage } from 'im.v2.model';\nimport type { UploaderFile, UploaderError } from 'ui.uploader.core';\nimport type { Store } from 'ui.vue3.vuex';\nimport type { RestClient } from 'rest.client';\nimport type {\n\tMessageWithFile,\n\tFileFromDisk,\n\tFileCommitParams,\n\tUploadFilesParams,\n} from './types/uploading';\nimport type { UploaderWrapperFileOptions } from './classes/types/uploader-wrapper';\n\ntype CreateUploaderParams = {\n\tdialogId: number,\n\tautoUpload: boolean,\n\tsendAsFile: boolean,\n\tmaxParallelUploads: number,\n\tmaxParallelLoads: number,\n};\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Service.UploadingService';\n\nexport class UploadingService extends EventEmitter\n{\n\t#store: Store;\n\t#restClient: RestClient;\n\t#isRequestingDiskFolderId: boolean = false;\n\t#diskFolderIdRequestPromise: { [string]: Promise } = {};\n\t#uploaderWrappers: Map<string, UploaderWrapper> = new Map();\n\t#sendingService: SendingService;\n\n\tstatic event = {\n\t\tuploadStart: 'uploadStart',\n\t\tuploadComplete: 'uploadComplete',\n\t\tuploadError: 'uploadError',\n\t\tuploadCancel: 'uploadCancel',\n\t};\n\n\t#queue: Array<string> = [];\n\t#isUploading: boolean = false;\n\n\tstatic instance = null;\n\n\tstatic getInstance(): UploadingService\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tthis.#store = Core.getStore();\n\t\tthis.#restClient = Core.getRestClient();\n\t\tthis.#sendingService = SendingService.getInstance();\n\t}\n\n\t// eslint-disable-next-line max-lines-per-function\n\tasync #createUploader(params: CreateUploaderParams): Promise<{\n\t\tuploaderWrapper: UploaderWrapper,\n\t\tloadAllComplete: Promise<any>,\n\t\tuploadAllComplete: Promise<any>,\n\t}>\n\t{\n\t\tconst {\n\t\t\tdialogId,\n\t\t\tautoUpload = false,\n\t\t\tsendAsFile = false,\n\t\t\tmaxParallelUploads,\n\t\t\tmaxParallelLoads,\n\t\t} = params;\n\n\t\tconst uploaderId = Utils.text.getUuidV4();\n\t\tconst chatId = this.#getChatId(dialogId);\n\t\tconst folderId = await this.checkDiskFolderId(dialogId);\n\t\tconst tempMessageId = Utils.text.getUuidV4();\n\n\t\tconst loadAllComplete = createDeferredPromise();\n\t\tconst uploadAllComplete = createDeferredPromise();\n\t\tconst uploadPreviewPromises = [];\n\n\t\tconst uploaderWrapper = new UploaderWrapper({\n\t\t\tuploaderId,\n\t\t\tuploaderOptions: {\n\t\t\t\tautoUpload,\n\t\t\t\tmaxParallelLoads,\n\t\t\t\tmaxParallelUploads,\n\t\t\t\tcontrollerOptions: {\n\t\t\t\t\tfolderId,\n\t\t\t\t\tchat: {\n\t\t\t\t\t\tchatId,\n\t\t\t\t\t\tdialogId,\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t\tcustomData: {\n\t\t\t\tchatId,\n\t\t\t\tdialogId,\n\t\t\t\ttempMessageId,\n\t\t\t\tsendAsFile,\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\t[UploaderWrapper.Event.onFileAddStart]: (event: BaseEvent) => {\n\t\t\t\t\tconst { file } = event.getData();\n\t\t\t\t\tthis.#addFileToStore(file, sendAsFile);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileStatusChange]: (event: BaseEvent) => {\n\t\t\t\t\tconst { file }: { file: UploaderFile } = event.getData();\n\n\t\t\t\t\tif (file.getStatus() === UploaderFileStatus.PENDING)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.#isMediaFile(file))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#updateFilePreviewInStore(file, sendAsFile);\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.#updateFilePreviewInStore(file, sendAsFile);\n\t\t\t\t\t\t\tthis.#updateFileTypeInStore(file, FileType.file);\n\t\t\t\t\t\t\tfile.setTreatImageAsFile(true);\n\t\t\t\t\t\t\tfile.setCustomData('sendAsFile', true);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst target: UploaderWrapper = event.getTarget();\n\n\t\t\t\t\t\tif (target.isAllPending())\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloadAllComplete.resolve();\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileUploadStart]: (event: BaseEvent) => {\n\t\t\t\t\tconst { file } = event.getData();\n\t\t\t\t\tthis.#updateFileSizeInStore(file);\n\t\t\t\t\tthis.emit(UploadingService.event.uploadStart);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileUploadProgress]: (event: BaseEvent) => {\n\t\t\t\t\tconst { file } = event.getData();\n\t\t\t\t\tthis.#updateFileProgress(file.getId(), file.getProgress(), FileStatus.upload);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileUploadComplete]: async (event: BaseEvent) => {\n\t\t\t\t\tconst { file } = event.getData();\n\t\t\t\t\tconst serverFileId: number = file.getServerFileId().toString().slice(1);\n\t\t\t\t\tconst temporaryFileId: string = file.getId();\n\t\t\t\t\tif (this.#isMediaFile(file))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.#setFileMapping({ serverFileId, temporaryFileId });\n\t\t\t\t\t}\n\n\t\t\t\t\tthis.#updateFileProgress(temporaryFileId, file.getProgress(), FileStatus.wait);\n\n\t\t\t\t\tuploadPreviewPromises.push(\n\t\t\t\t\t\tthis.#uploadPreview(file),\n\t\t\t\t\t);\n\n\t\t\t\t\tthis.emit(UploadingService.event.uploadComplete);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileUploadError]: (event: BaseEvent) => {\n\t\t\t\t\tconst { error } = event.getData();\n\t\t\t\t\tconst target = event.getTarget();\n\n\t\t\t\t\tthis.#setMessageError(target.getCustomData('tempMessageId'));\n\n\t\t\t\t\ttarget.getFiles().forEach((uploaderFile: UploaderFile) => {\n\t\t\t\t\t\tthis.#updateFileProgress(uploaderFile.getId(), 0, FileStatus.error);\n\t\t\t\t\t});\n\n\t\t\t\t\tif (this.#isMaxFileSizeExceeded(error))\n\t\t\t\t\t{\n\t\t\t\t\t\tNotifier.file.handleUploadError(error);\n\t\t\t\t\t}\n\n\t\t\t\t\tLogger.error('UploadingService: upload error', error);\n\t\t\t\t\tthis.emit(UploadingService.event.uploadError);\n\n\t\t\t\t\tthis.#isUploading = false;\n\t\t\t\t\tthis.#processQueue();\n\t\t\t\t\tthis.stop(uploaderId);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onFileUploadCancel]: (event: BaseEvent) => {\n\t\t\t\t\tconst { tempFileId } = event.getData();\n\t\t\t\t\tthis.#cancelUpload(tempMessageId, tempFileId);\n\t\t\t\t\tthis.emit(UploadingService.event.uploadCancel);\n\t\t\t\t},\n\t\t\t\t[UploaderWrapper.Event.onUploadComplete]: async (event: BaseEvent) => {\n\t\t\t\t\tthis.#isUploading = false;\n\t\t\t\t\tthis.#processQueue();\n\n\t\t\t\t\tconst target: UploaderWrapper = event.getTarget();\n\t\t\t\t\tif (target.isAllCompleted())\n\t\t\t\t\t{\n\t\t\t\t\t\tawait Promise.all(uploadPreviewPromises);\n\t\t\t\t\t\tuploadAllComplete.resolve();\n\t\t\t\t\t\tawait this.commitMessage(uploaderId);\n\t\t\t\t\t\tthis.#destroyUploader(uploaderId);\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\n\t\treturn {\n\t\t\tuploaderWrapper,\n\t\t\tloadAllComplete: loadAllComplete.promise,\n\t\t\tuploadAllComplete: uploadAllComplete.promise,\n\t\t};\n\t}\n\n\tprepareFilesOptions(\n\t\tfiles: Array<File | Blob | UploaderFile>,\n\t\toptions: { chatId: number, dialogId: number },\n\t\tsendAsFile: boolean,\n\t): Array<UploaderWrapperFileOptions>\n\t{\n\t\treturn files.map((file: UploaderWrapperFileOptions | UploaderFile) => {\n\t\t\tconst id = Utils.text.getUuidV4();\n\n\t\t\tif (Type.isFunction(file.getBinary))\n\t\t\t{\n\t\t\t\treturn {\n\t\t\t\t\tfile: file.getBinary(),\n\t\t\t\t\toptions: {\n\t\t\t\t\t\t...file.toJSON(),\n\t\t\t\t\t\tclientPreview: file.getClientPreview(),\n\t\t\t\t\t\tid,\n\t\t\t\t\t\tcustomData: {\n\t\t\t\t\t\t\t...options,\n\t\t\t\t\t\t},\n\t\t\t\t\t\ttreatImageAsFile: sendAsFile,\n\t\t\t\t\t},\n\t\t\t\t};\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tfile,\n\t\t\t\toptions: {\n\t\t\t\t\tid,\n\t\t\t\t\tcustomData: {\n\t\t\t\t\t\t...options,\n\t\t\t\t\t},\n\t\t\t\t\tdownloadUrl: URL.createObjectURL(file),\n\t\t\t\t},\n\t\t\t};\n\t\t});\n\t}\n\n\tasync addFiles(params: UploadFilesParams): Promise<{\n\t\tuploaderFiles: UploaderFile[],\n\t\tuploaderId: string,\n\t\tloadAllComplete: Promise<any>,\n\t\tuploadAllComplete: Promise<any>,\n\t}>\n\t{\n\t\tconst {\n\t\t\tfiles,\n\t\t\tdialogId,\n\t\t\tautoUpload,\n\t\t\tsendAsFile = false,\n\t\t\tmaxParallelUploads,\n\t\t\tmaxParallelLoads,\n\t\t} = params;\n\n\t\tconst {\n\t\t\tuploaderWrapper,\n\t\t\tloadAllComplete,\n\t\t\tuploadAllComplete,\n\t\t} = await this.#createUploader({\n\t\t\tdialogId,\n\t\t\tautoUpload,\n\t\t\tsendAsFile,\n\t\t\tmaxParallelUploads,\n\t\t\tmaxParallelLoads,\n\t\t});\n\t\tconst uploaderId: string = uploaderWrapper.getId();\n\t\tconst chatId = this.#getChatId(dialogId);\n\n\t\tthis.#uploaderWrappers.set(uploaderId, uploaderWrapper);\n\n\t\tconst filesOptions = this.prepareFilesOptions(\n\t\t\tfiles,\n\t\t\t{\n\t\t\t\tchatId,\n\t\t\t\tdialogId,\n\t\t\t},\n\t\t\tsendAsFile,\n\t\t);\n\n\t\tconst uploaderFiles = uploaderWrapper.addFiles(filesOptions);\n\n\t\treturn {\n\t\t\tuploaderFiles,\n\t\t\tuploaderId,\n\t\t\tloadAllComplete,\n\t\t\tuploadAllComplete,\n\t\t};\n\t}\n\n\tgetFiles(uploaderId): UploaderFile[]\n\t{\n\t\treturn this.#uploaderWrappers.get(uploaderId).getFiles();\n\t}\n\n\t#addToQueue(uploaderId: string)\n\t{\n\t\tthis.#queue.push(uploaderId);\n\t\tthis.#processQueue();\n\t}\n\n\t#processQueue()\n\t{\n\t\tif (this.#isUploading || this.#queue.length === 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#isUploading = true;\n\n\t\tconst uploaderId: string = this.#queue.shift();\n\t\tthis.#uploaderWrappers.get(uploaderId).start();\n\t}\n\n\tstart(uploaderId: string)\n\t{\n\t\tthis.getFiles(uploaderId).forEach((file: UploaderFile) => {\n\t\t\tthis.#updateFileProgress(file.getId(), 0, FileStatus.progress);\n\t\t});\n\n\t\tthis.#addToQueue(uploaderId);\n\t}\n\n\tstop(uploaderId: string)\n\t{\n\t\tthis.#uploaderWrappers.get(uploaderId).stop();\n\t}\n\n\tuploadFileFromDisk(files, dialogId)\n\t{\n\t\tObject.values(files).forEach((file) => {\n\t\t\tconst messageWithFile = this.#prepareFileFromDisk(file, dialogId);\n\n\t\t\tthis.#addFileFromDiskToModel(messageWithFile).then(() => {\n\t\t\t\tconst message = {\n\t\t\t\t\ttempMessageId: messageWithFile.tempMessageId,\n\t\t\t\t\tfileIds: [messageWithFile.tempFileId],\n\t\t\t\t\tdialogId: messageWithFile.dialogId,\n\t\t\t\t};\n\n\t\t\t\treturn this.#sendingService.sendMessageWithFiles(message);\n\t\t\t}).then(() => {\n\t\t\t\tthis.commitFile({\n\t\t\t\t\tchatId: messageWithFile.chatId,\n\t\t\t\t\ttemporaryFileId: messageWithFile.tempFileId,\n\t\t\t\t\ttempMessageId: messageWithFile.tempMessageId,\n\t\t\t\t\trealFileId: messageWithFile.file.id.slice(1),\n\t\t\t\t\tfromDisk: true,\n\t\t\t\t});\n\t\t\t}).catch((error) => {\n\t\t\t\tconsole.error('SendingService: sendFilesFromDisk error:', error);\n\t\t\t});\n\t\t});\n\t}\n\n\t#addFileFromDiskToModel(messageWithFile: MessageWithFile): Promise\n\t{\n\t\treturn this.#store.dispatch('files/add', {\n\t\t\tid: messageWithFile.tempFileId,\n\t\t\tchatId: messageWithFile.chatId,\n\t\t\tauthorId: Core.getUserId(),\n\t\t\tname: messageWithFile.file.name,\n\t\t\ttype: Utils.file.getFileTypeByExtension(messageWithFile.file.ext),\n\t\t\textension: messageWithFile.file.ext,\n\t\t\tsize: messageWithFile.file.sizeInt,\n\t\t\tstatus: FileStatus.wait,\n\t\t\tprogress: 0,\n\t\t\tauthorName: this.#getCurrentUser().name,\n\t\t});\n\t}\n\n\t#isMediaFile(file: UploaderFile): boolean\n\t{\n\t\treturn (\n\t\t\tisResizableImage(file.getBinary())\n\t\t\t|| (\n\t\t\t\tfile.isVideo()\n\t\t\t\t&& Type.isStringFilled(file.getPreviewUrl())\n\t\t\t)\n\t\t);\n\t}\n\n\t#setFileMapping(options: {serverFileId: number, temporaryFileId: string})\n\t{\n\t\tvoid this.#store.dispatch('files/setTemporaryFileMapping', options);\n\t}\n\n\tcheckDiskFolderId(dialogId: string): Promise<number>\n\t{\n\t\tif (this.#getDiskFolderId(dialogId) > 0)\n\t\t{\n\t\t\treturn Promise.resolve(this.#getDiskFolderId(dialogId));\n\t\t}\n\n\t\tif (this.#isRequestingDiskFolderId)\n\t\t{\n\t\t\treturn this.#diskFolderIdRequestPromise[dialogId];\n\t\t}\n\n\t\tthis.#diskFolderIdRequestPromise[dialogId] = this.#requestDiskFolderId(dialogId);\n\n\t\treturn this.#diskFolderIdRequestPromise[dialogId];\n\t}\n\n\t#requestDiskFolderId(dialogId: string): Promise\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.#isRequestingDiskFolderId = true;\n\n\t\t\tconst chatId = this.#getChatId(dialogId);\n\t\t\tthis.#restClient.callMethod(RestMethod.imDiskFolderGet, { chat_id: chatId }).then((response) => {\n\t\t\t\tconst { ID: diskFolderId } = response.data();\n\t\t\t\tthis.#isRequestingDiskFolderId = false;\n\t\t\t\tvoid this.#store.dispatch('chats/update', {\n\t\t\t\t\tdialogId,\n\t\t\t\t\tfields: {\n\t\t\t\t\t\tdiskFolderId,\n\t\t\t\t\t},\n\t\t\t\t});\n\t\t\t\tresolve(diskFolderId);\n\t\t\t}).catch((error) => {\n\t\t\t\tthis.#isRequestingDiskFolderId = false;\n\t\t\t\treject(error);\n\t\t\t});\n\t\t});\n\t}\n\n\tcommitFile(params: FileCommitParams)\n\t{\n\t\tconst { temporaryFileId, tempMessageId, chatId, realFileId, fromDisk, messageText = '', sendAsFile = false } = params;\n\n\t\tconst fileIdParams = {};\n\t\tif (fromDisk)\n\t\t{\n\t\t\tfileIdParams.disk_id = realFileId;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tfileIdParams.upload_id = realFileId.toString().slice(1);\n\t\t}\n\n\t\tthis.#restClient.callMethod(RestMethod.imDiskFileCommit, {\n\t\t\tchat_id: chatId,\n\t\t\tmessage: messageText,\n\t\t\ttemplate_id: tempMessageId,\n\t\t\tfile_template_id: temporaryFileId,\n\t\t\tas_file: sendAsFile ? 'Y' : 'N',\n\t\t\t...fileIdParams,\n\t\t}).catch((error) => {\n\t\t\tthis.#setMessageError(tempMessageId);\n\t\t\tthis.#updateFileProgress(temporaryFileId, 0, FileStatus.error);\n\t\t\tconsole.error('commitFile error', error);\n\t\t});\n\t}\n\n\tcommitMessage(uploaderId: string): Promise\n\t{\n\t\tconst uploader: UploaderWrapper = this.#uploaderWrappers.get(uploaderId);\n\t\tconst chatId = uploader.getCustomData('chatId');\n\t\tconst sendAsFile = uploader.getCustomData('sendAsFile');\n\t\tconst text = uploader.getCustomData('text');\n\t\tconst tempMessageId = uploader.getCustomData('tempMessageId');\n\n\t\tconst fileIds = uploader.getServerFilesIds();\n\n\t\treturn this.#restClient.callMethod(RestMethod.imDiskFileCommit, {\n\t\t\tchat_id: chatId,\n\t\t\tmessage: text,\n\t\t\ttemplate_id: tempMessageId,\n\t\t\tas_file: sendAsFile ? 'Y' : 'N',\n\t\t\tupload_id: fileIds,\n\t\t});\n\t}\n\n\tasync #uploadPreview(file: UploaderFile): Promise\n\t{\n\t\tconst needPreview = this.#getFileType(file) === FileType.video || file.isAnimated();\n\t\tif (!needPreview)\n\t\t{\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst id = file.getServerFileId().toString().slice(1);\n\t\tconst previewFile = file.getClientPreview();\n\t\tif (!previewFile)\n\t\t{\n\t\t\tfile.setCustomData('sendAsFile', true);\n\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst formData = new FormData();\n\t\tformData.append('id', id);\n\t\tformData.append('previewFile', previewFile, `preview_${file.getName()}.jpg`);\n\n\t\treturn runAction(RestMethod.imDiskFilePreviewUpload, { data: formData })\n\t\t\t.catch(([error]) => {\n\t\t\t\tconsole.error('imDiskFilePreviewUpload request error', error);\n\t\t\t});\n\t}\n\n\t#updateFileProgress(id: string, progress: number, status: string)\n\t{\n\t\tvoid this.#store.dispatch('files/update', {\n\t\t\tid,\n\t\t\tfields: {\n\t\t\t\tprogress: (progress === 100 ? 99 : progress),\n\t\t\t\tstatus,\n\t\t\t},\n\t\t});\n\t}\n\n\t#cancelUpload(tempMessageId: string, tempFileId)\n\t{\n\t\tconst message: ImModelMessage = this.#store.getters['messages/getById'](tempMessageId);\n\t\tif (message)\n\t\t{\n\t\t\tvoid this.#store.dispatch('messages/delete', { id: tempMessageId });\n\t\t\tvoid this.#store.dispatch('files/delete', { id: tempFileId });\n\n\t\t\tconst chat: ImModelChat = this.#store.getters['chats/getByChatId'](message.chatId);\n\t\t\tconst lastMessageId: string | number | null = this.#store.getters['messages/findLastChatMessageId'](message.chatId);\n\n\t\t\tif (Type.isString(lastMessageId) || Type.isNumber(lastMessageId))\n\t\t\t{\n\t\t\t\tvoid this.#store.dispatch('recent/update', {\n\t\t\t\t\tid: chat.dialogId,\n\t\t\t\t\tfields: { messageId: lastMessageId },\n\t\t\t\t});\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tvoid this.#store.dispatch('recent/delete', {\n\t\t\t\t\tid: chat.dialogId,\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t}\n\n\t#getFileType(file: UploaderFile): string\n\t{\n\t\tif (isResizableImage(file.getBinary()))\n\t\t{\n\t\t\treturn FileType.image;\n\t\t}\n\n\t\tif (file.isVideo())\n\t\t{\n\t\t\treturn FileType.video;\n\t\t}\n\n\t\tif (file.getType().startsWith('audio'))\n\t\t{\n\t\t\treturn FileType.audio;\n\t\t}\n\n\t\treturn FileType.file;\n\t}\n\n\t#addFileToStore(file: UploaderFile, sendAsFile: boolean)\n\t{\n\t\tconst fileType = this.#getFileType(file);\n\t\tconst currentUser = this.#getCurrentUser();\n\t\tconst isFile = ![FileType.image, FileType.video].includes(fileType);\n\n\t\tvoid this.#store.dispatch('files/add', {\n\t\t\tid: file.getId(),\n\t\t\tname: file.getName(),\n\t\t\tsize: file.getSize(),\n\t\t\ttype: fileType,\n\t\t\textension: file.getExtension(),\n\t\t\tchatId: file.getCustomData('chatId'),\n\t\t\tauthorId: currentUser.id,\n\t\t\tauthorName: currentUser.name,\n\t\t\tstatus: file.isFailed() ? FileStatus.error : FileStatus.wait,\n\t\t\tprogress: 0,\n\t\t\turlDownload: file.getDownloadUrl(),\n\t\t\t...(() => {\n\t\t\t\tif (isFile || sendAsFile)\n\t\t\t\t{\n\t\t\t\t\treturn { image: false };\n\t\t\t\t}\n\n\t\t\t\treturn {};\n\t\t\t})(),\n\t\t});\n\t}\n\n\t#updateFilePreviewInStore(file: UploaderFile, sendAsFile: boolean)\n\t{\n\t\tvoid this.#store.dispatch('files/update', {\n\t\t\tid: file.getId(),\n\t\t\tfields: {\n\t\t\t\turlPreview: (() => {\n\t\t\t\t\tif (file.isImage())\n\t\t\t\t\t{\n\t\t\t\t\t\treturn file.getPreviewUrl() || file.getDownloadUrl();\n\t\t\t\t\t}\n\n\t\t\t\t\treturn file.getPreviewUrl();\n\t\t\t\t})(),\n\t\t\t\t...(() => {\n\t\t\t\t\tif (sendAsFile)\n\t\t\t\t\t{\n\t\t\t\t\t\treturn { image: false };\n\t\t\t\t\t}\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\timage: {\n\t\t\t\t\t\t\twidth: file.getPreviewWidth(),\n\t\t\t\t\t\t\theight: file.getPreviewHeight(),\n\t\t\t\t\t\t},\n\t\t\t\t\t};\n\t\t\t\t})(),\n\t\t\t},\n\t\t});\n\t}\n\n\t#updateFileTypeInStore(file: UploaderFile, type: string)\n\t{\n\t\tvoid this.#store.dispatch('files/update', {\n\t\t\tid: file.getId(),\n\t\t\tfields: {\n\t\t\t\ttype,\n\t\t\t},\n\t\t});\n\t}\n\n\t#updateFileSizeInStore(file: UploaderFile)\n\t{\n\t\tvoid this.#store.dispatch('files/update', {\n\t\t\tid: file.getId(),\n\t\t\tfields: {\n\t\t\t\tsize: file.getSize(),\n\t\t\t},\n\t\t});\n\t}\n\n\t#getDiskFolderId(dialogId: string): number\n\t{\n\t\treturn this.#getDialog(dialogId).diskFolderId;\n\t}\n\n\t#getDialog(dialogId: string): ImModelChat\n\t{\n\t\treturn this.#store.getters['chats/get'](dialogId);\n\t}\n\n\t#getCurrentUser(): ImModelUser\n\t{\n\t\tconst userId = Core.getUserId();\n\n\t\treturn this.#store.getters['users/get'](userId);\n\t}\n\n\t#getChatId(dialogId: string): ?number\n\t{\n\t\treturn this.#getDialog(dialogId)?.chatId;\n\t}\n\n\t#setMessagesText(uploaderId: string, text: string)\n\t{\n\t\tthis.#uploaderWrappers.get(uploaderId).setCustomData('text', text);\n\t}\n\n\tsendMessageWithFiles(params: { uploaderId: string, text: string })\n\t{\n\t\tconst { uploaderId, text } = params;\n\n\t\tthis.#setMessagesText(uploaderId, text);\n\t\tthis.#tryToSendMessage(uploaderId);\n\t}\n\n\t#createMessageFromFiles(uploaderId): {text: string, dialogId: string, tempMessageId: string, fileIds: []}\n\t{\n\t\tconst fileIds = [];\n\t\tconst files = this.getFiles(uploaderId);\n\t\tfiles.forEach((file) => {\n\t\t\tif (!file.getError())\n\t\t\t{\n\t\t\t\tfileIds.push(file.getId());\n\t\t\t}\n\t\t});\n\n\t\tconst text = this.#uploaderWrappers.get(uploaderId).getCustomData('text');\n\t\tconst dialogId = this.#uploaderWrappers.get(uploaderId).getCustomData('dialogId');\n\t\tconst tempMessageId = this.#uploaderWrappers.get(uploaderId).getCustomData('tempMessageId');\n\n\t\treturn {\n\t\t\tfileIds,\n\t\t\ttempMessageId,\n\t\t\tdialogId,\n\t\t\ttext,\n\t\t};\n\t}\n\n\t#tryToSendMessage(uploaderId: string)\n\t{\n\t\tconst message = this.#createMessageFromFiles(uploaderId);\n\t\tvoid this.#sendingService.sendMessageWithFiles(message);\n\t\tthis.start(uploaderId);\n\t}\n\n\t#prepareFileFromDisk(file: FileFromDisk, dialogId: string): MessageWithFile\n\t{\n\t\tconst tempMessageId = Utils.text.getUuidV4();\n\t\tconst realFileId = file.id.slice(1); // 'n123' => '123'\n\t\tconst tempFileId = `${tempMessageId}|${realFileId}`;\n\n\t\treturn {\n\t\t\ttempMessageId,\n\t\t\ttempFileId,\n\t\t\tdialogId,\n\t\t\tfile,\n\t\t\tchatId: this.#getDialog(dialogId).chatId,\n\t\t};\n\t}\n\n\t#isMaxFileSizeExceeded(error: UploaderError): boolean\n\t{\n\t\treturn error.getCode() === 'MAX_FILE_SIZE_EXCEEDED';\n\t}\n\n\t#setMessageError(tempMessageId: string)\n\t{\n\t\tvoid this.#store.dispatch('messages/update', {\n\t\t\tid: tempMessageId,\n\t\t\tfields: {\n\t\t\t\terror: true,\n\t\t\t},\n\t\t});\n\t}\n\n\tgetUploaderIdByFileId(fileId: string | number): ?string\n\t{\n\t\tconst uploaderIds: Array<string> = [...this.#uploaderWrappers.keys()];\n\n\t\treturn uploaderIds.find((uploaderId: string) => {\n\t\t\treturn this.getFiles(uploaderId).some((file: UploaderFile) => {\n\t\t\t\treturn file.getId() === fileId;\n\t\t\t});\n\t\t});\n\t}\n\n\tremoveFileFromUploader(options: { uploaderId: string, filesIds: Array<string>, restartUploading: boolean })\n\t{\n\t\tconst { uploaderId, filesIds, restartUploading = false } = options;\n\n\t\tconst files = this.#uploaderWrappers.get(uploaderId).getFiles().filter((file: UploaderFile) => {\n\t\t\treturn filesIds.includes(file.getId());\n\t\t});\n\n\t\tfiles.forEach((file: UploaderFile) => {\n\t\t\tfile.remove();\n\t\t\tfile.abort();\n\t\t});\n\n\t\tif (restartUploading)\n\t\t{\n\t\t\tconst [firstFile] = this.getFiles(uploaderId);\n\t\t\tif (firstFile)\n\t\t\t{\n\t\t\t\tfirstFile.upload();\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.#isUploading = false;\n\t\t\t\tthis.#processQueue();\n\t\t\t}\n\t\t}\n\t}\n\n\t#destroyUploader(uploaderId: string)\n\t{\n\t\tthis.#uploaderWrappers.get(uploaderId).destroy();\n\t\tthis.#uploaderWrappers.delete(uploaderId);\n\t}\n\n\tasync retry(uploaderId: string)\n\t{\n\t\tconst uploaderWrapper = this.#uploaderWrappers.get(uploaderId);\n\t\tconst dialogId = uploaderWrapper.getCustomData('dialogId');\n\t\tconst text = uploaderWrapper.getCustomData('text');\n\t\tconst tempMessageId = uploaderWrapper.getCustomData('tempMessageId');\n\n\t\tconst binaryFiles: Array<File> = uploaderWrapper.getBinaryFiles();\n\n\t\tconst { uploaderId: newUploaderId, loadAllComplete } = await this.addFiles({\n\t\t\tdialogId,\n\t\t\tfiles: binaryFiles,\n\t\t});\n\n\t\tvoid this.#store.dispatch('messages/deleteLoadingMessageByMessageId', {\n\t\t\tmessageId: tempMessageId,\n\t\t});\n\n\t\tawait loadAllComplete;\n\n\t\tthis.sendMessageWithFiles({\n\t\t\tuploaderId: newUploaderId,\n\t\t\ttext,\n\t\t});\n\n\t\tthis.#destroyUploader(uploaderId);\n\t}\n}\n","import { Utils } from 'im.v2.lib.utils';\nimport { Type } from 'main.core';\n\nimport { UploadingService } from './uploading';\n\nimport type { UploaderFile } from 'ui.uploader.core';\nimport type { UploadFilesParams, UploadParams } from './types/uploading';\n\ntype AddFilesResult = {\n\tuploaderFiles: Array<UploaderFile>,\n\tuploaderId: string,\n\tloadAllComplete: Promise<any>,\n\tuploadAllComplete: Promise<any>,\n};\n\ntype MakeChunksOptions<T> = {\n\tfiles: Array<T>,\n\tchunkSize?: number,\n\tmaxFilesCount?: number,\n};\n\nexport type MultiUploadingResult = {\n\tuploadingId: string,\n\tuploaderIds: Array<string>,\n\tsourceFilesCount: number,\n\tloadAllComplete: Promise<any>,\n\tuploadAllComplete: Promise<any>,\n};\n\nconst MAX_FILES_COUNT_IN_ONE_MESSAGE = 10;\nconst MAX_FILES_COUNT = 100;\nconst MAX_PARALLEL_LOADS = 10;\nconst MAX_PARALLEL_UPLOADS = 3;\n\nexport class MultiUploadingService\n{\n\tstatic makeChunks<T>(options: MakeChunksOptions): Array<Array<T>>\n\t{\n\t\tconst {\n\t\t\tfiles,\n\t\t\tchunkSize = MAX_FILES_COUNT_IN_ONE_MESSAGE,\n\t\t\tmaxFilesCount = MAX_FILES_COUNT,\n\t\t}: MakeChunksOptions = options;\n\n\t\tconst chunks: Array<Array<T>> = [];\n\t\tif (Type.isArray(files))\n\t\t{\n\t\t\tconst preparedFiles: Array<T> = files.slice(0, maxFilesCount);\n\t\t\tfor (let i = 0; i < preparedFiles.length; i += chunkSize)\n\t\t\t{\n\t\t\t\tconst chunk = preparedFiles.slice(i, i + chunkSize);\n\t\t\t\tchunks.push(chunk);\n\t\t\t}\n\t\t}\n\n\t\treturn chunks;\n\t}\n\n\tstatic getMaxParallelLoads<T>(chunks: Array<Array<T>>): number\n\t{\n\t\treturn Math.floor(MAX_PARALLEL_LOADS / chunks.length);\n\t}\n\n\t#getUploadingService(): UploadingService\n\t{\n\t\treturn UploadingService.getInstance();\n\t}\n\n\t#createUploadingId(): string\n\t{\n\t\treturn Utils.text.getUuidV4();\n\t}\n\n\tasync #addFiles(params: UploadFilesParams): Promise<AddFilesResult>\n\t{\n\t\treturn this.#getUploadingService().addFiles(params);\n\t}\n\n\tasync upload({ files, dialogId, autoUpload, sendAsFile }: UploadParams): Promise<MultiUploadingResult>\n\t{\n\t\tconst chunks = MultiUploadingService.makeChunks({\n\t\t\tfiles,\n\t\t});\n\n\t\tconst addFilesResults: Array<AddFilesResult> = await Promise.all(\n\t\t\tchunks.map((chunk: Array<File>) => {\n\t\t\t\treturn this.#addFiles({\n\t\t\t\t\tfiles: chunk,\n\t\t\t\t\tmaxParallelLoads: MultiUploadingService.getMaxParallelLoads(chunks),\n\t\t\t\t\tmaxParallelUploads: MAX_PARALLEL_UPLOADS,\n\t\t\t\t\tdialogId,\n\t\t\t\t\tautoUpload,\n\t\t\t\t\tsendAsFile,\n\t\t\t\t});\n\t\t\t}),\n\t\t);\n\n\t\tconst uploadingId: string = this.#createUploadingId();\n\t\tconst uploaderIds: Array<string> = [];\n\t\tconst loadCompletePromises: Array<Promise<any>> = [];\n\t\tconst uploadCompletePromises: Array<Promise<any>> = [];\n\n\t\taddFilesResults.forEach(({ uploaderId, uploaderFiles, loadAllComplete, uploadAllComplete }) => {\n\t\t\tif (Type.isArrayFilled(uploaderFiles))\n\t\t\t{\n\t\t\t\tuploaderIds.push(uploaderId);\n\t\t\t\tloadCompletePromises.push(loadAllComplete);\n\t\t\t\tuploadCompletePromises.push(uploadAllComplete);\n\t\t\t}\n\t\t});\n\n\t\tconst loadAllComplete: Promise<any> = Promise.all(loadCompletePromises);\n\t\tconst uploadAllComplete: Promise<any> = Promise.all(uploadCompletePromises);\n\t\tconst sourceFilesCount: number = files.length;\n\n\t\treturn {\n\t\t\tuploadingId,\n\t\t\tuploaderIds,\n\t\t\tsourceFilesCount,\n\t\t\tloadAllComplete,\n\t\t\tuploadAllComplete,\n\t\t};\n\t}\n}\n"],"names":["UploaderVideoCompressionFilter","Filter","constructor","args","Core","getStore","apply","file","isVideo","shouldTreatImageAsFile","DesktopApi","isMediaCompressorAvailable","setModelFileStatus","getId","FileStatus","preparing","compressor","createMediaCompressor","cancelPromise","Promise","resolve","subscribeOnce","FileEvent","REMOVE_COMPLETE","cancel","removeCompressedFile","remove","compressedFile","race","compress","getBinary","setFile","setName","name","UPLOAD_COMPLETE","id","status","dispatch","fields","UploaderWrapper","EventEmitter","uploaderId","uploaderOptions","events","customData","setEventNamespace","EVENT_NAMESPACE","subscribeFromOptions","Uploader","controller","CONTROLLER","multiple","imageResizeWidth","imageResizeHeight","imageResizeMode","imageResizeMimeType","imageResizeMimeTypeMode","imagePreviewHeight","imagePreviewWidth","treatOversizeImageAsFile","ignoreUnknownImageTypes","maxFileSize","imageResizeFilter","getCustomData","isAnimated","UploaderEvent","FILE_ADD_START","event","emit","Event","onFileAddStart","getData","FILE_ADD","onFileAdd","FILE_LOAD_COMPLETE","onFileLoadComplete","FILE_STATE_CHANGE","onFileStateChange","FILE_STATUS_CHANGE","onFileStatusChange","FILE_UPLOAD_START","onFileUploadStart","FILE_UPLOAD_PROGRESS","onFileUploadProgress","FILE_UPLOAD_COMPLETE","onFileUploadComplete","ERROR","onFileUploadError","FILE_ERROR","MAX_FILE_COUNT_EXCEEDED","onMaxFileCountExceeded","onUploadComplete","filters","type","FilterType","PREPARATION","filter","Type","isPlainObject","setCustomData","key","value","addFiles","filesOptions","filesEntries","map","fileOption","Object","values","removeFile","fileId","getFile","getFiles","getFilesIds","isAllPending","every","currentFile","getStatus","UploaderFileStatus","PENDING","isAllCompleted","COMPLETE","getServerFilesIds","getServerFileId","toString","slice","getBinaryFiles","start","setAutoUpload","stop","destroy","removeFilesFromServer","onFileUploadCancel","createDeferredPromise","reject","promise","resolveRef","rejectRef","UploadingService","getInstance","instance","Map","getRestClient","SendingService","prepareFilesOptions","files","options","sendAsFile","Utils","text","getUuidV4","isFunction","toJSON","clientPreview","getClientPreview","treatImageAsFile","downloadUrl","URL","createObjectURL","params","dialogId","autoUpload","maxParallelUploads","maxParallelLoads","uploaderWrapper","loadAllComplete","uploadAllComplete","chatId","set","uploaderFiles","get","forEach","progress","uploadFileFromDisk","messageWithFile","then","message","tempMessageId","fileIds","tempFileId","sendMessageWithFiles","commitFile","temporaryFileId","realFileId","fromDisk","catch","error","console","checkDiskFolderId","messageText","fileIdParams","disk_id","upload_id","callMethod","RestMethod","imDiskFileCommit","chat_id","template_id","file_template_id","as_file","commitMessage","uploader","getUploaderIdByFileId","uploaderIds","keys","find","some","removeFileFromUploader","filesIds","restartUploading","includes","abort","firstFile","upload","retry","binaryFiles","newUploaderId","messageId","folderId","uploadPreviewPromises","controllerOptions","chat","FileType","setTreatImageAsFile","target","getTarget","uploadStart","getProgress","serverFileId","wait","push","uploadComplete","uploaderFile","Notifier","handleUploadError","Logger","uploadError","uploadCancel","all","length","shift","authorId","getUserId","getFileTypeByExtension","ext","extension","size","sizeInt","authorName","isResizableImage","isStringFilled","getPreviewUrl","imDiskFolderGet","response","ID","diskFolderId","data","needPreview","video","previewFile","formData","FormData","append","getName","runAction","imDiskFilePreviewUpload","getters","lastMessageId","isString","isNumber","image","getType","startsWith","audio","fileType","currentUser","isFile","getSize","getExtension","isFailed","urlDownload","getDownloadUrl","urlPreview","isImage","width","getPreviewWidth","height","getPreviewHeight","userId","getError","getCode","delete","MAX_FILES_COUNT_IN_ONE_MESSAGE","MAX_FILES_COUNT","MAX_PARALLEL_LOADS","MAX_PARALLEL_UPLOADS","MultiUploadingService","makeChunks","chunkSize","maxFilesCount","chunks","isArray","preparedFiles","i","chunk","getMaxParallelLoads","Math","floor","addFilesResults","uploadingId","loadCompletePromises","uploadCompletePromises","isArrayFilled","sourceFilesCount"],"mappings":";;;;;;;CAGwE;AAIxE,CAAO,MAAMA,8BAA8B,SAASC,uBAAM,CAC1D;GAGCC,WAAW,CAAC,GAAGC,IAAI,EACnB;KACC,KAAK,CAAC,GAAGA,IAAI,CAAC;KAAC;OAAA;OAAA,OAJA;;KAKf,4CAAI,oBAAUC,2BAAI,CAACC,QAAQ,EAAE;;GAG9B,MAAMC,KAAK,CAACC,IAAkB,EAC9B;KACC,IACCA,IAAI,CAACC,OAAO,EAAE,IACX,CAACD,IAAI,CAACE,sBAAsB,EAAE,IAC9BC,+BAAU,CAACC,0BAA0B,EAAE,EAE3C;OACC,MAAM,IAAI,CAACC,kBAAkB,CAACL,IAAI,CAACM,KAAK,EAAE,EAAEC,sBAAU,CAACC,SAAS,CAAC;OACjE,MAAMC,UAAU,GAAGN,+BAAU,CAACO,qBAAqB,EAAE;OAErD,MAAMC,aAA4B,GAAG,IAAIC,OAAO,CAAEC,OAAO,IAAK;SAC7Db,IAAI,CAACc,aAAa,CAACC,0BAAS,CAACC,eAAe,EAAE,MAAM;WACnDP,UAAU,CAACQ,MAAM,EAAE;WACnBR,UAAU,CAACS,oBAAoB,EAAE;WACjClB,IAAI,CAACmB,MAAM,EAAE;WACbN,OAAO,CAAC,IAAI,CAAC;UACb,CAAC;QACF,CAAC;OAEF,MAAMO,cAAqB,GAAG,MAAMR,OAAO,CAACS,IAAI,CAAC,CAChDZ,UAAU,CAACa,QAAQ,CAACtB,IAAI,CAACuB,SAAS,EAAE,CAAC,EACrCZ,aAAa,CACb,CAAC;OAEF,IAAIS,cAAc,EAClB;SACCpB,IAAI,CAACwB,OAAO,CAACJ,cAAc,CAAC;SAC5BpB,IAAI,CAACyB,OAAO,CAACL,cAAc,CAACM,IAAI,CAAC;SACjC1B,IAAI,CAACc,aAAa,CAACC,0BAAS,CAACY,eAAe,EAAE,MAAM;WACnDlB,UAAU,CAACS,oBAAoB,EAAE;UACjC,CAAC;;;;GAKLb,kBAAkB,CAACuB,EAAU,EAAEC,MAA2B,EAC1D;KACC,OAAO,4CAAI,kBAAQC,QAAQ,CAAC,cAAc,EAAE;OAC3CF,EAAE;OACFG,MAAM,EAAE;SAAEF;;MACV,CAAC;;CAEJ;;CCjD4E;CAAA;CAAA;AAI5E,CAAO,MAAMG,eAAe,SAASC,6BAAY,CACjD;GAsBCtC,WAAW,CAAC;KAAEuC,UAAU;KAAEC,eAAe;KAAEC,MAAM;KAAEC;IAAoC,EACvF;KACC,KAAK,EAAE;KAAC;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA,OAJ6B;;KAKrC,IAAI,CAACC,iBAAiB,CAACN,eAAe,CAACO,eAAe,CAAC;KACvD,IAAI,CAACC,oBAAoB,CAACJ,MAAM,CAAC;KAEjC,4CAAI,cAAOF,UAAU;KACrB,4CAAI,0BAAa,IAAIO,yBAAQ,CAAC;OAC7BC,UAAU,EAAEV,eAAe,CAACW,UAAU;OACtCC,QAAQ,EAAE,IAAI;OACdC,gBAAgB,EAAE,IAAI;OACtBC,iBAAiB,EAAE,IAAI;OACvBC,eAAe,EAAE,SAAS;OAC1BC,mBAAmB,EAAE,YAAY;OACjCC,uBAAuB,EAAE,OAAO;OAChCC,kBAAkB,EAAE,GAAG;OACvBC,iBAAiB,EAAE,GAAG;OACtBC,wBAAwB,EAAE,IAAI;OAC9BC,uBAAuB,EAAE,IAAI;OAC7BC,WAAW,EAAE,IAAI;OACjBC,iBAAiB,EAAGvD,IAAkB,IAAK;SAC1C,OAAO,CAACA,IAAI,CAACwD,aAAa,CAAC,YAAY,CAAC,IAAI,CAACxD,IAAI,CAACyD,UAAU,EAAE;QAC9D;OACD,GAAGtB,eAAe;OAClBC,MAAM,EAAE;SACP,CAACsB,8BAAa,CAACC,cAAc,GAAIC,KAAgB,IAAK;WACrD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACC,cAAc,EAAE;aAAE,GAAGH,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACnF;SACD,CAACwB,8BAAa,CAACO,QAAQ,GAAIL,KAAgB,IAAK;WAC/C,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACI,SAAS,EAAE;aAAE,GAAGN,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UAC9E;SACD,CAACwB,8BAAa,CAACS,kBAAkB,GAAIP,KAAgB,IAAK;WACzD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACM,kBAAkB,EAAE;aAAE,GAAGR,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACvF;SACD,CAACwB,8BAAa,CAACW,iBAAiB,GAAIT,KAAgB,IAAK;WACxD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACQ,iBAAiB,EAAE;aAAE,GAAGV,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACtF;SACD,CAACwB,8BAAa,CAACa,kBAAkB,GAAIX,KAAgB,IAAK;WACzD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACU,kBAAkB,EAAE;aAAE,GAAGZ,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACvF;SACD,CAACwB,8BAAa,CAACe,iBAAiB,GAAIb,KAAgB,IAAK;WACxD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACY,iBAAiB,EAAE;aAAE,GAAGd,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACtF;SACD,CAACwB,8BAAa,CAACiB,oBAAoB,GAAIf,KAAgB,IAAK;WAC3D,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACc,oBAAoB,EAAE;aAAE,GAAGhB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACzF;SACD,CAACwB,8BAAa,CAACmB,oBAAoB,GAAIjB,KAAgB,IAAK;WAC3D,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACgB,oBAAoB,EAAE;aAAE,GAAGlB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACzF;SACD,CAACwB,8BAAa,CAACqB,KAAK,GAAInB,KAAgB,IAAK;WAC5C,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACkB,iBAAiB,EAAE;aAAE,GAAGpB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACtF;SACD,CAACwB,8BAAa,CAACuB,UAAU,GAAIrB,KAAgB,IAAK;WACjD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACkB,iBAAiB,EAAE;aAAE,GAAGpB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UACtF;SACD,CAACwB,8BAAa,CAACwB,uBAAuB,GAAItB,KAAgB,IAAK;WAC9D,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACqB,sBAAsB,EAAE;aAAE,GAAGvB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;UAC3F;SACD,CAACwB,8BAAa,CAAC/B,eAAe,GAAIiC,KAAgB,IAAK;WACtD,IAAI,CAACC,IAAI,CAAC7B,eAAe,CAAC8B,KAAK,CAACsB,gBAAgB,EAAE;aAAE,GAAGxB,KAAK,CAACI,OAAO,EAAE;aAAE9B;YAAY,CAAC;;QAEtF;OACDmD,OAAO,EAAE,CACR;SACCC,IAAI,EAAEC,2BAAU,CAACC,WAAW;SAC5BC,MAAM,EAAEhG;QACR;MAEF,CAAC;KAEF,IAAIiG,cAAI,CAACC,aAAa,CAACtD,UAAU,CAAC,EAClC;OACC,4CAAI,8BAAeA,UAAU;;;GAI/B/B,KAAK,GACL;KACC,+CAAO,IAAI;;GAGZsF,aAAa,CAACC,GAAG,EAAEC,KAAK,EACxB;KACC,4CAAI,4BAAaD,GAAG,CAAC,GAAGC,KAAK;;GAG9BtC,aAAa,CAACqC,GAAW,EACzB;KACC,OAAO,4CAAI,4BAAaA,GAAG,CAAC;;GAG7BE,QAAQ,CAACC,YAA+C,EACxD;KACC,MAAMC,YAA4D,GAAGD,YAAY,CAACE,GAAG,CAAEC,UAAU,IAAK;OACrG,OAAOC,MAAM,CAACC,MAAM,CAACF,UAAU,CAAC;MAChC,CAAC;KAEF,OAAO,4CAAI,wBAAWJ,QAAQ,CAACE,YAAY,CAAC;;GAG7CK,UAAU,CAACC,MAAc,EACzB;KAAA;KACC,qEAAI,wBAAWC,OAAO,CAACD,MAAM,CAAC,qBAA9B,sBAAgCpF,MAAM,oBAAtC,sBAAgCA,MAAM,EAAI;;GAG3CsF,QAAQ,GACR;KACC,OAAO,4CAAI,wBAAWA,QAAQ,EAAE;;GAGjCC,WAAW,GACX;KACC,OAAO,IAAI,CAACD,QAAQ,EAAE,CAACP,GAAG,CAAElG,IAAkB,IAAK;OAClD,OAAOA,IAAI,CAACM,KAAK,EAAE;MACnB,CAAC;;GAGHqG,YAAY,GACZ;KACC,OAAO,IAAI,CAACF,QAAQ,EAAE,CAACG,KAAK,CAAEC,WAAyB,IAAK;OAC3D,OAAOA,WAAW,CAACC,SAAS,EAAE,KAAKC,2BAAkB,CAACC,OAAO;MAC7D,CAAC;;GAGHC,cAAc,GACd;KACC,OAAO,IAAI,CAACR,QAAQ,EAAE,CAACG,KAAK,CAAEC,WAAyB,IAAK;OAC3D,OAAOA,WAAW,CAACC,SAAS,EAAE,KAAKC,2BAAkB,CAACG,QAAQ;MAC9D,CAAC;;GAGHC,iBAAiB,GACjB;KACC,OAAO,IAAI,CAACV,QAAQ,EAAE,CAACP,GAAG,CAAElG,IAAkB,IAAK;OAClD,OAAOA,IAAI,CAACoH,eAAe,EAAE,CAACC,QAAQ,EAAE,CAACC,KAAK,CAAC,CAAC,CAAC;MACjD,CAAC;;GAGHC,cAAc,GACd;KACC,OAAO,IAAI,CAACd,QAAQ,EAAE,CAACP,GAAG,CAAElG,IAAkB,IAAK;OAClD,OAAOA,IAAI,CAACuB,SAAS,EAAE;MACvB,CAAC;;GAGHiG,KAAK,GACL;KACC,4CAAI,wBAAWC,aAAa,CAAC,IAAI,CAAC;KAClC,4CAAI,wBAAWD,KAAK,EAAE;;GAGvBE,IAAI,GACJ;KACC,4CAAI,wBAAWA,IAAI,EAAE;;GAGtBC,OAAO,GACP;KACC,4CAAI,wBAAWA,OAAO,CAAC;OAAEC,qBAAqB,EAAE;MAAO,CAAC;;CAE1D;CAvLa5F,eAAe,CAEpBO,eAAe,GAAG,mDAAmD;CAFhEP,eAAe,CAGpBW,UAAU,GAAG,4CAA4C;CAHpDX,eAAe,CAIpB8B,KAAK,GAAG;GACdC,cAAc,EAAE,gBAAgB;GAChCG,SAAS,EAAE,WAAW;GACtBE,kBAAkB,EAAE,oBAAoB;GACxCE,iBAAiB,EAAE,mBAAmB;GACtCE,kBAAkB,EAAE,oBAAoB;GACxCE,iBAAiB,EAAE,mBAAmB;GACtCE,oBAAoB,EAAE,sBAAsB;GAC5CE,oBAAoB,EAAE,sBAAsB;GAC5CE,iBAAiB,EAAE,mBAAmB;GACtC6C,kBAAkB,EAAE,oBAAoB;GACxC1C,sBAAsB,EAAE,wBAAwB;GAChDC,gBAAgB,EAAE;CACnB,CAAC;;CChCK,SAAS0C,qBAAqB,GACrC;GACC,IAAIjH,OAAO;GACX,IAAIkH,MAAM;GACV,MAAMC,OAAO,GAAG,IAAIpH,OAAO,CAAC,CAACqH,UAAU,EAAEC,SAAS,KAAK;KACtDrH,OAAO,GAAGoH,UAAU;KACpBF,MAAM,GAAGG,SAAS;IAClB,CAAC;GAEF,OAAO;KACNF,OAAO;KACPnH,OAAO;KACPkH;IACA;CACF;;CCqBA,MAAMxF,eAAe,GAAG,0CAA0C;CAAC;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;CAAA;AAEnE,CAAO,MAAM4F,gBAAgB,SAASlG,6BAAY,CAClD;GAoBC,OAAOmG,WAAW,GAClB;KACC,IAAI,CAAC,IAAI,CAACC,QAAQ,EAClB;OACC,IAAI,CAACA,QAAQ,GAAG,IAAI,IAAI,EAAE;;KAG3B,OAAO,IAAI,CAACA,QAAQ;;GAGrB1I,WAAW,GACX;KACC,KAAK,EAAE;KAAC;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA;;KAAA;OAAA;OAAA,OA7B4B;;KAAK;OAAA;OAAA,OACW;;KAAE;OAAA;OAAA,OACL,IAAI2I,GAAG;;KAAE;OAAA;OAAA;;KAAA;OAAA;OAAA,OAUnC;;KAAE;OAAA;OAAA,OACF;;KAiBvB,IAAI,CAAChG,iBAAiB,CAACC,eAAe,CAAC;KAEvC,4CAAI,wBAAU1C,2BAAI,CAACC,QAAQ,EAAE;KAC7B,4CAAI,8BAAeD,2BAAI,CAAC0I,aAAa,EAAE;KACvC,4CAAI,sCAAmBC,6CAAc,CAACJ,WAAW,EAAE;;;;;GAyJpDK,mBAAmB,CAClBC,KAAwC,EACxCC,OAA6C,EAC7CC,UAAmB,EAEpB;KACC,OAAOF,KAAK,CAACxC,GAAG,CAAElG,IAA+C,IAAK;OACrE,MAAM4B,EAAE,GAAGiH,qBAAK,CAACC,IAAI,CAACC,SAAS,EAAE;OAEjC,IAAIrD,cAAI,CAACsD,UAAU,CAAChJ,IAAI,CAACuB,SAAS,CAAC,EACnC;SACC,OAAO;WACNvB,IAAI,EAAEA,IAAI,CAACuB,SAAS,EAAE;WACtBoH,OAAO,EAAE;aACR,GAAG3I,IAAI,CAACiJ,MAAM,EAAE;aAChBC,aAAa,EAAElJ,IAAI,CAACmJ,gBAAgB,EAAE;aACtCvH,EAAE;aACFS,UAAU,EAAE;eACX,GAAGsG;cACH;aACDS,gBAAgB,EAAER;;UAEnB;;OAGF,OAAO;SACN5I,IAAI;SACJ2I,OAAO,EAAE;WACR/G,EAAE;WACFS,UAAU,EAAE;aACX,GAAGsG;YACH;WACDU,WAAW,EAAEC,GAAG,CAACC,eAAe,CAACvJ,IAAI;;QAEtC;MACD,CAAC;;GAGH,MAAM+F,QAAQ,CAACyD,MAAyB,EAMxC;KACC,MAAM;OACLd,KAAK;OACLe,QAAQ;OACRC,UAAU;OACVd,UAAU,GAAG,KAAK;OAClBe,kBAAkB;OAClBC;MACA,GAAGJ,MAAM;KAEV,MAAM;OACLK,eAAe;OACfC,eAAe;OACfC;MACA,GAAG,8CAAM,IAAI,oCAAiB;OAC9BN,QAAQ;OACRC,UAAU;OACVd,UAAU;OACVe,kBAAkB;OAClBC;MACA,CAAC;KACF,MAAM1H,UAAkB,GAAG2H,eAAe,CAACvJ,KAAK,EAAE;KAClD,MAAM0J,MAAM,2CAAG,IAAI,0BAAYP,QAAQ,CAAC;KAExC,4CAAI,wCAAmBQ,GAAG,CAAC/H,UAAU,EAAE2H,eAAe,CAAC;KAEvD,MAAM7D,YAAY,GAAG,IAAI,CAACyC,mBAAmB,CAC5CC,KAAK,EACL;OACCsB,MAAM;OACNP;MACA,EACDb,UAAU,CACV;KAED,MAAMsB,aAAa,GAAGL,eAAe,CAAC9D,QAAQ,CAACC,YAAY,CAAC;KAE5D,OAAO;OACNkE,aAAa;OACbhI,UAAU;OACV4H,eAAe;OACfC;MACA;;GAGFtD,QAAQ,CAACvE,UAAU,EACnB;KACC,OAAO,4CAAI,wCAAmBiI,GAAG,CAACjI,UAAU,CAAC,CAACuE,QAAQ,EAAE;;GAsBzDe,KAAK,CAACtF,UAAkB,EACxB;KACC,IAAI,CAACuE,QAAQ,CAACvE,UAAU,CAAC,CAACkI,OAAO,CAAEpK,IAAkB,IAAK;OACzD,4CAAI,4CAAqBA,IAAI,CAACM,KAAK,EAAE,EAAE,CAAC,EAAEC,sBAAU,CAAC8J,QAAQ;MAC7D,CAAC;KAEF,4CAAI,4BAAanI,UAAU;;GAG5BwF,IAAI,CAACxF,UAAkB,EACvB;KACC,4CAAI,wCAAmBiI,GAAG,CAACjI,UAAU,CAAC,CAACwF,IAAI,EAAE;;GAG9C4C,kBAAkB,CAAC5B,KAAK,EAAEe,QAAQ,EAClC;KACCrD,MAAM,CAACC,MAAM,CAACqC,KAAK,CAAC,CAAC0B,OAAO,CAAEpK,IAAI,IAAK;OACtC,MAAMuK,eAAe,2CAAG,IAAI,8CAAsBvK,IAAI,EAAEyJ,QAAQ,CAAC;OAEjE,4CAAI,oDAAyBc,eAAe,EAAEC,IAAI,CAAC,MAAM;SACxD,MAAMC,OAAO,GAAG;WACfC,aAAa,EAAEH,eAAe,CAACG,aAAa;WAC5CC,OAAO,EAAE,CAACJ,eAAe,CAACK,UAAU,CAAC;WACrCnB,QAAQ,EAAEc,eAAe,CAACd;UAC1B;SAED,OAAO,4CAAI,oCAAiBoB,oBAAoB,CAACJ,OAAO,CAAC;QACzD,CAAC,CAACD,IAAI,CAAC,MAAM;SACb,IAAI,CAACM,UAAU,CAAC;WACfd,MAAM,EAAEO,eAAe,CAACP,MAAM;WAC9Be,eAAe,EAAER,eAAe,CAACK,UAAU;WAC3CF,aAAa,EAAEH,eAAe,CAACG,aAAa;WAC5CM,UAAU,EAAET,eAAe,CAACvK,IAAI,CAAC4B,EAAE,CAAC0F,KAAK,CAAC,CAAC,CAAC;WAC5C2D,QAAQ,EAAE;UACV,CAAC;QACF,CAAC,CAACC,KAAK,CAAEC,KAAK,IAAK;SACnBC,OAAO,CAACD,KAAK,CAAC,0CAA0C,EAAEA,KAAK,CAAC;QAChE,CAAC;MACF,CAAC;;GAmCHE,iBAAiB,CAAC5B,QAAgB,EAClC;KACC,IAAI,4CAAI,sCAAkBA,QAAQ,IAAI,CAAC,EACvC;OACC,OAAO7I,OAAO,CAACC,OAAO,yCAAC,IAAI,sCAAkB4I,QAAQ,EAAE;;KAGxD,4CAAI,IAAI,yDACR;OACC,OAAO,4CAAI,4DAA6BA,QAAQ,CAAC;;KAGlD,4CAAI,4DAA6BA,QAAQ,CAAC,2CAAG,IAAI,8CAAsBA,QAAQ,CAAC;KAEhF,OAAO,4CAAI,4DAA6BA,QAAQ,CAAC;;GA0BlDqB,UAAU,CAACtB,MAAwB,EACnC;KACC,MAAM;OAAEuB,eAAe;OAAEL,aAAa;OAAEV,MAAM;OAAEgB,UAAU;OAAEC,QAAQ;OAAEK,WAAW,GAAG,EAAE;OAAE1C,UAAU,GAAG;MAAO,GAAGY,MAAM;KAErH,MAAM+B,YAAY,GAAG,EAAE;KACvB,IAAIN,QAAQ,EACZ;OACCM,YAAY,CAACC,OAAO,GAAGR,UAAU;MACjC,MAED;OACCO,YAAY,CAACE,SAAS,GAAGT,UAAU,CAAC3D,QAAQ,EAAE,CAACC,KAAK,CAAC,CAAC,CAAC;;KAGxD,4CAAI,4BAAaoE,UAAU,CAACC,sBAAU,CAACC,gBAAgB,EAAE;OACxDC,OAAO,EAAE7B,MAAM;OACfS,OAAO,EAAEa,WAAW;OACpBQ,WAAW,EAAEpB,aAAa;OAC1BqB,gBAAgB,EAAEhB,eAAe;OACjCiB,OAAO,EAAEpD,UAAU,GAAG,GAAG,GAAG,GAAG;OAC/B,GAAG2C;MACH,CAAC,CAACL,KAAK,CAAEC,KAAK,IAAK;OACnB,4CAAI,sCAAkBT,aAAa;OACnC,4CAAI,4CAAqBK,eAAe,EAAE,CAAC,EAAExK,sBAAU,CAAC4K,KAAK;OAC7DC,OAAO,CAACD,KAAK,CAAC,kBAAkB,EAAEA,KAAK,CAAC;MACxC,CAAC;;GAGHc,aAAa,CAAC/J,UAAkB,EAChC;KACC,MAAMgK,QAAyB,GAAG,4CAAI,wCAAmB/B,GAAG,CAACjI,UAAU,CAAC;KACxE,MAAM8H,MAAM,GAAGkC,QAAQ,CAAC1I,aAAa,CAAC,QAAQ,CAAC;KAC/C,MAAMoF,UAAU,GAAGsD,QAAQ,CAAC1I,aAAa,CAAC,YAAY,CAAC;KACvD,MAAMsF,IAAI,GAAGoD,QAAQ,CAAC1I,aAAa,CAAC,MAAM,CAAC;KAC3C,MAAMkH,aAAa,GAAGwB,QAAQ,CAAC1I,aAAa,CAAC,eAAe,CAAC;KAE7D,MAAMmH,OAAO,GAAGuB,QAAQ,CAAC/E,iBAAiB,EAAE;KAE5C,OAAO,4CAAI,4BAAauE,UAAU,CAACC,sBAAU,CAACC,gBAAgB,EAAE;OAC/DC,OAAO,EAAE7B,MAAM;OACfS,OAAO,EAAE3B,IAAI;OACbgD,WAAW,EAAEpB,aAAa;OAC1BsB,OAAO,EAAEpD,UAAU,GAAG,GAAG,GAAG,GAAG;OAC/B6C,SAAS,EAAEd;MACX,CAAC;;GAkMHE,oBAAoB,CAACrB,MAA4C,EACjE;KACC,MAAM;OAAEtH,UAAU;OAAE4G;MAAM,GAAGU,MAAM;KAEnC,4CAAI,sCAAkBtH,UAAU,EAAE4G,IAAI;KACtC,4CAAI,wCAAmB5G,UAAU;;GA+DlCiK,qBAAqB,CAAC5F,MAAuB,EAC7C;KACC,MAAM6F,WAA0B,GAAG,CAAC,GAAG,4CAAI,wCAAmBC,IAAI,EAAE,CAAC;KAErE,OAAOD,WAAW,CAACE,IAAI,CAAEpK,UAAkB,IAAK;OAC/C,OAAO,IAAI,CAACuE,QAAQ,CAACvE,UAAU,CAAC,CAACqK,IAAI,CAAEvM,IAAkB,IAAK;SAC7D,OAAOA,IAAI,CAACM,KAAK,EAAE,KAAKiG,MAAM;QAC9B,CAAC;MACF,CAAC;;GAGHiG,sBAAsB,CAAC7D,OAAmF,EAC1G;KACC,MAAM;OAAEzG,UAAU;OAAEuK,QAAQ;OAAEC,gBAAgB,GAAG;MAAO,GAAG/D,OAAO;KAElE,MAAMD,KAAK,GAAG,4CAAI,wCAAmByB,GAAG,CAACjI,UAAU,CAAC,CAACuE,QAAQ,EAAE,CAAChB,MAAM,CAAEzF,IAAkB,IAAK;OAC9F,OAAOyM,QAAQ,CAACE,QAAQ,CAAC3M,IAAI,CAACM,KAAK,EAAE,CAAC;MACtC,CAAC;KAEFoI,KAAK,CAAC0B,OAAO,CAAEpK,IAAkB,IAAK;OACrCA,IAAI,CAACmB,MAAM,EAAE;OACbnB,IAAI,CAAC4M,KAAK,EAAE;MACZ,CAAC;KAEF,IAAIF,gBAAgB,EACpB;OACC,MAAM,CAACG,SAAS,CAAC,GAAG,IAAI,CAACpG,QAAQ,CAACvE,UAAU,CAAC;OAC7C,IAAI2K,SAAS,EACb;SACCA,SAAS,CAACC,MAAM,EAAE;QAClB,MAED;SACC,4CAAI,gCAAgB,KAAK;SACzB,4CAAI;;;;GAWP,MAAMC,KAAK,CAAC7K,UAAkB,EAC9B;KACC,MAAM2H,eAAe,GAAG,4CAAI,wCAAmBM,GAAG,CAACjI,UAAU,CAAC;KAC9D,MAAMuH,QAAQ,GAAGI,eAAe,CAACrG,aAAa,CAAC,UAAU,CAAC;KAC1D,MAAMsF,IAAI,GAAGe,eAAe,CAACrG,aAAa,CAAC,MAAM,CAAC;KAClD,MAAMkH,aAAa,GAAGb,eAAe,CAACrG,aAAa,CAAC,eAAe,CAAC;KAEpE,MAAMwJ,WAAwB,GAAGnD,eAAe,CAACtC,cAAc,EAAE;KAEjE,MAAM;OAAErF,UAAU,EAAE+K,aAAa;OAAEnD;MAAiB,GAAG,MAAM,IAAI,CAAC/D,QAAQ,CAAC;OAC1E0D,QAAQ;OACRf,KAAK,EAAEsE;MACP,CAAC;KAEF,KAAK,4CAAI,sBAAQlL,QAAQ,CAAC,0CAA0C,EAAE;OACrEoL,SAAS,EAAExC;MACX,CAAC;KAEF,MAAMZ,eAAe;KAErB,IAAI,CAACe,oBAAoB,CAAC;OACzB3I,UAAU,EAAE+K,aAAa;OACzBnE;MACA,CAAC;KAEF,4CAAI,sCAAkB5G,UAAU;;CAElC;CAAC,gCAjvBsBsH,MAA4B,EAKlD;GACC,MAAM;KACLC,QAAQ;KACRC,UAAU,GAAG,KAAK;KAClBd,UAAU,GAAG,KAAK;KAClBe,kBAAkB;KAClBC;IACA,GAAGJ,MAAM;GAEV,MAAMtH,UAAU,GAAG2G,qBAAK,CAACC,IAAI,CAACC,SAAS,EAAE;GACzC,MAAMiB,MAAM,2CAAG,IAAI,0BAAYP,QAAQ,CAAC;GACxC,MAAM0D,QAAQ,GAAG,MAAM,IAAI,CAAC9B,iBAAiB,CAAC5B,QAAQ,CAAC;GACvD,MAAMiB,aAAa,GAAG7B,qBAAK,CAACC,IAAI,CAACC,SAAS,EAAE;GAE5C,MAAMe,eAAe,GAAGhC,qBAAqB,EAAE;GAC/C,MAAMiC,iBAAiB,GAAGjC,qBAAqB,EAAE;GACjD,MAAMsF,qBAAqB,GAAG,EAAE;GAEhC,MAAMvD,eAAe,GAAG,IAAI7H,eAAe,CAAC;KAC3CE,UAAU;KACVC,eAAe,EAAE;OAChBuH,UAAU;OACVE,gBAAgB;OAChBD,kBAAkB;OAClB0D,iBAAiB,EAAE;SAClBF,QAAQ;SACRG,IAAI,EAAE;WACLtD,MAAM;WACNP;;;MAGF;KACDpH,UAAU,EAAE;OACX2H,MAAM;OACNP,QAAQ;OACRiB,aAAa;OACb9B;MACA;KACDxG,MAAM,EAAE;OACP,CAACJ,eAAe,CAAC8B,KAAK,CAACC,cAAc,GAAIH,KAAgB,IAAK;SAC7D,MAAM;WAAE5D;UAAM,GAAG4D,KAAK,CAACI,OAAO,EAAE;SAChC,4CAAI,oCAAiBhE,IAAI,EAAE4I,UAAU;QACrC;OACD,CAAC5G,eAAe,CAAC8B,KAAK,CAACU,kBAAkB,GAAIZ,KAAgB,IAAK;SACjE,MAAM;WAAE5D;UAA8B,GAAG4D,KAAK,CAACI,OAAO,EAAE;SAExD,IAAIhE,IAAI,CAAC8G,SAAS,EAAE,KAAKC,2BAAkB,CAACC,OAAO,EACnD;WACC,4CAAI,IAAI,8BAAchH,IAAI,GAC1B;aACC,4CAAI,wDAA2BA,IAAI,EAAE4I,UAAU;YAC/C,MAED;aACC,4CAAI,wDAA2B5I,IAAI,EAAE4I,UAAU;aAC/C,4CAAI,kDAAwB5I,IAAI,EAAEuN,oBAAQ,CAACvN,IAAI;aAC/CA,IAAI,CAACwN,mBAAmB,CAAC,IAAI,CAAC;aAC9BxN,IAAI,CAAC4F,aAAa,CAAC,YAAY,EAAE,IAAI,CAAC;;WAGvC,MAAM6H,MAAuB,GAAG7J,KAAK,CAAC8J,SAAS,EAAE;WAEjD,IAAID,MAAM,CAAC9G,YAAY,EAAE,EACzB;aACCmD,eAAe,CAACjJ,OAAO,EAAE;;;QAG3B;OACD,CAACmB,eAAe,CAAC8B,KAAK,CAACY,iBAAiB,GAAId,KAAgB,IAAK;SAChE,MAAM;WAAE5D;UAAM,GAAG4D,KAAK,CAACI,OAAO,EAAE;SAChC,4CAAI,kDAAwBhE,IAAI;SAChC,IAAI,CAAC6D,IAAI,CAACsE,gBAAgB,CAACvE,KAAK,CAAC+J,WAAW,CAAC;QAC7C;OACD,CAAC3L,eAAe,CAAC8B,KAAK,CAACc,oBAAoB,GAAIhB,KAAgB,IAAK;SACnE,MAAM;WAAE5D;UAAM,GAAG4D,KAAK,CAACI,OAAO,EAAE;SAChC,4CAAI,4CAAqBhE,IAAI,CAACM,KAAK,EAAE,EAAEN,IAAI,CAAC4N,WAAW,EAAE,EAAErN,sBAAU,CAACuM,MAAM;QAC5E;OACD,CAAC9K,eAAe,CAAC8B,KAAK,CAACgB,oBAAoB,GAAG,MAAOlB,KAAgB,IAAK;SACzE,MAAM;WAAE5D;UAAM,GAAG4D,KAAK,CAACI,OAAO,EAAE;SAChC,MAAM6J,YAAoB,GAAG7N,IAAI,CAACoH,eAAe,EAAE,CAACC,QAAQ,EAAE,CAACC,KAAK,CAAC,CAAC,CAAC;SACvE,MAAMyD,eAAuB,GAAG/K,IAAI,CAACM,KAAK,EAAE;SAC5C,4CAAI,IAAI,8BAAcN,IAAI,GAC1B;WACC,4CAAI,oCAAiB;aAAE6N,YAAY;aAAE9C;YAAiB;;SAGvD,4CAAI,4CAAqBA,eAAe,EAAE/K,IAAI,CAAC4N,WAAW,EAAE,EAAErN,sBAAU,CAACuN,IAAI;SAE7EV,qBAAqB,CAACW,IAAI,yCACzB,IAAI,kCAAgB/N,IAAI,EACxB;SAED,IAAI,CAAC6D,IAAI,CAACsE,gBAAgB,CAACvE,KAAK,CAACoK,cAAc,CAAC;QAChD;OACD,CAAChM,eAAe,CAAC8B,KAAK,CAACkB,iBAAiB,GAAIpB,KAAgB,IAAK;SAChE,MAAM;WAAEuH;UAAO,GAAGvH,KAAK,CAACI,OAAO,EAAE;SACjC,MAAMyJ,MAAM,GAAG7J,KAAK,CAAC8J,SAAS,EAAE;SAEhC,4CAAI,sCAAkBD,MAAM,CAACjK,aAAa,CAAC,eAAe,CAAC;SAE3DiK,MAAM,CAAChH,QAAQ,EAAE,CAAC2D,OAAO,CAAE6D,YAA0B,IAAK;WACzD,4CAAI,4CAAqBA,YAAY,CAAC3N,KAAK,EAAE,EAAE,CAAC,EAAEC,sBAAU,CAAC4K,KAAK;UAClE,CAAC;SAEF,4CAAI,IAAI,kDAAwBA,KAAK,GACrC;WACC+C,2BAAQ,CAAClO,IAAI,CAACmO,iBAAiB,CAAChD,KAAK,CAAC;;SAGvCiD,uBAAM,CAACjD,KAAK,CAAC,gCAAgC,EAAEA,KAAK,CAAC;SACrD,IAAI,CAACtH,IAAI,CAACsE,gBAAgB,CAACvE,KAAK,CAACyK,WAAW,CAAC;SAE7C,4CAAI,gCAAgB,KAAK;SACzB,4CAAI;SACJ,IAAI,CAAC3G,IAAI,CAACxF,UAAU,CAAC;QACrB;OACD,CAACF,eAAe,CAAC8B,KAAK,CAAC+D,kBAAkB,GAAIjE,KAAgB,IAAK;SACjE,MAAM;WAAEgH;UAAY,GAAGhH,KAAK,CAACI,OAAO,EAAE;SACtC,4CAAI,gCAAe0G,aAAa,EAAEE,UAAU;SAC5C,IAAI,CAAC/G,IAAI,CAACsE,gBAAgB,CAACvE,KAAK,CAAC0K,YAAY,CAAC;QAC9C;OACD,CAACtM,eAAe,CAAC8B,KAAK,CAACsB,gBAAgB,GAAG,MAAOxB,KAAgB,IAAK;SACrE,4CAAI,gCAAgB,KAAK;SACzB,4CAAI;SAEJ,MAAM6J,MAAuB,GAAG7J,KAAK,CAAC8J,SAAS,EAAE;SACjD,IAAID,MAAM,CAACxG,cAAc,EAAE,EAC3B;WACC,MAAMrG,OAAO,CAAC2N,GAAG,CAACnB,qBAAqB,CAAC;WACxCrD,iBAAiB,CAAClJ,OAAO,EAAE;WAC3B,MAAM,IAAI,CAACoL,aAAa,CAAC/J,UAAU,CAAC;WACpC,4CAAI,sCAAkBA,UAAU;;;;IAInC,CAAC;GAEF,OAAO;KACN2H,eAAe;KACfC,eAAe,EAAEA,eAAe,CAAC9B,OAAO;KACxC+B,iBAAiB,EAAEA,iBAAiB,CAAC/B;IACrC;CACF;CAAC,sBAgGW9F,UAAkB,EAC9B;GACC,4CAAI,kBAAQ6L,IAAI,CAAC7L,UAAU,CAAC;GAC5B,4CAAI;CACL;CAAC,0BAGD;GACC,IAAI,4CAAI,iCAAiB,4CAAI,kBAAQsM,MAAM,KAAK,CAAC,EACjD;KACC;;GAGD,4CAAI,gCAAgB,IAAI;GAExB,MAAMtM,UAAkB,GAAG,4CAAI,kBAAQuM,KAAK,EAAE;GAC9C,4CAAI,wCAAmBtE,GAAG,CAACjI,UAAU,CAAC,CAACsF,KAAK,EAAE;CAC/C;CAAC,kCA2CuB+C,eAAgC,EACxD;GACC,OAAO,4CAAI,sBAAQzI,QAAQ,CAAC,WAAW,EAAE;KACxCF,EAAE,EAAE2I,eAAe,CAACK,UAAU;KAC9BZ,MAAM,EAAEO,eAAe,CAACP,MAAM;KAC9B0E,QAAQ,EAAE7O,2BAAI,CAAC8O,SAAS,EAAE;KAC1BjN,IAAI,EAAE6I,eAAe,CAACvK,IAAI,CAAC0B,IAAI;KAC/B4D,IAAI,EAAEuD,qBAAK,CAAC7I,IAAI,CAAC4O,sBAAsB,CAACrE,eAAe,CAACvK,IAAI,CAAC6O,GAAG,CAAC;KACjEC,SAAS,EAAEvE,eAAe,CAACvK,IAAI,CAAC6O,GAAG;KACnCE,IAAI,EAAExE,eAAe,CAACvK,IAAI,CAACgP,OAAO;KAClCnN,MAAM,EAAEtB,sBAAU,CAACuN,IAAI;KACvBzD,QAAQ,EAAE,CAAC;KACX4E,UAAU,EAAE,4CAAI,sCAAmBvN;IACnC,CAAC;CACH;CAAC,uBAEY1B,IAAkB,EAC/B;GACC,OACCkP,iCAAgB,CAAClP,IAAI,CAACuB,SAAS,EAAE,CAAC,IAEjCvB,IAAI,CAACC,OAAO,EAAE,IACXyF,cAAI,CAACyJ,cAAc,CAACnP,IAAI,CAACoP,aAAa,EAAE,CAC3C;CAEH;CAAC,0BAEezG,OAAwD,EACxE;GACC,KAAK,4CAAI,sBAAQ7G,QAAQ,CAAC,+BAA+B,EAAE6G,OAAO,CAAC;CACpE;CAAC,+BAmBoBc,QAAgB,EACrC;GACC,OAAO,IAAI7I,OAAO,CAAC,CAACC,OAAO,EAAEkH,MAAM,KAAK;KACvC,4CAAI,0DAA6B,IAAI;KAErC,MAAMiC,MAAM,2CAAG,IAAI,0BAAYP,QAAQ,CAAC;KACxC,4CAAI,4BAAaiC,UAAU,CAACC,sBAAU,CAAC0D,eAAe,EAAE;OAAExD,OAAO,EAAE7B;MAAQ,CAAC,CAACQ,IAAI,CAAE8E,QAAQ,IAAK;OAC/F,MAAM;SAAEC,EAAE,EAAEC;QAAc,GAAGF,QAAQ,CAACG,IAAI,EAAE;OAC5C,4CAAI,0DAA6B,KAAK;OACtC,KAAK,4CAAI,sBAAQ3N,QAAQ,CAAC,cAAc,EAAE;SACzC2H,QAAQ;SACR1H,MAAM,EAAE;WACPyN;;QAED,CAAC;OACF3O,OAAO,CAAC2O,YAAY,CAAC;MACrB,CAAC,CAACtE,KAAK,CAAEC,KAAK,IAAK;OACnB,4CAAI,0DAA6B,KAAK;OACtCpD,MAAM,CAACoD,KAAK,CAAC;MACb,CAAC;IACF,CAAC;CACH;CAAC,+BAiDoBnL,IAAkB,EACvC;GACC,MAAM0P,WAAW,GAAG,4CAAI,8BAAc1P,IAAI,MAAMuN,oBAAQ,CAACoC,KAAK,IAAI3P,IAAI,CAACyD,UAAU,EAAE;GACnF,IAAI,CAACiM,WAAW,EAChB;KACC,OAAO9O,OAAO,CAACC,OAAO,EAAE;;GAGzB,MAAMe,EAAE,GAAG5B,IAAI,CAACoH,eAAe,EAAE,CAACC,QAAQ,EAAE,CAACC,KAAK,CAAC,CAAC,CAAC;GACrD,MAAMsI,WAAW,GAAG5P,IAAI,CAACmJ,gBAAgB,EAAE;GAC3C,IAAI,CAACyG,WAAW,EAChB;KACC5P,IAAI,CAAC4F,aAAa,CAAC,YAAY,EAAE,IAAI,CAAC;KAEtC,OAAOhF,OAAO,CAACC,OAAO,EAAE;;GAGzB,MAAMgP,QAAQ,GAAG,IAAIC,QAAQ,EAAE;GAC/BD,QAAQ,CAACE,MAAM,CAAC,IAAI,EAAEnO,EAAE,CAAC;GACzBiO,QAAQ,CAACE,MAAM,CAAC,aAAa,EAAEH,WAAW,EAAG,WAAU5P,IAAI,CAACgQ,OAAO,EAAG,MAAK,CAAC;GAE5E,OAAOC,wBAAS,CAACtE,sBAAU,CAACuE,uBAAuB,EAAE;KAAET,IAAI,EAAEI;IAAU,CAAC,CACtE3E,KAAK,CAAC,CAAC,CAACC,KAAK,CAAC,KAAK;KACnBC,OAAO,CAACD,KAAK,CAAC,uCAAuC,EAAEA,KAAK,CAAC;IAC7D,CAAC;CACJ;CAAC,8BAEmBvJ,EAAU,EAAEyI,QAAgB,EAAExI,MAAc,EAChE;GACC,KAAK,4CAAI,sBAAQC,QAAQ,CAAC,cAAc,EAAE;KACzCF,EAAE;KACFG,MAAM,EAAE;OACPsI,QAAQ,EAAGA,QAAQ,KAAK,GAAG,GAAG,EAAE,GAAGA,QAAS;OAC5CxI;;IAED,CAAC;CACH;CAAC,wBAEa6I,aAAqB,EAAEE,UAAU,EAC/C;GACC,MAAMH,OAAuB,GAAG,4CAAI,sBAAQ0F,OAAO,CAAC,kBAAkB,CAAC,CAACzF,aAAa,CAAC;GACtF,IAAID,OAAO,EACX;KACC,KAAK,4CAAI,sBAAQ3I,QAAQ,CAAC,iBAAiB,EAAE;OAAEF,EAAE,EAAE8I;MAAe,CAAC;KACnE,KAAK,4CAAI,sBAAQ5I,QAAQ,CAAC,cAAc,EAAE;OAAEF,EAAE,EAAEgJ;MAAY,CAAC;KAE7D,MAAM0C,IAAiB,GAAG,4CAAI,sBAAQ6C,OAAO,CAAC,mBAAmB,CAAC,CAAC1F,OAAO,CAACT,MAAM,CAAC;KAClF,MAAMoG,aAAqC,GAAG,4CAAI,sBAAQD,OAAO,CAAC,gCAAgC,CAAC,CAAC1F,OAAO,CAACT,MAAM,CAAC;KAEnH,IAAItE,cAAI,CAAC2K,QAAQ,CAACD,aAAa,CAAC,IAAI1K,cAAI,CAAC4K,QAAQ,CAACF,aAAa,CAAC,EAChE;OACC,KAAK,4CAAI,sBAAQtO,QAAQ,CAAC,eAAe,EAAE;SAC1CF,EAAE,EAAE0L,IAAI,CAAC7D,QAAQ;SACjB1H,MAAM,EAAE;WAAEmL,SAAS,EAAEkD;;QACrB,CAAC;MACF,MAED;OACC,KAAK,4CAAI,sBAAQtO,QAAQ,CAAC,eAAe,EAAE;SAC1CF,EAAE,EAAE0L,IAAI,CAAC7D;QACT,CAAC;;;CAGL;CAAC,uBAEYzJ,IAAkB,EAC/B;GACC,IAAIkP,iCAAgB,CAAClP,IAAI,CAACuB,SAAS,EAAE,CAAC,EACtC;KACC,OAAOgM,oBAAQ,CAACgD,KAAK;;GAGtB,IAAIvQ,IAAI,CAACC,OAAO,EAAE,EAClB;KACC,OAAOsN,oBAAQ,CAACoC,KAAK;;GAGtB,IAAI3P,IAAI,CAACwQ,OAAO,EAAE,CAACC,UAAU,CAAC,OAAO,CAAC,EACtC;KACC,OAAOlD,oBAAQ,CAACmD,KAAK;;GAGtB,OAAOnD,oBAAQ,CAACvN,IAAI;CACrB;CAAC,0BAEeA,IAAkB,EAAE4I,UAAmB,EACvD;GACC,MAAM+H,QAAQ,2CAAG,IAAI,8BAAc3Q,IAAI,CAAC;GACxC,MAAM4Q,WAAW,2CAAG,IAAI,qCAAkB;GAC1C,MAAMC,MAAM,GAAG,CAAC,CAACtD,oBAAQ,CAACgD,KAAK,EAAEhD,oBAAQ,CAACoC,KAAK,CAAC,CAAChD,QAAQ,CAACgE,QAAQ,CAAC;GAEnE,KAAK,4CAAI,sBAAQ7O,QAAQ,CAAC,WAAW,EAAE;KACtCF,EAAE,EAAE5B,IAAI,CAACM,KAAK,EAAE;KAChBoB,IAAI,EAAE1B,IAAI,CAACgQ,OAAO,EAAE;KACpBjB,IAAI,EAAE/O,IAAI,CAAC8Q,OAAO,EAAE;KACpBxL,IAAI,EAAEqL,QAAQ;KACd7B,SAAS,EAAE9O,IAAI,CAAC+Q,YAAY,EAAE;KAC9B/G,MAAM,EAAEhK,IAAI,CAACwD,aAAa,CAAC,QAAQ,CAAC;KACpCkL,QAAQ,EAAEkC,WAAW,CAAChP,EAAE;KACxBqN,UAAU,EAAE2B,WAAW,CAAClP,IAAI;KAC5BG,MAAM,EAAE7B,IAAI,CAACgR,QAAQ,EAAE,GAAGzQ,sBAAU,CAAC4K,KAAK,GAAG5K,sBAAU,CAACuN,IAAI;KAC5DzD,QAAQ,EAAE,CAAC;KACX4G,WAAW,EAAEjR,IAAI,CAACkR,cAAc,EAAE;KAClC,GAAG,CAAC,MAAM;OACT,IAAIL,MAAM,IAAIjI,UAAU,EACxB;SACC,OAAO;WAAE2H,KAAK,EAAE;UAAO;;OAGxB,OAAO,EAAE;MACT;IACD,CAAC;CACH;CAAC,oCAEyBvQ,IAAkB,EAAE4I,UAAmB,EACjE;GACC,KAAK,4CAAI,sBAAQ9G,QAAQ,CAAC,cAAc,EAAE;KACzCF,EAAE,EAAE5B,IAAI,CAACM,KAAK,EAAE;KAChByB,MAAM,EAAE;OACPoP,UAAU,EAAE,CAAC,MAAM;SAClB,IAAInR,IAAI,CAACoR,OAAO,EAAE,EAClB;WACC,OAAOpR,IAAI,CAACoP,aAAa,EAAE,IAAIpP,IAAI,CAACkR,cAAc,EAAE;;SAGrD,OAAOlR,IAAI,CAACoP,aAAa,EAAE;QAC3B,GAAG;OACJ,GAAG,CAAC,MAAM;SACT,IAAIxG,UAAU,EACd;WACC,OAAO;aAAE2H,KAAK,EAAE;YAAO;;SAGxB,OAAO;WACNA,KAAK,EAAE;aACNc,KAAK,EAAErR,IAAI,CAACsR,eAAe,EAAE;aAC7BC,MAAM,EAAEvR,IAAI,CAACwR,gBAAgB;;UAE9B;QACD;;IAEF,CAAC;CACH;CAAC,iCAEsBxR,IAAkB,EAAEsF,IAAY,EACvD;GACC,KAAK,4CAAI,sBAAQxD,QAAQ,CAAC,cAAc,EAAE;KACzCF,EAAE,EAAE5B,IAAI,CAACM,KAAK,EAAE;KAChByB,MAAM,EAAE;OACPuD;;IAED,CAAC;CACH;CAAC,iCAEsBtF,IAAkB,EACzC;GACC,KAAK,4CAAI,sBAAQ8B,QAAQ,CAAC,cAAc,EAAE;KACzCF,EAAE,EAAE5B,IAAI,CAACM,KAAK,EAAE;KAChByB,MAAM,EAAE;OACPgN,IAAI,EAAE/O,IAAI,CAAC8Q,OAAO;;IAEnB,CAAC;CACH;CAAC,2BAEgBrH,QAAgB,EACjC;GACC,OAAO,4CAAI,0BAAYA,QAAQ,EAAE+F,YAAY;CAC9C;CAAC,qBAEU/F,QAAgB,EAC3B;GACC,OAAO,4CAAI,sBAAQ0G,OAAO,CAAC,WAAW,CAAC,CAAC1G,QAAQ,CAAC;CAClD;CAAC,4BAGD;GACC,MAAMgI,MAAM,GAAG5R,2BAAI,CAAC8O,SAAS,EAAE;GAE/B,OAAO,4CAAI,sBAAQwB,OAAO,CAAC,WAAW,CAAC,CAACsB,MAAM,CAAC;CAChD;CAAC,qBAEUhI,QAAgB,EAC3B;GAAA;GACC,wEAAO,IAAI,0BAAYA,QAAQ,sBAAxB,sBAA2BO,MAAM;CACzC;CAAC,2BAEgB9H,UAAkB,EAAE4G,IAAY,EACjD;GACC,4CAAI,wCAAmBqB,GAAG,CAACjI,UAAU,CAAC,CAAC0D,aAAa,CAAC,MAAM,EAAEkD,IAAI,CAAC;CACnE;CAAC,kCAUuB5G,UAAU,EAClC;GACC,MAAMyI,OAAO,GAAG,EAAE;GAClB,MAAMjC,KAAK,GAAG,IAAI,CAACjC,QAAQ,CAACvE,UAAU,CAAC;GACvCwG,KAAK,CAAC0B,OAAO,CAAEpK,IAAI,IAAK;KACvB,IAAI,CAACA,IAAI,CAAC0R,QAAQ,EAAE,EACpB;OACC/G,OAAO,CAACoD,IAAI,CAAC/N,IAAI,CAACM,KAAK,EAAE,CAAC;;IAE3B,CAAC;GAEF,MAAMwI,IAAI,GAAG,4CAAI,wCAAmBqB,GAAG,CAACjI,UAAU,CAAC,CAACsB,aAAa,CAAC,MAAM,CAAC;GACzE,MAAMiG,QAAQ,GAAG,4CAAI,wCAAmBU,GAAG,CAACjI,UAAU,CAAC,CAACsB,aAAa,CAAC,UAAU,CAAC;GACjF,MAAMkH,aAAa,GAAG,4CAAI,wCAAmBP,GAAG,CAACjI,UAAU,CAAC,CAACsB,aAAa,CAAC,eAAe,CAAC;GAE3F,OAAO;KACNmH,OAAO;KACPD,aAAa;KACbjB,QAAQ;KACRX;IACA;CACF;CAAC,4BAEiB5G,UAAkB,EACpC;GACC,MAAMuI,OAAO,2CAAG,IAAI,oDAAyBvI,UAAU,CAAC;GACxD,KAAK,4CAAI,oCAAiB2I,oBAAoB,CAACJ,OAAO,CAAC;GACvD,IAAI,CAACjD,KAAK,CAACtF,UAAU,CAAC;CACvB;CAAC,+BAEoBlC,IAAkB,EAAEyJ,QAAgB,EACzD;GACC,MAAMiB,aAAa,GAAG7B,qBAAK,CAACC,IAAI,CAACC,SAAS,EAAE;GAC5C,MAAMiC,UAAU,GAAGhL,IAAI,CAAC4B,EAAE,CAAC0F,KAAK,CAAC,CAAC,CAAC,CAAC;GACpC,MAAMsD,UAAU,GAAI,GAAEF,aAAc,IAAGM,UAAW,EAAC;GAEnD,OAAO;KACNN,aAAa;KACbE,UAAU;KACVnB,QAAQ;KACRzJ,IAAI;KACJgK,MAAM,EAAE,4CAAI,0BAAYP,QAAQ,EAAEO;IAClC;CACF;CAAC,iCAEsBmB,KAAoB,EAC3C;GACC,OAAOA,KAAK,CAACwG,OAAO,EAAE,KAAK,wBAAwB;CACpD;CAAC,2BAEgBjH,aAAqB,EACtC;GACC,KAAK,4CAAI,sBAAQ5I,QAAQ,CAAC,iBAAiB,EAAE;KAC5CF,EAAE,EAAE8I,aAAa;KACjB3I,MAAM,EAAE;OACPoJ,KAAK,EAAE;;IAER,CAAC;CACH;CAAC,2BAyCgBjJ,UAAkB,EACnC;GACC,4CAAI,wCAAmBiI,GAAG,CAACjI,UAAU,CAAC,CAACyF,OAAO,EAAE;GAChD,4CAAI,wCAAmBiK,MAAM,CAAC1P,UAAU,CAAC;CAC1C;CA9vBYiG,gBAAgB,CASrBvE,KAAK,GAAG;GACd+J,WAAW,EAAE,aAAa;GAC1BK,cAAc,EAAE,gBAAgB;GAChCK,WAAW,EAAE,aAAa;GAC1BC,YAAY,EAAE;CACf,CAAC;CAdWnG,gBAAgB,CAmBrBE,QAAQ,GAAG,IAAI;;CC3BvB,MAAMwJ,8BAA8B,GAAG,EAAE;CACzC,MAAMC,eAAe,GAAG,GAAG;CAC3B,MAAMC,kBAAkB,GAAG,EAAE;CAC7B,MAAMC,oBAAoB,GAAG,CAAC;CAAC;CAAA;CAAA;AAE/B,CAAO,MAAMC,qBAAqB,CAClC;GAAA;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;;GACC,OAAOC,UAAU,CAAIvJ,OAA0B,EAC/C;KACC,MAAM;OACLD,KAAK;OACLyJ,SAAS,GAAGN,8BAA8B;OAC1CO,aAAa,GAAGN;MACG,GAAGnJ,OAAO;KAE9B,MAAM0J,MAAuB,GAAG,EAAE;KAClC,IAAI3M,cAAI,CAAC4M,OAAO,CAAC5J,KAAK,CAAC,EACvB;OACC,MAAM6J,aAAuB,GAAG7J,KAAK,CAACpB,KAAK,CAAC,CAAC,EAAE8K,aAAa,CAAC;OAC7D,KAAK,IAAII,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGD,aAAa,CAAC/D,MAAM,EAAEgE,CAAC,IAAIL,SAAS,EACxD;SACC,MAAMM,KAAK,GAAGF,aAAa,CAACjL,KAAK,CAACkL,CAAC,EAAEA,CAAC,GAAGL,SAAS,CAAC;SACnDE,MAAM,CAACtE,IAAI,CAAC0E,KAAK,CAAC;;;KAIpB,OAAOJ,MAAM;;GAGd,OAAOK,mBAAmB,CAAIL,MAAuB,EACrD;KACC,OAAOM,IAAI,CAACC,KAAK,CAACb,kBAAkB,GAAGM,MAAM,CAAC7D,MAAM,CAAC;;GAkBtD,MAAM1B,MAAM,CAAC;KAAEpE,KAAK;KAAEe,QAAQ;KAAEC,UAAU;KAAEd;IAA0B,EACtE;KACC,MAAMyJ,MAAM,GAAGJ,qBAAqB,CAACC,UAAU,CAAC;OAC/CxJ;MACA,CAAC;KAEF,MAAMmK,eAAsC,GAAG,MAAMjS,OAAO,CAAC2N,GAAG,CAC/D8D,MAAM,CAACnM,GAAG,CAAEuM,KAAkB,IAAK;OAClC,+CAAO,IAAI,wBAAW;SACrB/J,KAAK,EAAE+J,KAAK;SACZ7I,gBAAgB,EAAEqI,qBAAqB,CAACS,mBAAmB,CAACL,MAAM,CAAC;SACnE1I,kBAAkB,EAAEqI,oBAAoB;SACxCvI,QAAQ;SACRC,UAAU;SACVd;QACA;MACD,CAAC,CACF;KAED,MAAMkK,WAAmB,2CAAG,IAAI,2CAAqB;KACrD,MAAM1G,WAA0B,GAAG,EAAE;KACrC,MAAM2G,oBAAyC,GAAG,EAAE;KACpD,MAAMC,sBAA2C,GAAG,EAAE;KAEtDH,eAAe,CAACzI,OAAO,CAAC,CAAC;OAAElI,UAAU;OAAEgI,aAAa;OAAEJ,eAAe;OAAEC;MAAmB,KAAK;OAC9F,IAAIrE,cAAI,CAACuN,aAAa,CAAC/I,aAAa,CAAC,EACrC;SACCkC,WAAW,CAAC2B,IAAI,CAAC7L,UAAU,CAAC;SAC5B6Q,oBAAoB,CAAChF,IAAI,CAACjE,eAAe,CAAC;SAC1CkJ,sBAAsB,CAACjF,IAAI,CAAChE,iBAAiB,CAAC;;MAE/C,CAAC;KAEF,MAAMD,eAA6B,GAAGlJ,OAAO,CAAC2N,GAAG,CAACwE,oBAAoB,CAAC;KACvE,MAAMhJ,iBAA+B,GAAGnJ,OAAO,CAAC2N,GAAG,CAACyE,sBAAsB,CAAC;KAC3E,MAAME,gBAAwB,GAAGxK,KAAK,CAAC8F,MAAM;KAE7C,OAAO;OACNsE,WAAW;OACX1G,WAAW;OACX8G,gBAAgB;OAChBpJ,eAAe;OACfC;MACA;;CAEH;CAAC,iCA3DA;GACC,OAAO5B,gBAAgB,CAACC,WAAW,EAAE;CACtC;CAAC,+BAGD;GACC,OAAOS,qBAAK,CAACC,IAAI,CAACC,SAAS,EAAE;CAC9B;CAAC,0BAEeS,MAAyB,EACzC;GACC,OAAO,4CAAI,gDAAwBzD,QAAQ,CAACyD,MAAM,CAAC;CACpD;;;;;;;;;"}