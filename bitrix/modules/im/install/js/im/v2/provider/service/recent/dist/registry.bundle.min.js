this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,r,i,l,o,c){"use strict";var n=babelHelpers.classPrivateFieldLooseKey("restResult");var d=babelHelpers.classPrivateFieldLooseKey("withBirthdays");var h=babelHelpers.classPrivateFieldLooseKey("users");var b=babelHelpers.classPrivateFieldLooseKey("chats");var u=babelHelpers.classPrivateFieldLooseKey("messages");var v=babelHelpers.classPrivateFieldLooseKey("files");var p=babelHelpers.classPrivateFieldLooseKey("recentItems");var g=babelHelpers.classPrivateFieldLooseKey("extractUser");var P=babelHelpers.classPrivateFieldLooseKey("extractChat");var L=babelHelpers.classPrivateFieldLooseKey("extractMessage");var f=babelHelpers.classPrivateFieldLooseKey("extractRecentItem");var F=babelHelpers.classPrivateFieldLooseKey("extractBirthdayItems");var m=babelHelpers.classPrivateFieldLooseKey("prepareGroupChat");var y=babelHelpers.classPrivateFieldLooseKey("prepareChatForUser");var B=babelHelpers.classPrivateFieldLooseKey("prepareChatForAdditionalUser");var H=babelHelpers.classPrivateFieldLooseKey("getBirthdayPlaceholder");var I=babelHelpers.classPrivateFieldLooseKey("mergeFileIds");class M{constructor(e){Object.defineProperty(this,I,{value:T});Object.defineProperty(this,H,{value:E});Object.defineProperty(this,B,{value:D});Object.defineProperty(this,y,{value:K});Object.defineProperty(this,m,{value:j});Object.defineProperty(this,F,{value:S});Object.defineProperty(this,f,{value:w});Object.defineProperty(this,L,{value:R});Object.defineProperty(this,P,{value:O});Object.defineProperty(this,g,{value:C});Object.defineProperty(this,n,{writable:true,value:void 0});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,h,{writable:true,value:{}});Object.defineProperty(this,b,{writable:true,value:{}});Object.defineProperty(this,u,{writable:true,value:{}});Object.defineProperty(this,v,{writable:true,value:{}});Object.defineProperty(this,p,{writable:true,value:{}});const{rawData:s,withBirthdays:t=true}=e;babelHelpers.classPrivateFieldLooseBase(this,d)[d]=t;babelHelpers.classPrivateFieldLooseBase(this,n)[n]=s}getItems(){const{items:e=[],copilot:s,messagesAutoDeleteConfigs:t}=babelHelpers.classPrivateFieldLooseBase(this,n)[n];e.forEach((e=>{babelHelpers.classPrivateFieldLooseBase(this,g)[g](e);babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);babelHelpers.classPrivateFieldLooseBase(this,L)[L](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f](e)}));babelHelpers.classPrivateFieldLooseBase(this,F)[F]();return{users:Object.values(babelHelpers.classPrivateFieldLooseBase(this,h)[h]),chats:Object.values(babelHelpers.classPrivateFieldLooseBase(this,b)[b]),messages:Object.values(babelHelpers.classPrivateFieldLooseBase(this,u)[u]),files:Object.values(babelHelpers.classPrivateFieldLooseBase(this,v)[v]),recentItems:Object.values(babelHelpers.classPrivateFieldLooseBase(this,p)[p]),copilot:s,messagesAutoDeleteConfigs:t}}}function C(e){var s;if((s=e.user)!=null&&s.id&&!babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.user.id]=e.user}}function O(e){if(e.type===a.ChatType.chat){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]=babelHelpers.classPrivateFieldLooseBase(this,m)[m](e);if(e.user.id&&!babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,B)[B](e.user)}}else if(e.type===a.ChatType.user){const s=r.Core.getStore().getters["recent/get"](e.user.id);if(!s||!e.options.default_user_record){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.user.id]=babelHelpers.classPrivateFieldLooseBase(this,y)[y](e)}}}function R(e){const s=e.message;if(!s){return}if(s.id===0){s.id=`${a.FakeMessagePrefix}-${e.id}`}let i=false;if(s.status===a.MessageStatus.delivered){i=true}const l=r.Core.getStore().getters["messages/getById"](s.id);if(t.Type.isArrayFilled(l==null?void 0:l.attach)){delete s.attach}if(t.Type.isPlainObject(s.file)){const e=s.file;if(l){s.files=babelHelpers.classPrivateFieldLooseBase(this,I)[I](l,e.id)}else{s.files=[e.id]}const t=r.Core.getStore().getters["files/get"](e.id);if(!t){babelHelpers.classPrivateFieldLooseBase(this,v)[v][e.id]=e}}babelHelpers.classPrivateFieldLooseBase(this,u)[u][s.id]={...s,viewedByOthers:i}}function w(e){var s,t;const a=(s=(t=e.message)==null?void 0:t.id)!=null?s:0;babelHelpers.classPrivateFieldLooseBase(this,p)[p][e.id]={...e,messageId:a}}function S(){if(!babelHelpers.classPrivateFieldLooseBase(this,d)[d]){return}const{birthdayList:e=[]}=babelHelpers.classPrivateFieldLooseBase(this,n)[n];e.forEach((e=>{if(r.Core.getUserId()===e.id){return}if(!babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.id]){babelHelpers.classPrivateFieldLooseBase(this,h)[h][e.id]=e}if(!babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]){babelHelpers.classPrivateFieldLooseBase(this,b)[b][e.id]=babelHelpers.classPrivateFieldLooseBase(this,B)[B](e)}if(!babelHelpers.classPrivateFieldLooseBase(this,p)[p][e.id]){const s=`${a.FakeMessagePrefix}-${e.id}`;babelHelpers.classPrivateFieldLooseBase(this,p)[p][e.id]={...babelHelpers.classPrivateFieldLooseBase(this,H)[H](e),messageId:s};babelHelpers.classPrivateFieldLooseBase(this,u)[u][s]={id:s}}}))}function j(e){return{...e.chat,counter:e.counter,dialogId:e.id}}function K(e){return{chatId:e.chat_id,avatar:e.user.avatar,color:e.user.color,dialogId:e.id,name:e.user.name,type:a.ChatType.user,counter:e.counter,role:a.UserRole.member,backgroundId:e.chat.background_id,textFieldEnabled:e.chat.text_field_enabled,muteList:e.chat.mute_list}}function D(e){return{dialogId:e.id,avatar:e.avatar,color:e.color,name:e.name,type:a.ChatType.user,role:a.UserRole.member}}function E(e){return{id:e.id,isBirthdayPlaceholder:true}}function T(e,s){const t=e.files.map((e=>Number.parseInt(e,10)));const a=new Set([...t,s]);return[...a]}class A{constructor(){this.dataIsPreloaded=false;this.firstPageIsLoaded=false;this.itemsPerPage=50;this.isLoading=false;this.pagesLoaded=0;this.hasMoreItemsToLoad=true;this.lastMessageDate=null}static getInstance(){if(!this.instance){this.instance=new this}return this.instance}getCollection(){return r.Core.getStore().getters["recent/getRecentCollection"]}async loadFirstPage({ignorePreloadedItems:e=false}={}){if(this.dataIsPreloaded&&!e){l.Logger.warn("Im.RecentList: first page was preloaded");return Promise.resolve()}this.isLoading=true;const s=await this.requestItems({firstPage:true});this.firstPageIsLoaded=true;return s}loadNextPage(){if(this.isLoading||!this.hasMoreItemsToLoad){return Promise.resolve()}this.isLoading=true;return this.requestItems()}setPreloadedData(e){l.Logger.warn("Im.RecentList: setting preloaded data",e);const{items:s,hasMore:t}=e;this.lastMessageDate=this.getLastMessageDate(s);if(!t){this.hasMoreItemsToLoad=false}this.dataIsPreloaded=true;void this.updateModels(e)}hideChat(e){l.Logger.warn("Im.RecentList: hide chat",e);const t=r.Core.getStore().getters["recent/get"](e);if(!t){return}void r.Core.getStore().dispatch("recent/delete",{id:e});const i=r.Core.getStore().getters["application/isChatOpen"](e);if(i){s.LayoutManager.getInstance().clearCurrentLayoutEntityId();void s.LayoutManager.getInstance().deleteLastOpenedElementById(e)}r.Core.getRestClient().callMethod(a.RestMethod.imRecentHide,{DIALOG_ID:e}).catch((e=>{console.error("Im.RecentList: hide chat error",e.error())}))}async requestItems({firstPage:e=false}={}){const s=this.getQueryParams(e);const t=await r.Core.getRestClient().callMethod(a.RestMethod.imRecentList,s).catch((e=>{console.error("Im.RecentList: page request error",e.error())}));this.pagesLoaded++;l.Logger.warn(`Im.RecentList: ${e?"First":this.pagesLoaded} page request result`,t.data());const{items:i,hasMore:o}=t.data();this.lastMessageDate=this.getLastMessageDate(i);if(!o){this.hasMoreItemsToLoad=false}this.isLoading=false;return this.updateModels(t.data())}getQueryParams(e){return{SKIP_OPENLINES:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:e?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setRecent"}updateModels(e){const s=new M({rawData:e,...this.getExtractorOptions()});const t=s.getItems();const{users:a,chats:o,messages:c,files:n,recentItems:d,copilot:h,messagesAutoDeleteConfigs:b}=t;l.Logger.warn("LegacyRecentService: prepared data for models",t);const u=r.Core.getStore().dispatch("users/set",a);const v=r.Core.getStore().dispatch("chats/set",o);const p=r.Core.getStore().dispatch("chats/autoDelete/set",b);const g=r.Core.getStore().dispatch("messages/store",c);const P=r.Core.getStore().dispatch("files/set",n);const L=r.Core.getStore().dispatch(this.getModelSaveMethod(),d);const f=new i.CopilotManager;const F=f.handleRecentListResponse(h);return Promise.all([u,v,g,P,L,F,p])}getLastMessageDate(e){if(e.length===0){return""}return e.slice(-1)[0].message.date}getExtractorOptions(){return{}}}A.instance=null;var X=babelHelpers.classPrivateFieldLooseKey("itemsPerPage");var _=babelHelpers.classPrivateFieldLooseKey("isLoading");var x=babelHelpers.classPrivateFieldLooseKey("pagesLoaded");var N=babelHelpers.classPrivateFieldLooseKey("hasMoreItemsToLoad");var q=babelHelpers.classPrivateFieldLooseKey("lastMessageDate");var U=babelHelpers.classPrivateFieldLooseKey("requestItems");var $=babelHelpers.classPrivateFieldLooseKey("updateModels");var G=babelHelpers.classPrivateFieldLooseKey("getChatsWithCounters");var k=babelHelpers.classPrivateFieldLooseKey("getLastMessageDate");var Q=babelHelpers.classPrivateFieldLooseKey("filterPinnedItemsMessages");class Y{constructor(){Object.defineProperty(this,Q,{value:Z});Object.defineProperty(this,k,{value:V});Object.defineProperty(this,G,{value:J});Object.defineProperty(this,$,{value:z});Object.defineProperty(this,U,{value:W});Object.defineProperty(this,X,{writable:true,value:50});Object.defineProperty(this,_,{writable:true,value:false});Object.defineProperty(this,x,{writable:true,value:0});Object.defineProperty(this,N,{writable:true,value:true});Object.defineProperty(this,q,{writable:true,value:0})}loadFirstPage(){babelHelpers.classPrivateFieldLooseBase(this,_)[_]=true;return babelHelpers.classPrivateFieldLooseBase(this,U)[U]({firstPage:true})}loadNextPage(){if(babelHelpers.classPrivateFieldLooseBase(this,_)[_]||!babelHelpers.classPrivateFieldLooseBase(this,N)[N]){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,_)[_]=true;return babelHelpers.classPrivateFieldLooseBase(this,U)[U]()}hasMoreItemsToLoad(){return babelHelpers.classPrivateFieldLooseBase(this,N)[N]}getItemsPerPage(){return babelHelpers.classPrivateFieldLooseBase(this,X)[X]}getRestMethodName(){throw new Error('BaseRecentList: you should implement "getRestMethodName" for child class')}getRecentSaveActionName(){throw new Error('BaseRecentList: you should implement "getRecentSaveActionName" for child class')}getQueryParams(e=false){return{limit:this.getItemsPerPage(),filter:this.getRequestFilter(e)}}getRequestFilter(e=false){return{lastMessageDate:e?null:babelHelpers.classPrivateFieldLooseBase(this,q)[q]}}handlePaginationField(e){babelHelpers.classPrivateFieldLooseBase(this,q)[q]=babelHelpers.classPrivateFieldLooseBase(this,k)[k](e)}onAfterRequest(e){}}async function W({firstPage:e=false}={}){const s={data:this.getQueryParams(e)};const t=await o.runAction(this.getRestMethodName(),s).catch((([e])=>{console.error("BaseRecentList: page request error",e)}));babelHelpers.classPrivateFieldLooseBase(this,x)[x]++;l.Logger.warn(`BaseRecentList: ${e?"First":babelHelpers.classPrivateFieldLooseBase(this,x)[x]} page request result`,t);const{hasNextPage:a}=t;this.handlePaginationField(t);babelHelpers.classPrivateFieldLooseBase(this,N)[N]=a;babelHelpers.classPrivateFieldLooseBase(this,_)[_]=false;this.onAfterRequest(e);return babelHelpers.classPrivateFieldLooseBase(this,$)[$](t)}function z(e){const{users:s,chats:t,messages:a,files:l,recentItems:o,messagesAutoDeleteConfigs:n,copilot:d}=e;const h=babelHelpers.classPrivateFieldLooseBase(this,G)[G](t,o);const b=r.Core.getStore().dispatch("chats/set",h);const u=(new c.UserManager).setUsersToModel(s);const v=r.Core.getStore().dispatch("chats/autoDelete/set",n);const p=r.Core.getStore().dispatch("messages/store",a);const g=r.Core.getStore().dispatch("files/set",l);const P=r.Core.getStore().dispatch(this.getRecentSaveActionName(),o);const L=new i.CopilotManager;const f=L.handleRecentListResponse(d);return Promise.all([u,b,p,g,P,v,f])}function J(e,s){const t={};e.forEach((e=>{t[e.id]=e}));s.forEach((e=>{const{counter:s,chatId:a}=e;if(s===0){return}t[a]={...t[a],counter:s}}));return Object.values(t)}function V(e){const s=babelHelpers.classPrivateFieldLooseBase(this,Q)[Q](e);if(s.length===0){return""}let t=s[0].date;s.forEach((e=>{if(e.date<t){t=e.date}}));return t}function Z(e){const{messages:s,recentItems:t}=e;return s.filter((e=>{const s=e.chat_id;const a=t.find((e=>e.chatId===s));return a.pinned===false}))}e.LegacyRecentService=A;e.BaseRecentService=Y})(this.BX.Messenger.v2.Service=this.BX.Messenger.v2.Service||{},BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=registry.bundle.map.js