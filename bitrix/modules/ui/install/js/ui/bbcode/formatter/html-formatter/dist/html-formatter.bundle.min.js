this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};this.BX.UI.BBCode=this.BX.UI.BBCode||{};(function(e,t,r,o,a,n,s,i){"use strict";function l(e,t=1){const r=[];for(let o=0;o<t;o++){r.push(e.createElement({name:"p"}))}return r}function c(e){return e.getType()!==o.BBCodeNode.ELEMENT_NODE||e.hasGroup("#inline")||e.hasGroup("#inlineBlock")}function d(e,t){const r=[];let o=null;let a=0;for(const n of e){if(t.isNewLine(n)){a++;continue}if(c(n)){if(o===null||a>=2){r.push(...l(t,a-2));o=t.createElement({name:"p"});r.push(o)}else if(a===1){o.appendChild(t.createNewLine())}o.appendChild(n)}else{if(a>2){r.push(...l(t,a-2))}r.push(n);o=null}a=0}if(r.length===0){return[t.createElement({name:"p"})]}return r}function u(e){const t=e.getScheme();const r=d(e.getChildren(),t);e.setChildren(r);return e}let m=e=>e,p;class g extends n.NodeFormatter{constructor(e={}){super({name:"#root",convert(){return document.createDocumentFragment()},before({node:e}){return u(e)},after({element:e,formatter:t}){const r=t.getContainerMode();if(r==="void"||r==="collapsed"){const t=i.Tag.render(p||(p=m`<div class="ui-typography-container --${0}"></div>`),r);t.appendChild(e);return t}return e},...e})}}function h(e,t){let r=e;while(r!==null&&r.getType()!==o.BBCodeNode.ROOT_NODE){if(t(r)){return r}r=r.getParent()}return null}var f=babelHelpers.classPrivateFieldLooseKey("smileyParser");class y extends n.NodeFormatter{constructor(e={}){super({name:"#text",convert({node:e}){const r=e.toString({encode:false});if(h(e,(e=>e.getName()==="code"))){return document.createTextNode(r)}const o=babelHelpers.classPrivateFieldLooseBase(this,f)[f].parse(r);if(o.length===0){return document.createTextNode(r)}const a=document.createDocumentFragment();let n=0;for(const e of o){if(n<e.start){const t=document.createTextNode(r.slice(n,e.start));a.appendChild(t)}const o=r.slice(e.start,e.end);const s=t.SmileyManager.get(o);if(s===null){a.appendChild(document.createTextNode(o))}else{a.appendChild(this.createImg(s))}n=e.end}if(n<r.length){const e=document.createTextNode(r.slice(n));a.appendChild(e)}return a},...e});Object.defineProperty(this,f,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,f)[f]=new t.SmileyParser(t.SmileyManager.getAll())}createImg(e){const t=document.createElement("img");t.src=encodeURI(e.getImage());t.className="ui-typography-smiley";t.alt=e.getTyping();if(e.getWidth()>0&&e.getHeight()>0){t.width=e.getWidth();t.height=e.getHeight()}return t}}class b extends n.NodeFormatter{constructor(e={}){super({name:"#tab",convert({node:e}){if(e.getParent().getName()==="code"){return document.createTextNode(e.toString())}return document.createTextNode(" ")},...e})}}class N extends n.NodeFormatter{constructor(e={}){super({name:"#linebreak",convert({node:e}){return document.createElement("br")},...e})}}function v(e){const t=e.getScheme();e.appendChild(t.createNewLine());return e}class F extends n.NodeFormatter{constructor(e={}){super({name:"p",convert({node:e}){return i.Dom.create({tag:e.getName(),attrs:{className:"ui-typography-paragraph"}})},before({node:e}){return v(e)},...e})}}class T extends n.NodeFormatter{constructor(e={}){super({name:"b",convert({node:e}){return i.Dom.create({tag:"b",attrs:{...e.getAttributes(),className:"ui-typography-text-bold"}})},...e})}}class x extends n.NodeFormatter{constructor(e={}){super({name:"u",convert({node:e}){return i.Dom.create({tag:"u",attrs:{...e.getAttributes(),className:"ui-typography-text-underline"}})},...e})}}class A extends n.NodeFormatter{constructor(e={}){super({name:"i",convert({node:e}){return i.Dom.create({tag:"i",attrs:{...e.getAttributes(),className:"ui-typography-text-italic"}})},...e})}}class w extends n.NodeFormatter{constructor(e={}){super({name:"s",convert({node:e}){return i.Dom.create({tag:"s",attrs:{...e.getAttributes(),className:"ui-typography-text-strikethrough"}})},...e})}}class C extends n.NodeFormatter{constructor(e={}){super({name:"table",convert(){return i.Dom.create({tag:"table",attrs:{classname:"ui-typography-table"}})},...e})}}class S extends n.NodeFormatter{constructor(e={}){super({name:"th",convert(){return i.Dom.create({tag:"th",attrs:{classname:"ui-typography-table-cell ui-typography-table-cell-header"}})},before({node:e}){return u(e)},...e})}}class L extends n.NodeFormatter{constructor(e={}){super({name:"td",convert(){return i.Dom.create({tag:"td",attrs:{classname:"ui-typography-table-cell"}})},before({node:e}){return u(e)},...e})}}class B extends n.NodeFormatter{constructor(e={}){super({name:"tr",convert(){return i.Dom.create({tag:"tr",attrs:{classname:"ui-typography-table-row"}})},...e})}}class D extends n.NodeFormatter{constructor(e){super({name:"list",convert({node:e}){const t=e.getValue()==="1"?"ol":"ul";return i.Dom.create({tag:t,attrs:{...e.getAttributes(),className:`ui-typography-${t}`}})},...e})}}class I extends n.NodeFormatter{constructor(e){super({name:"*",convert({node:e}){const t=e.getChildren().some((e=>e.getName()==="list"));return i.Dom.create({tag:"li",attrs:{...e.getAttributes(),className:`ui-typography-li${t?" --nested":""}`}})},...e})}}class P extends n.NodeFormatter{constructor(e={}){super({name:"quote",convert(){return i.Dom.create({tag:"blockquote",attrs:{className:"ui-typography-quote"}})},before({node:e}){return u(e)},...e})}}var E=babelHelpers.classPrivateFieldLooseKey("codeParser");class M extends n.NodeFormatter{constructor(e={}){super({name:"code",before({node:e}){return v(e)},convert({node:e}){const t=e.getTextContent();return i.Dom.create({tag:"code",attrs:{className:"ui-typography-code"},dataset:{decorator:true},children:k(babelHelpers.classPrivateFieldLooseBase(this,E)[E].parse(t))})},...e});Object.defineProperty(this,E,{writable:true,value:new r.CodeParser})}}function k(e){const t=[];e.forEach((e=>{const r=e.content.split(/([\t\n])/);const o=r.length;for(let a=0;a<o;a++){const o=r[a];if(o==="\n"||o==="\r\n"){t.push(document.createElement("br"))}else if(o==="\t"){t.push(document.createTextNode("\t"))}else if(o.length>0){const r=document.createElement("span");r.className=`ui-typography-token-${e.type}`;r.textContent=o;t.push(r)}}}));return t}function H(e,t=true){if(t){return/^(http:|https:|mailto:|tel:|sms:|\/)/i.test(e)}return/^(http:|https:|mailto:|tel:|sms:)/i.test(e)}class O extends n.NodeFormatter{constructor(e={}){super({name:"url",validate({node:e}){const t=O.fetchNodeValue(e);return H(t)},before({node:e,formatter:t}){if(t.isShortLinkEnabled()){const r=e.getChildren().some((e=>e.getName()==="img"));if(!r){const r=e.getScheme();const o=e.getPlainTextLength();const{shortLink:a}=t.getLinkSettings();if(o>a.maxLength){const t=O.fetchNodeValue(e);const o=r.createRoot({children:e.getChildren()});const[n,s]=o.split({offset:a.maxLength-a.lastFragmentLength});const i=s.getPlainTextLength();const l=e.clone();l.setValue(t);if(i>a.lastFragmentLength){l.appendChild(...n.getChildren(),r.createText("..."));const[,e]=s.split({offset:i-a.lastFragmentLength});l.appendChild(...e.getChildren());return l}l.setChildren([...n.getChildren(),r.createText("..."),...s.getChildren()]);return l}}}return e},convert({node:e,formatter:t}){const r=(()=>{const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.getContent()})();const o=e.getAttributes();const{defaultTarget:a="_blank",attributes:n}=t.getLinkSettings();return i.Dom.create({tag:"a",attrs:{...o,...n,href:r,target:a,className:"ui-typography-link"}})},...e})}static fetchNodeValue(e){const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.toPlainText()}}class V extends n.NodeFormatter{constructor(e={}){super({name:"spoiler",convert({node:e}){const t=e.getValue().trim();const r=i.Type.isStringFilled(t)?t:i.Loc.getMessage("HTML_FORMATTER_SPOILER_TITLE");return i.Dom.create({tag:"details",attrs:{className:"ui-typography-spoiler ui-icon-set__scope"},children:[i.Dom.create({tag:"summary",attrs:{className:"ui-typography-spoiler-title"},text:r})]})},before({node:e}){return u(e)},after({element:e}){const[t,...r]=e.children;e.appendChild(t);e.appendChild(i.Dom.create({tag:"div",attrs:{className:"ui-typography-spoiler-content"},dataset:{spoilerContent:"true"},children:[...r]}));return e},...e})}}class j extends n.NodeFormatter{constructor(e){super({name:"user",convert({node:e,formatter:t}){var r;const o=t.getMentionSettings();if(i.Type.isStringFilled(o==null?void 0:(r=o.urlTemplate)==null?void 0:r.user)){const t=o.urlTemplate.user;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})},...e})}}class U extends n.NodeFormatter{constructor(e={}){super({name:"department",convert({node:e,formatter:t}){var r;const o=t.getMentionSettings();if(i.Type.isStringFilled(o==null?void 0:(r=o.urlTemplate)==null?void 0:r.department)){const t=o.urlTemplate.department;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})},...e})}}class _ extends n.NodeFormatter{constructor(e={}){super({name:"project",convert({node:e,formatter:t}){var r;const o=t.getMentionSettings();if(i.Type.isStringFilled(o==null?void 0:(r=o.urlTemplate)==null?void 0:r.project)){const t=o.urlTemplate.project;const r=t.replaceAll("#group_id#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})},...e})}}function $({src:e,width:t,height:r,viewerAttrs:o={}}){return i.Dom.create({tag:"span",attrs:{className:"ui-typography-image-container"},dataset:{decorator:true,...o},children:[i.Dom.create({tag:"img",attrs:{src:e,className:"ui-typography-image",width:t,loading:"lazy"},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"},events:{error:e=>{const t=e.target;t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";i.Dom.addClass(t.parentNode,"--error ui-icon-set__scope")}}})]})}function R(e){return/^(http:|https:|ftp:|\/)/i.test(e)}class X extends n.NodeFormatter{constructor(e={}){super({name:"img",convert({node:e}){const t=e.getContent().trim();let r=Number(e.getAttribute("width"));let o=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):null;o=i.Type.isNumber(o)&&o>0?Math.round(o):null;if(R(t)){return $({src:t,width:r,height:o})}return document.createTextNode(e.toString())},...e})}}function K({url:e,width:t,height:r,viewerAttrs:o={},type:a}){const n=i.Dom.create({tag:"video",attrs:{controls:true,className:"ui-typography-video-object",preload:"metadata",playsinline:true,src:e,width:t},dataset:{decorator:true},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true,...o},children:[n]})}const G=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g;const z=/^(?:(?:https?|ftps?|mailto):|[^a-z]|[+.a-z-]+(?:[^+.:a-z-]|$))/i;function q(e){if(!i.Type.isStringFilled(e)){return""}const t=e.replaceAll(G,"");return z.test(t)?t:""}function W(e){return/^(http:|https:|\/)/i.test(e)}class Q extends n.NodeFormatter{constructor(e={}){super({name:"video",convert({node:e}){const t=q(e.getContent().trim());if(!W(t)){return document.createTextNode(e.toString())}let r=Number(e.getAttribute("width"));let o=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):560;o=i.Type.isNumber(o)&&o>0?Math.round(o):315;const n=/^https?:/.test(t)?t:`https://${t.replace(/^\/\//,"")}`;const s=new i.Uri(n);const l=a.VideoService.createByHost(s.getHost())!==null;if(l){const e=i.Dom.create({tag:"iframe",attrs:{src:t,className:"ui-typography-video-object",width:r,height:"auto",frameborder:0,allowfullscreen:true},style:{aspectRatio:`${r} / ${o}`}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[e]})}return K({url:n,width:r,height:o})},...e})}}class J extends n.NodeFormatter{constructor(e={}){const t=e.formatter;const r=t.getFileMode();const o=i.Text.getRandom();super({name:r||"__unknown__",convert({node:e,data:t}){var a;if(r===null){return e}const n=e.getAttribute("id");const s=()=>document.createTextNode(e.toString());if(!i.Type.isStringFilled(n)||r==="disk"&&!/^n?\d+$/i.test(n)||r==="file"&&!/^(\d+|[\da-f-]{36}\.[\da-f]{32,})$/i.test(n)){return s()}const l=t==null?void 0:(a=t.files)==null?void 0:a.find((e=>{var t;return e.serverFileId.toString()===n.toString()||`n${(t=e.customData)==null?void 0:t.objectId.toString()}`===n.toString()}));if(!l){return s()}const c=i.Type.isPlainObject(l.viewerAttrs);const d=c?{...l.viewerAttrs}:{};if(c&&!i.Type.isStringFilled(d.viewerGroupBy)&&i.Type.isUndefined(d.viewerSeparateItem)){d.viewerGroupBy=o}if(l.isImage){let t=i.Text.toInteger(e.getAttribute("width"));let r=i.Text.toInteger(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):l.serverPreviewWidth;r=i.Type.isNumber(r)&&r>0?Math.round(r):l.serverPreviewHeight;return $({width:t,height:r,src:l.serverPreviewUrl,viewerAttrs:d})}if(l.isVideo){let t=Number(e.getAttribute("width"));let r=Number(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):600;r=i.Type.isNumber(r)&&r>0?Math.round(r):null;return K({url:l.downloadUrl,viewerAttrs:d,width:t,height:r})}return i.Dom.create({tag:"a",attrs:{href:l.downloadUrl,className:"ui-typography-link"},text:l.name||"unknown",dataset:{fileId:l.serverFileId,fileInfo:JSON.stringify(l),...d}})},...e})}}var Y=Object.freeze({RootNodeFormatter:g,TextNodeFormatter:y,TabNodeFormatter:b,LinebreakNodeFormatter:N,ParagraphNodeFormatter:F,BoldNodeFormatter:T,UnderlineNodeFormatter:x,ItalicNodeFormatter:A,StrikethroughNodeFormatter:w,TableNodeFormatter:C,TableHeadCellNodeFormatter:S,TableDataCellNodeFormatter:L,TableRowNodeFormatter:B,ListNodeFormatter:D,ListItemNodeFormatter:I,QuoteNodeFormatter:P,CodeNodeFormatter:M,LinkNodeFormatter:O,SpoilerNodeFormatter:V,UserNodeFormatter:j,DepartmentNodeFormatter:U,ProjectNodeFormatter:_,ImageNodeFormatter:X,VideoNodeFormatter:Q,FileNodeFormatter:J});const Z=i.Extension.getSettings("ui.bbcode.formatter.html-formatter");var ee=babelHelpers.classPrivateFieldLooseKey("linkSettings");var te=babelHelpers.classPrivateFieldLooseKey("mentionSettings");var re=babelHelpers.classPrivateFieldLooseKey("fileMode");var oe=babelHelpers.classPrivateFieldLooseKey("containerMode");var ae=babelHelpers.classPrivateFieldLooseKey("isVoidElement");class ne extends n.Formatter{constructor(e={}){super();Object.defineProperty(this,ae,{value:se});Object.defineProperty(this,ee,{writable:true,value:void 0});Object.defineProperty(this,te,{writable:true,value:void 0});Object.defineProperty(this,re,{writable:true,value:void 0});Object.defineProperty(this,oe,{writable:true,value:void 0});this.setLinkSettings({...Z.linkSettings,...e.linkSettings});this.setMentionSettings({...Z.mention,...e.mention});babelHelpers.classPrivateFieldLooseBase(this,re)[re]=["file","disk"].includes(e.fileMode)?e.fileMode:null;const t=Object.values(Y).map((e=>new e({formatter:this})));this.setContainerMode(e.containerMode);this.setNodeFormatters(t);this.setNodeFormatters(e.formatters)}isShortLinkEnabled(){const{shortLink:e}=this.getLinkSettings();return i.Type.isPlainObject(e)&&e.enabled===true&&i.Type.isInteger(e.maxLength)}setLinkSettings(e){babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]={...e}}getLinkSettings(){return babelHelpers.classPrivateFieldLooseBase(this,ee)[ee]}getFileMode(){return babelHelpers.classPrivateFieldLooseBase(this,re)[re]}setMentionSettings(e){babelHelpers.classPrivateFieldLooseBase(this,te)[te]={...e}}getMentionSettings(){return babelHelpers.classPrivateFieldLooseBase(this,te)[te]}setContainerMode(e){babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]=e}getContainerMode(){return babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]}isElement(e){if(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE){return true}if(e.nodeType!==Node.ELEMENT_NODE||babelHelpers.classPrivateFieldLooseBase(this,ae)[ae](e)){return false}return i.Type.isUndefined(e.dataset.decorator)}getDefaultUnknownNodeCallback(e){return()=>new n.NodeFormatter({name:"unknown",before({node:e}){const t=e.getScheme();if(e.isVoid()){return t.createFragment({children:[t.createText(e.getOpeningTag())]})}return t.createFragment({children:[t.createText(e.getOpeningTag()),...e.getChildren(),t.createText(e.getClosingTag())]})},convert(){return document.createDocumentFragment()}})}}function se(e){return["img","br","hr","input"].includes(e.tagName.toLowerCase())}const ie={props:{bbcode:{type:String,default:""},options:{type:Object,default:undefined},formatData:{type:Object,default:()=>({})}},beforeCreate(){this.htmlFormatter=null},mounted(){this.format()},unmounted(){this.htmlFormatter=null},watch:{bbcode(){this.format()},formatData(){this.format()}},methods:{format(){const e=this.getHtmlFormatter().format({source:this.bbcode,data:this.formatData});i.Dom.clean(this.$el);i.Dom.append(e,this.$el)},getHtmlFormatter(){var e;(e=this.htmlFormatter)!=null?e:this.htmlFormatter=new ne(this.options);return this.htmlFormatter}},template:`\n\t\t<div class="ui-typography-container"></div>\n\t`};e.HtmlFormatter=ne;e.HtmlFormatterComponent=ie})(this.BX.UI.BBCode.Formatter=this.BX.UI.BBCode.Formatter||{},BX.UI.Smiley,BX.UI.CodeParser,BX.UI.BBCode,BX.UI.VideoService,BX.UI.BBCode,window,BX);
//# sourceMappingURL=html-formatter.bundle.map.js