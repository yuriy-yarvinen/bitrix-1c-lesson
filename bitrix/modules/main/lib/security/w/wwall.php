<? namespace Bitrix\Main\Security\W;$GLOBALS['____1427417536']= array(base64_decode('dGlt'.'ZQ='.'='),base64_decode('dGltZQ=='),base64_decode(''.'an'.'Nvbl9kZWN'.'vZGU='),base64_decode('YXJ'.'y'.'YXl'.'fbWV'.'yZ'.'2U='),base64_decode('am9pbg=='),base64_decode(''.'am9pbg=='),base64_decode('am9pbg'.'=='),base64_decode('YXJyYXlfcG9w'),base64_decode('YXJyYXlfc2'.'hpZ'.'nQ='),base64_decode('YX'.'Jy'.'YX'.'lfc2'.'hpZn'.'Q='),base64_decode('YXJyY'.'Xlfc2h'.'pZnQ='),base64_decode('Y'.'X'.'JyYXlfc2h'.'pZn'.'Q='),base64_decode(''.'YXJy'.'YXlfbWVy'.'Z'.'2U='),base64_decode('aXNfYXJy'.'Y'.'Xk'.'='),base64_decode('YX'.'JyYXlfbW'.'Vy'.'Z2U='),base64_decode('aW5fYXJyYXk='),base64_decode('aW5fYXJy'.'YXk'.'='),base64_decode('aW5fYXJyYX'.'k'.'='),base64_decode('aW'.'5'.'f'.'YXJy'.'Y'.'Xk='),base64_decode('aW5fYXJy'.'YXk='),base64_decode('dGltZ'.'Q'.'=='),base64_decode('dGltZ'.'Q'.'=='),base64_decode(''.'YXJy'.'Y'.'XlfbW'.'Fw'),base64_decode('Z2V'.'0'.'X2'.'x'.'vYW'.'RlZ'.'F'.'9le'.'HRlbnNpb25'.'z'),base64_decode(''.'a'.'nN'.'vbl9'.'lbmNvZG'.'U'.'='),base64_decode(''.'anNvb'.'l9lbm'.'NvZGU'.'='),base64_decode('cGhwd'.'mVyc2lvbg=='),base64_decode('anNvbl'.'9lbmNvZGU'.'='),base64_decode('a'.'m9pbg=='));if(!function_exists(__NAMESPACE__.'\\___584183675')){function ___584183675($_2118789772){static $_2080006042= false; if($_2080006042 == false) $_2080006042=array('V1'.'dBTE'.'xf'.'TE9DSw==','c2'.'VjdXJp'.'d'.'Hk=','REF'.'UQQ==','e'.'yI=',''.'V1dB'.'TE'.'xfTE9D'.'Sw='.'=',''.'c'.'2VjdX'.'Jp'.'d'.'Hk=',''.'U'.'0'.'VD'.'VVJ'.'JV'.'F'.'lfV'.'1dBT'.'ExfRVhDRV'.'BUSU9O',''.'RkFJTF9D'.'S'.'EVDS0lOR'.'w==','Q2FuI'.'G5vdCBleGVjd'.'XRlIH'.'d3'.'YWxs'.'IH'.'J1bGVzOiA=',''.'I'.'FR'.'yYWN'.'l'.'OiA=',''.'UkVR'.'VUVTVF9VUk'.'k=','a2V5cw==','dmFsd'.'WVz','U0VDVVJJVFl'.'fV1dB'.'TExfTU'.'9ESUZ'.'Z','Lg==',''.'U0VDVVJJV'.'F'.'lfV1dBTExf'.'VU5'.'TR'.'VQ=',''.'Lg==','U0V'.'DVVJJV'.'FlfV1dBTE'.'xf'.'RVh'.'JVA==','Lg==','Z2'.'xvYmFs','a2V5cw'.'==','dmFs'.'dWVz','Z2V'.'0',''.'Z2V0','c'.'G9zdA==','cG9zdA='.'=','Y29va2ll','Y2'.'9va2ll','cmV'.'xd'.'W'.'VzdA==',''.'cmV'.'xdWVz'.'dA==','Z2xvYmFs','Z2'.'xv'.'Ym'.'Fs','bWFpb'.'l9'.'zZWM=','V1dBT'.'ExfQUNUVUFM'.'SVpF'.'X1JVTE'.'VT','dg==','dmVyc2lv'.'bg'.'==',''.'aQ==','aX'.'NJbnN0YWxsZWQ=','dg==',''.'aW5p','bW'.'9kdWxlcw==',''.'bG'.'lj'.'ZW'.'5zZQ='.'=','cGhw','dg==','ZXh0','c2'.'V'.'jdX'.'JpdHk'.'=','ZG'.'I=','d'.'Hlw'.'ZQ==','ZGI=','dmVy'.'c2lvbg='.'=','Z'.'GI=','d'.'Hl'.'wZQ==',''.'ZGI'.'=','dHlwZQ==',''.'dmV'.'yc'.'2lvbg==',''.'ZGI'.'=','dmVyc2l'.'vb'.'g='.'=','Z'.'W5'.'2'.'aXJvbm1lbnQ=','dm1fdm'.'Vyc'.'2l'.'vbg==',''.'dm0=','dg==',''.'ZW52aXJvb'.'m1lbnQ=','d'.'m1'.'fdm'.'V'.'yc2'.'lvb'.'g'.'==','c'.'29j'.'a2V0VGltZW'.'91dA'.'==',''.'c3RyZWFtV'.'Glt'.'ZW91'.'dA==','KCc=',''.'Z'.'GF0YQ==','Jyw'.'gJw==','bW9'.'kd'.'Wxl','Jy'.'wg'.'Jw'.'='.'=','bW'.'9k'.'dWxlX3Z'.'lcnNpb24=','Jyk'.'=','LCA=','U0VDV'.'V'.'JJVF'.'lfV1d'.'BT'.'ExfRVh'.'DRVBUSU9O','bWFpbg==',''.'R'.'kFJT'.'F9S'.'RUZ'.'SRVNISU5H','Q2'.'FuI'.'G5vd'.'C'.'ByZWZ'.'yZ'.'XNo'.'IHd3YWx'.'sIHJ'.'1bGVz'.'OiA=','I'.'FRyYWNlOi'.'A=','ZGF0YQ==','eyI'.'=','LS0tLS'.'1CRUdJT'.'iBQVU'.'JMSU'.'M'.'gS'.'0VZ'.'LS0tLS0=','Ck1JSU'.'JJakFO'.'Q'.'md'.'rcW'.'h'.'r'.'aU'.'c5d'.'z'.'BCQVFFRkFB'.'T0'.'NBUThBTUlJ'.'QkN'.'nS0NBUUVBcThRRTBIam'.'1IS'.'lVTdFd'.'W'.'Nm4wemEKUl'.'Zv'.'THgw'.'Mkt6YmZyYlM'.'vUDZz'.'V2F'.'4VHp3OF'.'NlR'.'1R0Yl'.'RDT3J'.'wSGk1UU'.'Y2T'.'1'.'J5al'.'ov'.'WHh6L'.'0tMVTFH'.'Ym'.'9mOU'.'N'.'a'.'Mwo0ejdT'.'a3'.'F'.'VdD'.'Y'.'2aWJYdk'.'9GQng0Zn'.'cvQVBQUk'.'dEc'.'XR'.'tMG'.'5EM2'.'Z'.'nR3'.'N1M'.'1J'.'lUG'.'d3'.'Mj'.'lpOC'.'t2bT'.'dtdEJ'.'LSlVZb'.'DRyClZwYjZzZlpFVDlL'.'RWI2VD'.'FIRFltRX'.'ZjM'.'Wh'.'xL2'.'lp'.'d'.'Xl4T'.'H'.'JaWmk1UTZ'.'VZmY0VUV2VEkrNj'.'hzc0'.'Z'.'Sa1Erb3dUU'.'nkKZU9'.'JTWJGa'.'E'.'0vVVRtZl'.'ZZYlRSRnkyb1VROFdNem'.'Ey'.'bko1U2FoemkxVU'.'tP'.'M'.'WpB'.'alhUUFJy'.'e'.'mM3QWp1Nj'.'M5'.'ajFP'.'MApwcHF'.'mbTV'.'4'.'Z1ds'.'Rk'.'F'.'Ka0hRVG'.'diZ'.'GQ1Q'.'V'.'dxR'.'EZRa3Q'.'5S'.'Et'.'rW'.'StUbm'.'ZCTEd'.'W'.'TX'.'ZW'.'eVB3VE'.'hO'.'V1'.'FZQX'.'c0e'.'H'.'BnL3dBC'.'l'.'p3SURBUUF'.'C'.'C'.'i0'.'tLS0tR'.'U5EIF'.'BVQk'.'xJQ'.'yBL'.'RV'.'k'.'tLS0tLQ==');return base64_decode($_2080006042[$_2118789772]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_1807789087= true; public function handle(){ try{  $_929737526= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_929737526)){ return;}  $_1595641068= Cache::createInstance(); $_817381820= false; if($_1595641068->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_968095447= $_1595641068->getVars(); if($GLOBALS['____1427417536'][0]()- $_968095447> round(0+5+5+5+5)){  $_1189057113= Application::getConnection(); $_1618869310= RuleRecordTable::getTableName(); $_1189057113->truncateTable($_1618869310); RuleRecordTable::cleanCache(); $_1595641068->clean(___584183675(0), ___584183675(1));}} elseif($_1595641068->startDataCache()){  $_1595641068->endDataCache($GLOBALS['____1427417536'][1]()); $_817381820= true;} foreach($_929737526 as $_1929337884){ $_544206107= new PublicKeyCipher; $_484967329= $_544206107->decrypt($_1929337884[___584183675(2)], static::__763193910()); if(!str_starts_with($_484967329, ___584183675(3))){ continue;} $_408379206= $GLOBALS['____1427417536'][2]($_484967329, true); if(!empty($_408379206)){ $_1223605099= Rule::make($_408379206); $_337161660= $this->handleRule($_1223605099); $this->applyHandlingResults($_337161660);}}  if($_817381820){ $_1595641068->clean(___584183675(4), ___584183675(5));}} catch(\Throwable $_1716080229){ $this->logEvent( ___584183675(6), ___584183675(7), ___584183675(8). $_1716080229->getMessage(). ___584183675(9). $_1716080229->getTraceAsString());}}  public function handleRule(Rule $_1223605099): array{ $_337161660=[]; if($_1223605099->matchPath($_SERVER[___584183675(10)])){  $_1525272485= $this->getContextElements($_1223605099->getContext()); foreach($_1525272485 as $_525544668 => &$_1884293247){ $_337161660= $GLOBALS['____1427417536'][3]($_337161660, $this->recursiveContextKeyHandle($_525544668, $_1884293247,[], $_1223605099));}} return $_337161660;}  public function applyHandlingResults(array $_337161660){ $_1525272485= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_337161660 as $_419873332){ $_1884293247=& $_1525272485[$_419873332->getContextName()]; $_1611683428= $_419873332->getRuleResult(); $_1223605099= $_419873332->getRule(); if($_1611683428 instanceof ModifyResult){ if($_1223605099->getProcess() === ___584183675(11)){  static::rewriteContextKey( $_419873332->getContextName(), $_1884293247, $_419873332->getContextKey(), $_1611683428->getCleanValue());} elseif($_1223605099->getProcess() === ___584183675(12)){ static::rewriteContextValue( $_419873332->getContextName(), $_1884293247, $_419873332->getContextKey(), $_1611683428->getCleanValue());} $this->logEvent( ___584183675(13), $_419873332->getContextName(), $GLOBALS['____1427417536'][4](___584183675(14), $_419873332->getContextKey()));} elseif($_1611683428 instanceof CheckResult &&!$_1611683428->isSuccess()){ if($_1611683428->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_419873332->getContextName(), $_1884293247, $_419873332->getContextKey(),); $this->logEvent( ___584183675(15), $_419873332->getContextName(), $GLOBALS['____1427417536'][5](___584183675(16), $_419873332->getContextKey()));} elseif($_1611683428->getAction() === RuleAction::EXIT){ $this->logEvent( ___584183675(17), $_419873332->getContextName(), $GLOBALS['____1427417536'][6](___584183675(18), $_419873332->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1807789087= false;} protected function rewriteContextKey($_525544668, &$_1884293247, $_79772984, $_854310160){ $_1153584187= $_79772984;  $GLOBALS['____1427417536'][7]($_1153584187); $_1153584187[]= $_854310160; if($_525544668 === ___584183675(19)){ $_1303730669= $GLOBALS['____1427417536'][8]($_79772984); $GLOBALS['____1427417536'][9]($_1153584187); if(empty($_79772984)){ $GLOBALS[$_854310160]= $GLOBALS[$_1303730669]; unset($GLOBALS[$_1303730669]);} else{ $_1884293247=& $GLOBALS[$_1303730669]; $_1283784047= ArrayHelper::getByNestedKey($_1884293247, $_79772984);  ArrayHelper::setByNestedKey($_1884293247, $_1153584187, $_1283784047);  ArrayHelper::unsetByNestedKey($_1884293247, $_79772984);}} else{ $_1283784047= ArrayHelper::getByNestedKey($_1884293247, $_79772984);  ArrayHelper::setByNestedKey($_1884293247, $_1153584187, $_1283784047);  ArrayHelper::unsetByNestedKey($_1884293247, $_79772984);}} protected function rewriteContextValue($_525544668, &$_1884293247, $_1952888803, $_1283784047){ if($_525544668 === 'global'){ $_1303730669= $GLOBALS['____1427417536'][10]($_1952888803); if(empty($_1952888803)){ $GLOBALS[$_1303730669]= $_1283784047;} else{ $_1884293247=& $GLOBALS[$_1303730669]; ArrayHelper::setByNestedKey($_1884293247, $_1952888803, $_1283784047);}} else{  ArrayHelper::setByNestedKey($_1884293247, $_1952888803, $_1283784047);}} protected function unsetContextValue($_525544668, &$_1884293247, $_1952888803){ if($_525544668 === 'global'){ $_1303730669= $GLOBALS['____1427417536'][11]($_1952888803); if(empty($_1952888803)){ unset($GLOBALS[$_1303730669]);} else{ $_1884293247=& $GLOBALS[$_1303730669]; ArrayHelper::unsetByNestedKey($_1884293247, $_1952888803);}} else{ ArrayHelper::unsetByNestedKey($_1884293247, $_1952888803);}}  protected function recursiveContextKeyHandle(string $_525544668, array &$_1884293247, array $_1748152730, Rule $_1223605099): array{  $_337161660=[]; foreach($_1884293247 as $_2117056477 => $_1283784047){ $_1952888803= $GLOBALS['____1427417536'][12]($_1748152730,[$_2117056477]); if($_1223605099->matchKey($_1952888803)){  if($_1223605099->getProcess() === ___584183675(20)){ $_1611683428= $_1223605099->evaluate($_2117056477);} elseif($_1223605099->getProcess() === ___584183675(21)){ $_1611683428= $_1223605099->evaluateValue($_1283784047);}  if(!empty($_1611683428) && $_1611683428 instanceof RuleResult){ $_337161660[]= new HandlingResult($_525544668, $_1952888803, $_1611683428, $_1223605099);}}  if($GLOBALS['____1427417536'][13]($_1283784047)){ $_337161660= $GLOBALS['____1427417536'][14]($_337161660, $this->recursiveContextKeyHandle( $_525544668, $_1884293247[$_2117056477], $_1952888803, $_1223605099));}} return $_337161660;} protected function getContextElements(array $_1855735507){ $_1994473313=[]; if($GLOBALS['____1427417536'][15](___584183675(22), $_1855735507, true)){ $_1994473313[___584183675(23)]= &$_GET;} if($GLOBALS['____1427417536'][16](___584183675(24), $_1855735507, true)){ $_1994473313[___584183675(25)]= &$_POST;} if($GLOBALS['____1427417536'][17](___584183675(26), $_1855735507, true)){ $_1994473313[___584183675(27)]= &$_COOKIE;} if($GLOBALS['____1427417536'][18](___584183675(28), $_1855735507, true)){ $_1994473313[___584183675(29)]= &$_REQUEST;} if($GLOBALS['____1427417536'][19](___584183675(30), $_1855735507, true)){ $_1994473313[___584183675(31)]= $GLOBALS;} return $_1994473313;} public static function refreshRules(){ try{ $_1113422318= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1427417536'][20]()- $_1113422318)< static::CACHE_RULES_TTL){ return;} Option::set(___584183675(32), ___584183675(33), $GLOBALS['____1427417536'][21]()); $_1316571312= null;  $_1966243274= $GLOBALS['____1427417536'][22](function($_946058756){ return[___584183675(34) => $_946058756[___584183675(35)], ___584183675(36) => (int) $_946058756[___584183675(37)]];}, ModuleManager::getModulesFromDisk());  $_1476379263=[]; foreach($GLOBALS['____1427417536'][23]() as $_1798616429){ $_1132953515= new ReflectionExtension($_1798616429); $_1476379263[$_1798616429]=[ ___584183675(38) => $_1132953515->getVersion(), ___584183675(39) => $_1132953515->getINIEntries()];} $_1523881990=[ ___584183675(40) => $GLOBALS['____1427417536'][24]($_1966243274), ___584183675(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___584183675(42) => $GLOBALS['____1427417536'][25]([ ___584183675(43) => $GLOBALS['____1427417536'][26](), ___584183675(44) => $_1476379263])]; if(Loader::includeModule(___584183675(45))){ $_131671725= CSecuritySystemInformation::getSystemInformation(); if(isset($_131671725[___584183675(46)][___584183675(47)]) && isset($_131671725[___584183675(48)][___584183675(49)])){ $_1523881990[___584183675(50)]=[ ___584183675(51) => $_131671725[___584183675(52)][___584183675(53)], ___584183675(54) => $_131671725[___584183675(55)][___584183675(56)]];} if(isset($_131671725[___584183675(57)][___584183675(58)])){ $_1523881990[___584183675(59)]=[___584183675(60) => $_131671725[___584183675(61)][___584183675(62)]];}}  $_755181107= new HttpClient([ ___584183675(63) => round(0+1+1+1+1+1), ___584183675(64) => round(0+1.25+1.25+1.25+1.25)]); $_1740473241=(new UrlProvider())->getTechDomain(); $_1326658234="https://wwall.{$_1740473241}/rules.php"; $_522069048= $_755181107->post($_1326658234, $_1523881990); if($_755181107->getStatus() == round(0+100+100) &&!empty($_522069048)){ $_1316571312= Json::decode($_522069048);}  if($_1316571312 !== null){ $_1189057113= Application::getConnection(); $_1618869310= RuleRecordTable::getTableName(); if(!empty($_1316571312)){ foreach($_1316571312 as $_1245210438){ if(!static::checkRuleSign($_1245210438)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1427417536'][27]($_1245210438));}}}  $_1189057113->truncateTable($_1618869310);  if(!empty($_1316571312)){ $_1625673567=[]; foreach($_1316571312 as $_1245210438){ $_1625673567[]= ___584183675(65). $_1189057113->getSqlHelper()->forSql($_1245210438[___584183675(66)]). ___584183675(67). $_1189057113->getSqlHelper()->forSql($_1245210438[___584183675(68)]). ___584183675(69). $_1189057113->getSqlHelper()->forSql($_1245210438[___584183675(70)]). ___584183675(71);} $_1768679120= $GLOBALS['____1427417536'][28](___584183675(72), $_1625673567);  $_1189057113->query("INSERT INTO {$_1618869310} (DATA, MODULE, MODULE_VERSION) VALUES {$_1768679120}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1716080229){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___584183675(73), ___584183675(74), ___584183675(75), ___584183675(76). $_1716080229->getMessage(). ___584183675(77). $_1716080229->getTraceAsString());}} protected static function checkRuleSign($_1223605099){ $_544206107= new PublicKeyCipher; $_408379206= $_544206107->decrypt($_1223605099[___584183675(78)], static::__763193910()); return str_starts_with($_408379206, ___584183675(79));} private static function __763193910(){ $_811097164= ''; $_811097164 .= ___584183675(80); $_811097164 .= ___584183675(81); return $_811097164;} protected function logEvent($_338411398, $_156599334, $_1068858179){ if($this->_1807789087){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_338411398, 'main', $_156599334, $_1068858179);}}}?>