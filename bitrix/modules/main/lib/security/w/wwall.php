<? namespace Bitrix\Main\Security\W;$GLOBALS['____1055930908']= array(base64_decode(''.'dGltZQ='.'='),base64_decode('dGltZQ'.'=='),base64_decode(''.'a'.'nN'.'v'.'bl'.'9kZWN'.'v'.'Z'.'G'.'U='),base64_decode('Y'.'XJy'.'YXlf'.'bWVyZ'.'2U='),base64_decode('a'.'m9p'.'b'.'g=='),base64_decode('am9pbg=='),base64_decode('am9pbg='.'='),base64_decode('YXJyYXlfcG9'.'w'),base64_decode('YXJ'.'yYXl'.'fc2hpZnQ'.'='),base64_decode('YXJyY'.'Xlfc2h'.'pZnQ='),base64_decode('YXJyYXlfc2hpZnQ='),base64_decode('YXJyYX'.'lfc2hpZnQ'.'='),base64_decode('Y'.'XJ'.'yYX'.'lfb'.'W'.'VyZ2'.'U='),base64_decode('aXNfY'.'X'.'J'.'yY'.'Xk='),base64_decode('Y'.'XJy'.'YXlfb'.'W'.'VyZ2'.'U='),base64_decode('aW5fYXJyYXk='),base64_decode('aW'.'5fY'.'X'.'J'.'yYXk='),base64_decode('aW'.'5fY'.'XJyYXk='),base64_decode('a'.'W5fYXJy'.'Y'.'Xk'.'='),base64_decode('aW'.'5fYX'.'JyYXk='),base64_decode('d'.'GltZQ'.'=='),base64_decode('dGltZQ'.'=='),base64_decode('YXJyYXl'.'fbWFw'),base64_decode('Z2V'.'0'.'X2x'.'v'.'YW'.'RlZ'.'F9leHRlbn'.'N'.'pb25z'),base64_decode('anNvbl9lbmNvZG'.'U='),base64_decode('anNvbl9lbmN'.'vZGU='),base64_decode('cGh'.'w'.'dm'.'Vyc'.'2lvbg=='),base64_decode('a'.'n'.'Nvbl9lb'.'mNvZGU='),base64_decode('am9pbg'.'=='));if(!function_exists(__NAMESPACE__.'\\___1379942604')){function ___1379942604($_9234654){static $_545451753= false; if($_545451753 == false) $_545451753=array('V'.'1'.'d'.'BT'.'Exf'.'TE9'.'DSw='.'=','c2Vj'.'d'.'X'.'Jp'.'dH'.'k'.'=','R'.'E'.'F'.'UQ'.'Q'.'='.'=','eyI=','V1dB'.'T'.'ExfTE'.'9DSw'.'==','c2Vj'.'dXJp'.'dH'.'k=','U0'.'V'.'DVVJJ'.'V'.'FlfV1'.'dBTExfRVhDRVBU'.'SU9O','Rk'.'FJTF9'.'DSEVDS0'.'lO'.'R'.'w==','Q2FuI'.'G5'.'vd'.'CB'.'leGV'.'j'.'d'.'XR'.'lIHd3'.'YWxsIHJ1bG'.'Vz'.'OiA=','IFRyYW'.'NlOi'.'A=','U'.'kVRVUV'.'TVF9VU'.'kk=','a2'.'V5cw='.'=','dmFsdWVz',''.'U0VDVV'.'J'.'JVFlfV'.'1dBTExf'.'TU9ESU'.'ZZ','Lg==','U0VDVV'.'J'.'JVFlfV1dBTE'.'x'.'fVU5TRV'.'Q=','Lg='.'=','U0V'.'DVVJJVFlf'.'V1'.'dBTEx'.'fRV'.'hJVA==','Lg==',''.'Z2xvY'.'mFs','a2V5cw==','d'.'m'.'FsdW'.'Vz','Z2V0','Z2V0','c'.'G9'.'zdA==','cG'.'9zdA==','Y29va2ll',''.'Y'.'29va'.'2ll','cmV'.'xd'.'WV'.'zdA==','cmV'.'xdWVzdA==','Z'.'2xvY'.'mFs','Z2xvYmFs','bWFpbl9zZWM=','V1d'.'BTExfQ'.'UNUV'.'UF'.'M'.'SVp'.'FX1J'.'V'.'T'.'E'.'VT',''.'dg==','d'.'mV'.'yc2lvbg='.'=','aQ==','aX'.'NJb'.'n'.'N0YWxs'.'ZWQ=','dg='.'=','aW'.'5p','bW9k'.'dW'.'xlc'.'w='.'=',''.'b'.'GljZ'.'W5zZQ'.'==','c'.'Ghw','d'.'g==',''.'ZXh'.'0','c2V'.'jd'.'XJpdHk'.'=','ZGI=','d'.'HlwZQ==','Z'.'GI'.'=','dm'.'Vy'.'c2l'.'v'.'bg==',''.'Z'.'GI'.'=','d'.'HlwZQ'.'==','ZG'.'I=',''.'dHlw'.'ZQ==','dmVyc2l'.'vbg==','ZGI=',''.'dmV'.'yc'.'2lvbg==','ZW52aXJvb'.'m1l'.'b'.'n'.'Q=','d'.'m1fdmVy'.'c2lvbg='.'=','dm0=','dg==','ZW52aXJvbm1'.'lbnQ=','dm1fdmVyc2lvbg==','c2'.'9ja2V0'.'VGlt'.'ZW91dA'.'==','c3'.'Ry'.'ZW'.'FtVGlt'.'Z'.'W'.'91dA==','KCc=','ZGF0Y'.'Q==','Jyw'.'gJw==','bW'.'9k'.'dWxl','Jyw'.'gJw='.'=','b'.'W9kdWxlX3Z'.'lcnNp'.'b24=','Jyk=','LCA=','U0VDVVJJV'.'F'.'lfV1dBTE'.'xf'.'RVhDR'.'VB'.'USU9'.'O','bWF'.'pbg'.'='.'=','RkFJ'.'TF9'.'SRUZSRV'.'NISU5H','Q2'.'FuIG5'.'vdCByZWZ'.'y'.'ZXNo'.'IHd3Y'.'W'.'xsIH'.'J'.'1bG'.'VzOi'.'A=','IFRyYWNlOiA=','ZGF0Y'.'Q==','eyI=',''.'LS0tL'.'S1'.'C'.'RUdJT'.'iBQVU'.'JMSUMgS0V'.'ZLS'.'0tLS0=','Ck1'.'JSUJJakFOQmdr'.'cW'.'hr'.'aUc5dzBCQVFFRkF'.'BT0'.'NB'.'UThB'.'T'.'UlJ'.'QkNnS0'.'NB'.'UU'.'V'.'Bc'.'Th'.'RRT'.'B'.'I'.'a'.'m1IS'.'lVT'.'dFdW'.'Nm4wemEKUlZvTHgwMkt'.'6YmZyYlM'.'vUDZzV'.'2F4VH'.'p3O'.'FNl'.'R1'.'R0YlRD'.'T3JwSGk1UUY'.'2T1J5alovWH'.'h'.'6L0'.'t'.'M'.'VTF'.'H'.'Ym'.'9'.'mOUN'.'aMw'.'o'.'0ejdTa3FVdDY2a'.'WJYdk'.'9G'.'Qng0ZncvQVBQUkdEcXRt'.'M'.'G5'.'EM2ZnR3N1M1JlU'.'Gd3MjlpOCt2bTdt'.'dEJ'.'LSlVZbDRyClZw'.'YjZ'.'z'.'Zlp'.'FVDlLRWI2'.'VDFIR'.'FltRXZjMWhxL2lpdXl4TH'.'JaWmk1UTZVZmY0VUV2VEk'.'rNj'.'hzc0Z'.'Sa1Er'.'b'.'3dUUnkKZU9JTWJG'.'aE'.'0v'.'VVRtZlZ'.'ZYlRSRnkyb1VROFdN'.'emEybk'.'o1U2'.'FoemkxVUtPMWpBalh'.'U'.'UFJyemM'.'3'.'Q'.'W'.'p1NjM5'.'a'.'jFPMApwcHFmbT'.'V4Z1'.'ds'.'RkF'.'Ka0hRV'.'Gdi'.'ZGQ1QVd'.'xREZ'.'Ra3Q5SE'.'t'.'rWSt'.'Ubm'.'ZCTE'.'d'.'WT'.'XZWeVB'.'3VE'.'hOV1FZQXc0e'.'HBn'.'L3d'.'B'.'Clp3'.'SURBUUF'.'C'.'Ci0tLS0tRU'.'5EI'.'FBVQkxJQyBL'.'RVktLS0tLQ'.'==');return base64_decode($_545451753[$_9234654]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_493516040= true; public function handle(){ try{  $_953307964= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_953307964)){ return;}  $_1833879313= Cache::createInstance(); $_42841472= false; if($_1833879313->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_368754522= $_1833879313->getVars(); if($GLOBALS['____1055930908'][0]()- $_368754522> round(0+10+10)){  $_148274039= Application::getConnection(); $_791575775= RuleRecordTable::getTableName(); $_148274039->truncateTable($_791575775); RuleRecordTable::cleanCache(); $_1833879313->clean(___1379942604(0), ___1379942604(1));}} elseif($_1833879313->startDataCache()){  $_1833879313->endDataCache($GLOBALS['____1055930908'][1]()); $_42841472= true;} foreach($_953307964 as $_400955148){ $_640822535= new PublicKeyCipher; $_1974788713= $_640822535->decrypt($_400955148[___1379942604(2)], static::__737975273()); if(!str_starts_with($_1974788713, ___1379942604(3))){ continue;} $_1110764714= $GLOBALS['____1055930908'][2]($_1974788713, true); if(!empty($_1110764714)){ $_1848003646= Rule::make($_1110764714); $_1351243927= $this->handleRule($_1848003646); $this->applyHandlingResults($_1351243927);}}  if($_42841472){ $_1833879313->clean(___1379942604(4), ___1379942604(5));}} catch(\Throwable $_875143073){ $this->logEvent( ___1379942604(6), ___1379942604(7), ___1379942604(8). $_875143073->getMessage(). ___1379942604(9). $_875143073->getTraceAsString());}}  public function handleRule(Rule $_1848003646): array{ $_1351243927=[]; if($_1848003646->matchPath($_SERVER[___1379942604(10)])){  $_41071499= $this->getContextElements($_1848003646->getContext()); foreach($_41071499 as $_586982487 => &$_2112318334){ $_1351243927= $GLOBALS['____1055930908'][3]($_1351243927, $this->recursiveContextKeyHandle($_586982487, $_2112318334,[], $_1848003646));}} return $_1351243927;}  public function applyHandlingResults(array $_1351243927){ $_41071499= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1351243927 as $_1518632488){ $_2112318334=& $_41071499[$_1518632488->getContextName()]; $_585968636= $_1518632488->getRuleResult(); $_1848003646= $_1518632488->getRule(); if($_585968636 instanceof ModifyResult){ if($_1848003646->getProcess() === ___1379942604(11)){  static::rewriteContextKey( $_1518632488->getContextName(), $_2112318334, $_1518632488->getContextKey(), $_585968636->getCleanValue());} elseif($_1848003646->getProcess() === ___1379942604(12)){ static::rewriteContextValue( $_1518632488->getContextName(), $_2112318334, $_1518632488->getContextKey(), $_585968636->getCleanValue());} $this->logEvent( ___1379942604(13), $_1518632488->getContextName(), $GLOBALS['____1055930908'][4](___1379942604(14), $_1518632488->getContextKey()));} elseif($_585968636 instanceof CheckResult &&!$_585968636->isSuccess()){ if($_585968636->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_1518632488->getContextName(), $_2112318334, $_1518632488->getContextKey(),); $this->logEvent( ___1379942604(15), $_1518632488->getContextName(), $GLOBALS['____1055930908'][5](___1379942604(16), $_1518632488->getContextKey()));} elseif($_585968636->getAction() === RuleAction::EXIT){ $this->logEvent( ___1379942604(17), $_1518632488->getContextName(), $GLOBALS['____1055930908'][6](___1379942604(18), $_1518632488->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_493516040= false;} protected function rewriteContextKey($_586982487, &$_2112318334, $_912885717, $_766799304){ $_1704978261= $_912885717;  $GLOBALS['____1055930908'][7]($_1704978261); $_1704978261[]= $_766799304; if($_586982487 === ___1379942604(19)){ $_2030831969= $GLOBALS['____1055930908'][8]($_912885717); $GLOBALS['____1055930908'][9]($_1704978261); if(empty($_912885717)){ $GLOBALS[$_766799304]= $GLOBALS[$_2030831969]; unset($GLOBALS[$_2030831969]);} else{ $_2112318334=& $GLOBALS[$_2030831969]; $_1743246877= ArrayHelper::getByNestedKey($_2112318334, $_912885717);  ArrayHelper::setByNestedKey($_2112318334, $_1704978261, $_1743246877);  ArrayHelper::unsetByNestedKey($_2112318334, $_912885717);}} else{ $_1743246877= ArrayHelper::getByNestedKey($_2112318334, $_912885717);  ArrayHelper::setByNestedKey($_2112318334, $_1704978261, $_1743246877);  ArrayHelper::unsetByNestedKey($_2112318334, $_912885717);}} protected function rewriteContextValue($_586982487, &$_2112318334, $_1845907364, $_1743246877){ if($_586982487 === 'global'){ $_2030831969= $GLOBALS['____1055930908'][10]($_1845907364); if(empty($_1845907364)){ $GLOBALS[$_2030831969]= $_1743246877;} else{ $_2112318334=& $GLOBALS[$_2030831969]; ArrayHelper::setByNestedKey($_2112318334, $_1845907364, $_1743246877);}} else{  ArrayHelper::setByNestedKey($_2112318334, $_1845907364, $_1743246877);}} protected function unsetContextValue($_586982487, &$_2112318334, $_1845907364){ if($_586982487 === 'global'){ $_2030831969= $GLOBALS['____1055930908'][11]($_1845907364); if(empty($_1845907364)){ unset($GLOBALS[$_2030831969]);} else{ $_2112318334=& $GLOBALS[$_2030831969]; ArrayHelper::unsetByNestedKey($_2112318334, $_1845907364);}} else{ ArrayHelper::unsetByNestedKey($_2112318334, $_1845907364);}}  protected function recursiveContextKeyHandle(string $_586982487, array &$_2112318334, array $_1363358442, Rule $_1848003646): array{  $_1351243927=[]; foreach($_2112318334 as $_1989601425 => $_1743246877){ $_1845907364= $GLOBALS['____1055930908'][12]($_1363358442,[$_1989601425]); if($_1848003646->matchKey($_1845907364)){  if($_1848003646->getProcess() === ___1379942604(20)){ $_585968636= $_1848003646->evaluate($_1989601425);} elseif($_1848003646->getProcess() === ___1379942604(21)){ $_585968636= $_1848003646->evaluateValue($_1743246877);}  if(!empty($_585968636) && $_585968636 instanceof RuleResult){ $_1351243927[]= new HandlingResult($_586982487, $_1845907364, $_585968636, $_1848003646);}}  if($GLOBALS['____1055930908'][13]($_1743246877)){ $_1351243927= $GLOBALS['____1055930908'][14]($_1351243927, $this->recursiveContextKeyHandle( $_586982487, $_2112318334[$_1989601425], $_1845907364, $_1848003646));}} return $_1351243927;} protected function getContextElements(array $_275851421){ $_361809951=[]; if($GLOBALS['____1055930908'][15](___1379942604(22), $_275851421, true)){ $_361809951[___1379942604(23)]= &$_GET;} if($GLOBALS['____1055930908'][16](___1379942604(24), $_275851421, true)){ $_361809951[___1379942604(25)]= &$_POST;} if($GLOBALS['____1055930908'][17](___1379942604(26), $_275851421, true)){ $_361809951[___1379942604(27)]= &$_COOKIE;} if($GLOBALS['____1055930908'][18](___1379942604(28), $_275851421, true)){ $_361809951[___1379942604(29)]= &$_REQUEST;} if($GLOBALS['____1055930908'][19](___1379942604(30), $_275851421, true)){ $_361809951[___1379942604(31)]= $GLOBALS;} return $_361809951;} public static function refreshRules(){ try{ $_2141773453= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1055930908'][20]()- $_2141773453)< static::CACHE_RULES_TTL){ return;} Option::set(___1379942604(32), ___1379942604(33), $GLOBALS['____1055930908'][21]()); $_206887594= null;  $_661814725= $GLOBALS['____1055930908'][22](function($_723308596){ return[___1379942604(34) => $_723308596[___1379942604(35)], ___1379942604(36) => (int) $_723308596[___1379942604(37)]];}, ModuleManager::getModulesFromDisk());  $_92276756=[]; foreach($GLOBALS['____1055930908'][23]() as $_1471647221){ $_571214041= new ReflectionExtension($_1471647221); $_92276756[$_1471647221]=[ ___1379942604(38) => $_571214041->getVersion(), ___1379942604(39) => $_571214041->getINIEntries()];} $_1355041139=[ ___1379942604(40) => $GLOBALS['____1055930908'][24]($_661814725), ___1379942604(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1379942604(42) => $GLOBALS['____1055930908'][25]([ ___1379942604(43) => $GLOBALS['____1055930908'][26](), ___1379942604(44) => $_92276756])]; if(Loader::includeModule(___1379942604(45))){ $_103655620= CSecuritySystemInformation::getSystemInformation(); if(isset($_103655620[___1379942604(46)][___1379942604(47)]) && isset($_103655620[___1379942604(48)][___1379942604(49)])){ $_1355041139[___1379942604(50)]=[ ___1379942604(51) => $_103655620[___1379942604(52)][___1379942604(53)], ___1379942604(54) => $_103655620[___1379942604(55)][___1379942604(56)]];} if(isset($_103655620[___1379942604(57)][___1379942604(58)])){ $_1355041139[___1379942604(59)]=[___1379942604(60) => $_103655620[___1379942604(61)][___1379942604(62)]];}}  $_1203440172= new HttpClient([ ___1379942604(63) => round(0+1.25+1.25+1.25+1.25), ___1379942604(64) => round(0+5)]); $_1364499405=(new UrlProvider())->getTechDomain(); $_1041279356="https://wwall.{$_1364499405}/rules.php"; $_1560455744= $_1203440172->post($_1041279356, $_1355041139); if($_1203440172->getStatus() == round(0+50+50+50+50) &&!empty($_1560455744)){ $_206887594= Json::decode($_1560455744);}  if($_206887594 !== null){ $_148274039= Application::getConnection(); $_791575775= RuleRecordTable::getTableName(); if(!empty($_206887594)){ foreach($_206887594 as $_766268242){ if(!static::checkRuleSign($_766268242)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1055930908'][27]($_766268242));}}}  $_148274039->truncateTable($_791575775);  if(!empty($_206887594)){ $_1320561944=[]; foreach($_206887594 as $_766268242){ $_1320561944[]= ___1379942604(65). $_148274039->getSqlHelper()->forSql($_766268242[___1379942604(66)]). ___1379942604(67). $_148274039->getSqlHelper()->forSql($_766268242[___1379942604(68)]). ___1379942604(69). $_148274039->getSqlHelper()->forSql($_766268242[___1379942604(70)]). ___1379942604(71);} $_521207495= $GLOBALS['____1055930908'][28](___1379942604(72), $_1320561944);  $_148274039->query("INSERT INTO {$_791575775} (DATA, MODULE, MODULE_VERSION) VALUES {$_521207495}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_875143073){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1379942604(73), ___1379942604(74), ___1379942604(75), ___1379942604(76). $_875143073->getMessage(). ___1379942604(77). $_875143073->getTraceAsString());}} protected static function checkRuleSign($_1848003646){ $_640822535= new PublicKeyCipher; $_1110764714= $_640822535->decrypt($_1848003646[___1379942604(78)], static::__737975273()); return str_starts_with($_1110764714, ___1379942604(79));} private static function __737975273(){ $_719219846= ''; $_719219846 .= ___1379942604(80); $_719219846 .= ___1379942604(81); return $_719219846;} protected function logEvent($_982918739, $_361462550, $_1076932980){ if($this->_493516040){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_982918739, 'main', $_361462550, $_1076932980);}}}?>