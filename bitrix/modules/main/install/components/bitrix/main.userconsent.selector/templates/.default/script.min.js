var MainUserConsentSelectorManager=function(e){this.selectors=[];this.init=function(e){this.actionRequestUrl=e.actionRequestUrl;this.template=e.template??null;if(this.template){this.template=BX.Tag.render([this.template]);var t=this.template.querySelector("select[data-bx-selector]");this.selectors.push(t)}this.inputName=e.inputName;this.initSlider();var i=document.querySelectorAll("[data-bx-user-consent-selector]");i=BX.convert.nodeListToArray(i);i.forEach(this.initByContext,this)};this.initByBlockContext=function(e){var t=e.querySelector("select[data-bx-selector]");var i=e.querySelector("a[data-bx-link-edit]");var n=e.querySelector("a[data-bx-link-view]");if(!t||!i||!n){return}var l=e.querySelector("[data-bx-delete]");BX.bind(l,"click",this.removeBlock.bind(this,e));this.selectors.push(t);BX.bind(t,"change",this.onChange.bind(this,t,i,n));this.onChange(t,i,n)};this.initByContext=function(e){var t=e.querySelectorAll("[data-bx-user-consent-selector-block]");t=BX.convert.nodeListToArray(t);t.forEach(this.initByBlockContext,this);this.initSliderButtons(e);var i=e.querySelector("a[data-bx-link-add]");if(i){BX.bind(i,"click",this.onAddClick.bind(this,e))}};this.onAddClick=function(e){var t=e.querySelector("[data-bx-user-consent-selector-blocks-container]");if(t){var i=this.template.cloneNode(true);var n=t.querySelectorAll("[data-bx-user-consent-selector-block]");var l=n.length;this.updateBlockInputNames(i,l);t.appendChild(i);this.initByBlockContext(i);this.initSliderButtons(i);n=t.querySelectorAll("[data-bx-user-consent-selector-block]");if(n.length===2){var o=n[0].querySelector("[data-bx-delete]");o.style.display="inline"}}};this.removeBlock=function(e){var t=e.parentNode;var i=t.querySelectorAll("[data-bx-user-consent-selector-block]");if(i.length>1){e.remove()}i=t.querySelectorAll("[data-bx-user-consent-selector-block]");if(i.length>1){i.forEach(((e,t)=>{this.updateBlockInputNames(e,t)}))}else{var n=i[0].querySelector("[data-bx-delete]");n.style.display="none"}};this.updateBlockInputNames=function(e,t){var i=e.querySelector("[data-bx-selector]");i.name=this.inputName+"["+t+"]"+"[ID]";var n=e.querySelectorAll("[data-bx-default-input]");n.forEach((e=>{e.name=this.inputName+"["+t+"]"+"[CHECKED]"}));var l=e.querySelectorAll("[data-bx-required-input]");l.forEach((e=>{e.name=this.inputName+"["+t+"]"+"[REQUIRED]"}))};this.onChange=function(e,t,i){t.style.display=e.value?"":"none";i.style.display=e.value?"":"none";this.fillHrefByTemplate(t,e.value);this.fillHrefByTemplate(i,e.value)};this.fillHrefByTemplate=function(e,t){var i=e.getAttribute("data-bx-link-tmpl");if(!i){return}e.href=i.replace(new RegExp("#id#","g"),t)};this.fillDropDownControl=function(e,t,i){t=t||[];var n=e.children[0];e.innerHTML="";if(i&&n){e.appendChild(n)}t.forEach((function(t){if(!t||!t.caption){return}var i=document.createElement("option");i.value=t.value;i.selected=!!t.selected;i.innerText=t.caption;e.appendChild(i)}))};this.initSliderButtons=function(e){var t=e.querySelectorAll("[data-bx-slider-href]");t=BX.convert.nodeListToArray(t);t.forEach(this.slider.bindOpen,this.slider)};this.initSlider=function(){this.slider.caller=this;top.BX.addCustomEvent(top,"main-user-consent-to-list",(function(){top.BX.SidePanel.Instance.close()}))};this.onSliderClose=function(){this.sendActionRequest("getAgreements",{},(function(e){if(!e.list){return}this.selectors.forEach((function(t){var i=t.value;if(!i){i=e.list[0].ID}var n=e.list.map((function(e){return{caption:e.NAME,value:e.ID,selected:(e.ID||"").toString()===i}}));this.fillDropDownControl(t,n,true);BX.fireEvent(t,"change")}),this)}))};this.slider={caller:null,init:function(e){top.BX.SidePanel.Instance.bindAnchors({rules:[{condition:e.condition,loader:e.loader,stopParameters:[]}]})},onSaved:function(){this.onClose();top.BX.SidePanel.Instance.close()},onClose:function(){if(this.caller){this.caller.onSliderClose()}},bindOpen:function(e){BX.bind(e,"click",this.openHref.bind(this,e))},openHref:function(e,t){t.preventDefault();this.open(e.getAttribute("href"),e.getAttribute("data-bx-slider-reload"))},open:function(e,t){top.BX.SidePanel.Instance.open(e,{cacheable:false,events:{}});if(t){top.BX.addCustomEvent(top,"main-user-consent-saved",this.onSaved.bind(this))}}};this.sendActionRequest=function(e,t,i,n){i=i||null;n=n||null;t.action=e;t.sessid=BX.bitrix_sessid();t.action=e;BX.ajax({url:this.actionRequestUrl,method:"POST",data:t,timeout:10,dataType:"json",processData:true,onsuccess:BX.proxy((function(e){e=e||{};if(e.error){n.apply(this,[e])}else if(i){i.apply(this,[e])}}),this),onfailure:BX.proxy((function(){var e={error:true,text:""};if(n){n.apply(this,[e])}}),this)})};this.init(e)};
//# sourceMappingURL=script.map.js