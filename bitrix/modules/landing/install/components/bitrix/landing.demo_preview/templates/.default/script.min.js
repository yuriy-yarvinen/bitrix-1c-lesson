(function(){"use strict";BX.namespace("BX.Landing");var e=BX.Landing.Utils.proxy;var t=BX.Landing.Utils.bind;var i=BX.Landing.Utils.addClass;var a=BX.Landing.Utils.removeClass;var s=BX.Landing.Utils.isNumber;var n=BX.Landing.Utils.style;var r=BX.Landing.Utils.data;var o=BX.Landing.Utils.addQueryParams;BX.Landing.TemplatePreview=function(t){this.previewContainer=document.querySelector(".landing-template-preview");this.closeButton=document.querySelector(".landing-template-preview-close");this.createButton=document.querySelector(".landing-template-preview-create");this.title=document.querySelector(".landing-template-preview-input-title");this.description=document.querySelector(".landing-template-preview-input-description");this.imageContainer=document.querySelector(".preview-desktop-body-image");this.loaderContainer=document.querySelector(".preview-desktop-body-loader-container");this.previewFrame=document.querySelector(".preview-desktop-body-preview-frame");this.baseUrlNode=document.querySelector(".landing-template-preview-base-url");this.loader=new BX.Loader({});this.messages=t.messages||{};this.loaderText=null;this.progressBar=null;this.IsLoadedFrame=false;this.baseUrl="";this.ajaxUrl="";this.ajaxParams={};this.createStore=BX.type.isBoolean(t.createStore)?t.createStore:false;this.createMainpage=BX.type.isBoolean(t.createMainpage)?t.createMainpage:false;this.isMainpageExists=BX.type.isBoolean(t.isMainpageExists)?t.isMainpageExists:false;this.disableStoreRedirect=BX.type.isBoolean(t.disableStoreRedirect)?t.disableStoreRedirect:false;this.disableClickHandler=BX.type.isBoolean(t.disableClickHandler)?t.disableClickHandler:false;this.adminSection=BX.type.isBoolean(t.adminSection)?t.adminSection:null;this.zipInstallPath=t.zipInstallPath?t.zipInstallPath:null;this.appCode=t.appCode||null;this.siteId=t.siteId||0;this.langId=BX.type.isString(t.langId)?t.langId:"";this.folderId=t.folderId||0;this.replaceLid=t.replaceLid||0;this.isCrmForm=(t.isCrmForm||"N")==="Y";this.isKnowledgeBase=(t.isKnowledgeBase||"N")==="Y";this.urlPreview=t.urlPreview||"";this.onCreateButtonClick=e(this.onCreateButtonClick,this);this.onCancelButtonClick=e(this.onCancelButtonClick,this);this.onFrameLoad=e(this.onFrameLoad,this);this.init();this.metrika=new BX.Landing.Metrika(true);this.metrika.sendData(this.getMetrikaParams("preview_template","success"));return this};BX.Landing.TemplatePreview.getInstance=function(e){return BX.Landing.TemplatePreview.instance||(BX.Landing.TemplatePreview.instance=new BX.Landing.TemplatePreview(e))};BX.Landing.TemplatePreview.prototype={init:function(){t(this.previewFrame,"load",this.onFrameLoad);t(this.closeButton,"click",this.onCancelButtonClick);if(!this.disableClickHandler){t(this.createButton,"click",this.onCreateButtonClick)}this.setBaseUrl();this.showPreview();this.buildHeader();if(top.BX.SidePanel.Instance.isReload===true){this.createButton.click()}},setBaseUrl:function(e){if(e===undefined){this.baseUrl=r(this.baseUrlNode,"data-base-url")}else{this.baseUrl=e}},createPreviewUrl:function(){var e={};if(!this.baseUrl){this.setBaseUrl()}return o(this.baseUrl,e)},onFrameLoad:function(){if(this.createStore){new BX.Landing.SaveBtn(this.createButton)}this.IsLoadedFrame=true},showPreview:function(e){if(e===undefined){e=this.createPreviewUrl()}return this.showLoader().then(this.createFrameIfNeeded()).then(this.loadPreview(e)).then(this.hideLoader())},buildHeader:function(){var e=BX.create("div");new QRCode(e,{text:this.urlPreview,width:156,height:156,colorLight:"transparent"});this.showPopupButton=document.querySelector(".mobile-view");if(this.showPopupButton){var t=BX.PopupWindowManager.create("landing-popup-preview",this.showPopupButton,{content:BX.create("div",{props:{className:"landing-popup-preview-content"},children:[BX.create("div",{props:{className:"landing-popup-preview-title"},text:this.messages.LANDING_TPL_POPUP_TITLE}),BX.create("div",{props:{className:"landing-popup-preview-qr"},children:[e]}),BX.create("div",{props:{className:"landing-popup-preview-text"},text:this.messages.LANDING_TPL_POPUP_TEXT})]}),closeIcon:true,closeByEsc:true,noAllPaddings:true,autoHide:true,animation:"fading-slide",angle:{position:"top",offset:75},minWidth:375,maxWidth:375,contentBackground:"transparent"});this.showPopupButton.addEventListener("click",(function(){t.toggle()}))}},createFrameIfNeeded:function(){return function(){return new Promise(function(e){var i=function(){if(!this.previewFrame){this.previewFrame=BX.create("iframe",{props:{className:"preview-desktop-body-preview-frame"}});this.imageContainer.appendChild(this.previewFrame);t(this.previewFrame,"load",this.onFrameLoad)}if(!this.previewFrame.style.width){let e="69";if(this.previewContainer){const t=this.previewContainer.querySelector(".--main-page");if(t){e="132"}}void n(this.previewFrame,{width:"100%",height:`calc(100vh - ${e}px)`,border:"none"})}e(this.previewFrame)}.bind(this);if(document.readyState!=="complete"){BX.bind(window,"load",i.bind(this))}else{i()}}.bind(this))}.bind(this)},loadPreview:function(e){return function(){return new Promise(function(t){if(this.previewFrame.src!==e){this.previewFrame.src=e;this.previewFrame.onload=function(){t(this.previewFrame)}.bind(this);return}t(this.previewFrame)}.bind(this))}.bind(this)},showLoader:function(){return new Promise(function(e){void this.loader.show(this.loaderContainer);i(this.imageContainer,"landing-template-preview-overlay");e()}.bind(this))},hideLoader:function(){return function(e){return new Promise(function(t){void this.loader.hide();a(this.imageContainer,"landing-template-preview-overlay");t(e)}.bind(this))}.bind(this)},delay:function(e){e=s(e)?e:0;return function(t){return new Promise((function(i){setTimeout(i.bind(null,t),e)}))}},getValue:function(){var e={};e[this.title.dataset.name]=this.title.value.replaceAll("&","").replaceAll("?","");e[this.description.dataset.name]=this.description.value;return e},getCreateUrl:function(){const e=this.getValue();e.newLanding="Y";return o(this.createButton.getAttribute("href"),e)},onCancelButtonClick:function(e){e.preventDefault();top.BX.SidePanel.Instance.close()},onCreateButtonClick:function(e){e.preventDefault();if(this.messageBox&&this.messageBox.popupWindow.isShown()){return}if(BX.Dom.hasClass(this.createButton.parentNode,"needed-market-subscription")){const e=this.getMetrikaParams(this.getMetrikaCreateEvent(),"error_market");e.p5=["errorType","need_market_subscription"];this.metrika.sendData(e);top.BX.UI.InfoHelper.show("limit_subscription_market_access_buy_marketplus");new Promise((e=>{const t=setInterval((()=>{if(BX.Dom.hasClass(this.createButton,"ui-btn-clock")){clearInterval(t);e()}}),500)})).then((()=>{BX.Dom.removeClass(this.createButton,"ui-btn-clock");BX.Dom.attr(this.createButton,"style","")}));return}if(this.isStore()&&this.IsLoadedFrame){this.loaderText=BX.create("div",{props:{className:"landing-template-preview-loader-text"},text:this.messages.LANDING_LOADER_WAIT});this.progressBar=new BX.UI.ProgressBar({column:true});this.progressBar.getContainer().classList.add("ui-progressbar-landing-preview");this.loaderContainer.appendChild(this.loaderText);this.loaderContainer.appendChild(this.progressBar.getContainer())}if(this.isStore()){if(this.IsLoadedFrame){this.showLoader().then((()=>{this.initCatalogParams();this.createCatalog()}))}}else if(this.zipInstallPath){if(this.isMainpage()&&this.isMainpageExists){let e=false;BX.Runtime.loadExtension("ui.dialogs.messagebox").then((()=>{this.messageBox=new BX.UI.Dialogs.MessageBox({message:this.messages.LANDING_PREVIEW_MAINPAGE_MESSAGE,title:this.messages.LANDING_PREVIEW_MAINPAGE_TITLE,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,okCaption:this.messages.LANDING_PREVIEW_MAINPAGE_BUTTON_OK_TEXT,cancelCaption:this.messages.LANDING_PREVIEW_MAINPAGE_BUTTON_CANCEL_TEXT,onOk:()=>{e=true;this.finalRedirectAjax(this.getCreateUrl());return true},onCancel:()=>{BX.Dom.removeClass(this.createButton,"ui-btn-clock");BX.Dom.attr(this.createButton,"style","");return true},popupOptions:{bindElement:BX("popup-window-titlebar-close-icon"),offsetLeft:20,closeIcon:true,events:{onPopupClose:()=>{if(!e){BX.Dom.removeClass(this.createButton,"ui-btn-clock");BX.Dom.attr(this.createButton,"style","")}return true}}}});this.messageBox.show();if(this.messageBox.popupWindow&&this.messageBox.popupWindow.popupContainer){this.messageBox.popupWindow.popupContainer.classList.add("landing-template-preview-create-popup")}}))}else{this.finalRedirectAjax(this.getCreateUrl())}}else{this.showLoader().then(this.delay(200)).then((()=>{this.finalRedirectAjax(this.getCreateUrl())}))}},getMetrikaParams:function(e,t){let i="site";if(this.isCrmForm){i="crm_forms"}else if(this.isStore()){i="shop"}else if(this.isKnowledgeBase){i="kb"}else if(this.isMainpage()){i="vibe"}const a={category:i,event:e,type:"template",status:t};if(this.appCode){a.p1=["appCode",this.appCode]}if(this.isMainpage()){delete a.type}else{a.c_section="site";if(this.siteId!==0){a.c_section="page"}}return a},getMetrikaCreateEvent:function(){return this.isCrmForm?"replace_template":"create_template"},initCatalogParams:function(){if(this.createButton.hasAttribute("data-href")){this.ajaxUrl=this.createButton.getAttribute("data-href")}this.ajaxParams=this.getValue();this.ajaxParams["start"]="Y";this.ajaxParams["showcaseId"]="clothes"},createCatalog:function(){if(this.ajaxUrl===""){this.hideLoader();return}BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:BX.ajax.prepareData(this.ajaxParams),onsuccess:e=>{this.createCatalogResult(e)}})},createCatalogResult:function(e){if(e.status==="continue"){this.ajaxParams["start"]="N";this.progressBar.update(e.progress);this.progressBar.setTextAfter(e.message);this.createCatalog()}else{this.finalRedirectAjax(e.url)}},finalRedirectAjax:function(e){if(this.zipInstallPath){let t={};const i=this.getValue();for(let e in i){t["additional["+e+"]"]=i[e]}t["additional[appCode]"]=this.appCode;t["additional[siteId]"]=this.siteId;t["additional[folderId]"]=this.folderId;if(this.replaceLid>0){t["additional[replaceLid]"]=this.replaceLid}const a=this.getMetrikaParams(this.getMetrikaCreateEvent(),"success");t["additional[st_category]"]=a.category;t["additional[st_event]"]=a.event;if(a.c_section){t["additional[st_section]"]=a.c_section}if(a.c_element){t["additional[st_element]"]=a.c_element}t["from"]=this.createParamsStrFromUrl(e);if(this.adminSection&&this.langId!==""){t["lang"]=this.langId}if(typeof top.BX.SidePanel!=="undefined"){const e=document.querySelector(".landing-popup-import");const i=document.querySelector(".landing-popup-import-loader");const a=document.querySelector(".preview-left");if(a&&i){this.loader.show(i);BX.Dom.addClass(a,"landing-import-start")}t["IFRAME"]="Y";if(this.siteId!==0){t["createType"]="PAGE"}BX.ajax.get(o(this.zipInstallPath,t),(t=>{const a=BX.Dom.create("div",{html:t});const s=a.querySelector(".rest-configuration-wrapper");if(s){const t=s.querySelector(".rest-configuration-title");const i=s.querySelector(".rest-configuration-start-icon-main-container");if(t&&i){BX.Dom.remove(t);BX.Dom.insertBefore(t,i.nextSibling)}e.append(s)}const n=a.querySelector(".ui-toolbar");if(n){n.hidden=true;e.append(n)}if(s){BX.Dom.style(i,"display","none");this.loader.hide()}else{this.addRepeatCreateButton()}}))}}else if(this.disableStoreRedirect){BX.ajax({method:"POST",dataType:"html",url:e,onsuccess:function(){if(typeof top.BX.SidePanel!=="undefined"){setTimeout((function(){top.BX.onCustomEvent("Landing:onDemoCreateStart");top.BX.SidePanel.Instance.close()}),100)}}})}else{window.location=e}},addRepeatCreateButton:function(){const e=document.querySelector(".landing-popup-import-repeat");if(e){BX.Dom.removeClass(e,"hide")}const i=document.querySelector(".landing-popup-import-repeat-button");if(i){t(i,"click",this.onRepeatButtonClick)}},onRepeatButtonClick:function(){const e=document.querySelector(".landing-popup-import-repeat");if(e){BX.Dom.addClass(e,"hide")}if(this.createButton){this.createButton.click()}},isStore:function(){return this.createStore},isMainpage:function(){return this.createMainpage},createParamsStrFromUrl(e){var t=e.match(/&app_code=[^&]+/i);var i="";if(t!==null){i=t[0].substr(10)}var a=e.match(/&title=[^&]+/iu);var s="";if(a!==null){s=a[0].substr(7)}var n=e.match(/&preview_id=[^&]+/i);var r="";if(n!==null){r=n[0].substr(12)}return"|"+i+"|"+s+"|"+r}}})();
//# sourceMappingURL=script.map.js