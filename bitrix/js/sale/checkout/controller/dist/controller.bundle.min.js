this.BX=this.BX||{};this.BX.Sale=this.BX.Sale||{};this.BX.Sale.Checkout=this.BX.Sale.Checkout||{};(function(e,t,r,n,i,s){"use strict";var a=function(){function e(){babelHelpers.classCallCheck(this,e);this.pool=this.getPool();this.timer=this.getTimer();this.running="N"}babelHelpers.createClass(e,[{key:"getPool",value:function e(){return new s.Pool}},{key:"getTimer",value:function e(){return new s.Timer}},{key:"isRunning",value:function e(){return this.running==="Y"}},{key:"setRunningY",value:function e(){this.running="Y"}},{key:"setRunningN",value:function e(){this.running="N"}},{key:"setStore",value:function e(t){this.store=t;return this}},{key:"setProvider",value:function e(t){this.provider=t;return this}},{key:"executeRestAnswer",value:function e(t,r,n){return this.provider.execute(t,r,n)}},{key:"getItem",value:function e(t){return this.store.getters["basket/get"](t)}},{key:"getBasket",value:function e(){return this.store.getters["basket/getBasket"]}},{key:"getBasketCollection",value:function e(){return this.getBasket().filter((function(e){return e.deleted==="N"}))}},{key:"changeItem",value:function e(t){this.store.dispatch("basket/changeItem",{index:t.index,fields:t.fields})}},{key:"setQuantity",value:function e(t,r){var n=this.getItem(t);n.quantity=r;n.baseSum=this.round(n.basePrice*n.quantity);n.sum=this.round(n.price*n.quantity);n.discount.sum=this.round(n.discount.price*n.quantity);this.refreshDiscount();this.refreshTotal();this.pool.add(i.Pool.action.quantity,t,{id:n.id,value:n.quantity});this.changeItem({index:t,fields:n});this.shelveCommit()}},{key:"refreshDiscount",value:function e(){var t=this.getBasket();if(t.length>0){this.store.dispatch("basket/setDiscount",{sum:t.reduce((function(e,t){return e+t.discount.sum}),0)})}}},{key:"refreshTotal",value:function e(){var t=this.getBasketCollection();if(t.length>0){this.store.dispatch("basket/setTotal",{price:t.reduce((function(e,t){return e+t.sum}),0),basePrice:t.reduce((function(e,t){return e+t.baseSum}),0)})}}},{key:"removeItem",value:function e(t){return this.store.dispatch("basket/removeItem",{index:t.index})}},{key:"round",value:function e(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:10;var n=Math.pow(10,r);return Math.round(t*n)/n}},{key:"emitOnBasketChange",value:function e(){BX.onCustomEvent("OnBasketChange")}},{key:"handlerOrderSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemoveProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRestoreProductSuccess",value:function e(){this.emitOnBasketChange()}},{key:"handlerRemove",value:function e(t){var r=t.getData().index;var n=this.getItem(r);n.deleted="Y";n.status=i.Loader.status.wait;this.pool.add(i.Pool.action["delete"],r,{id:n.id,fields:{value:"Y"}});this.changeItem({index:r,fields:n});this.shelveCommit()}},{key:"handlerSuccessRemove",value:function e(t){var r=this;var n=t.getData().index;this.timer.create(5e3,n+"_DELETE",(function(){return r.removeItem({index:n}).then((function(){if(r.getBasket().length===0){r.store.dispatch("application/setStage",{stage:i.Application.stage.empty})}}))}))}},{key:"handlerRestore",value:function e(t){var r=t.getData().index;var n=this.getItem(r);this.timer.clean({index:r+"_DELETE"});n.deleted="N";n.status=i.Loader.status.wait;this.pool.add(i.Pool.action.restore,r,{basePrice:n.basePrice,baseSum:n.baseSum,currency:n.currency,discount:n.discount,id:n.id,measureText:n.measureText,module:n.module,name:n.name,price:n.price,product:n.product,productProviderClass:n.productProviderClass,props:n.props,quantity:n.quantity,sum:n.sum});this.changeItem({index:r,fields:n});this.shelveCommit()}},{key:"handlerChangeQuantity",value:function e(t){var r=t.getData().index;var n=this.getItem(r);var i=n.quantity;var a=n.product.ratio;var u=n.product.availableQuantity;i=s.Basket.roundValue(i);a=s.Basket.roundValue(a);i=isNaN(i)?0:i;if(a>0&&i<a){i=a}if(s.Product.isService(n));else{if(s.Product.isLimitedQuantity(n)){if(u>0&&i>u){i=u}}}i=s.Basket.toFixed(i,a,u);if(n.quantity!==i){this.setQuantity(r,i)}}},{key:"handlerQuantityPlus",value:function e(t){var r=t.getData().index;var n=this.getItem(r);var i=n.quantity;var a=n.product.ratio;var u=n.product.availableQuantity;i=s.Basket.roundValue(i);a=s.Basket.roundValue(a);i=i+a;if(s.Basket.isValueFloat(i)){i=s.Basket.roundFloatValue(i)}if(s.Product.isService(n));else{if(s.Product.isLimitedQuantity(n)){if(u>0&&i>u){i=u}}}i=s.Basket.toFixed(i,a,u);if(n.quantity<i){this.setQuantity(r,i)}}},{key:"handlerQuantityMinus",value:function e(t){var r=t.getData().index;var n=this.getItem(r);var i=n.quantity;var a=n.product.ratio;var u=n.product.availableQuantity;i=s.Basket.roundValue(i);a=s.Basket.roundValue(a);var o=i=i-a;if(s.Basket.isValueFloat(i)){i=s.Basket.roundFloatValue(i);o=s.Basket.roundFloatValue(o)}if(a>0&&i<a){i=a}if(s.Product.isService(n));else{if(s.Product.isLimitedQuantity(n)){if(u>0&&i>u){i=u}}}i=s.Basket.toFixed(i,a,u);if(o>=a){this.setQuantity(r,i)}}},{key:"commit",value:function e(){var r=this;return new Promise((function(e,n){var s={};if(r.pool.isEmpty()===false){s=r.pool.get();r.pool.clean();var a=i.Component.bitrixSaleOrderCheckout;var u=i.RestMethod.saleEntityRecalculateBasket;t.ajax.runComponentAction(a,u,{data:{actions:s},signedParameters:r.store.getters["application/getSignedParameters"]}).then((function(t){return r.executeRestAnswer(u,t,r.pool).then((function(){return r.commit().then((function(){return e()}))}))}))["catch"]()}else{e()}}))}},{key:"shelveCommit",value:function e(){var t=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"BASKET";if(this.isRunning()===false){this.timer.create(300,r,(function(){t.setRunningY();t.commit().then((function(){return t.setRunningN()}))}))}}},{key:"getStatus",value:function e(){return this.store.getters["basket/getStatus"]}},{key:"setStatusWait",value:function e(){var t={status:i.Loader.status.wait};return this.store.dispatch("basket/setStatus",t)}},{key:"setStatusNone",value:function e(){var t={status:i.Loader.status.none};return this.store.dispatch("basket/setStatus",t)}},{key:"handlerNeedRefreshY",value:function e(){this.setNeedRefreshY();this.setStatusWait()}},{key:"handlerNeedRefreshN",value:function e(){this.setNeedRefreshN();this.setStatusNone()}},{key:"setNeedRefreshY",value:function e(){var t={needRefresh:"Y"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"setNeedRefreshN",value:function e(){var t={needRefresh:"N"};return this.store.dispatch("basket/setNeedRefresh",t)}},{key:"handlerChangeSku",value:function e(t){var r=t.getData().data[0].ID;var n=t.getData().index;var s=this.getItem(n);s.status=i.Loader.status.wait;this.pool.add(i.Pool.action.offer,n,{id:s.id,fields:{offerId:r}});this.changeItem({index:n,fields:s});this.shelveCommit()}}]);return e}();var u=function(){function e(t){var r=this;babelHelpers.classCallCheck(this,e);this.init(t).then((function(){return r.initProvider()})).then((function(){return r.iniController()})).then((function(){return r.subscribeToEvents()})).then((function(){return r.subscribeToStoreChanges()}))}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.store=t.store;this.orderSaveAllowed=false;this.preselectedConsentsIsSubmitted=false;return new Promise((function(e,t){return e()}))}},{key:"isAllowOrderSave",value:function e(){return this.orderSaveAllowed}},{key:"allowOrderSave",value:function e(){this.orderSaveAllowed=true}},{key:"disallowOrderSave",value:function e(){this.orderSaveAllowed=false}},{key:"initProvider",value:function e(){this.provider=n.BasketRestHandler.create({store:this.store});return new Promise((function(e,t){return e()}))}},{key:"iniController",value:function e(){this.basket=(new a).setStore(this.store).setProvider(this.provider);return new Promise((function(e,t){return e()}))}},{key:"executeRestAnswer",value:function e(t,r,n){return this.provider.execute(t,r,n)}},{key:"subscribeToEvents",value:function e(){var n=this;r.EventEmitter.subscribe(i.EventType.order.success,(function(e){return n.basket.handlerOrderSuccess(e)}));r.EventEmitter.subscribe(i.EventType.basket.removeProduct,(function(e){return n.basket.handlerRemoveProductSuccess(e)}));r.EventEmitter.subscribe(i.EventType.basket.restoreProduct,(function(e){return n.basket.handlerRestoreProductSuccess(e)}));r.EventEmitter.subscribe(i.EventType.basket.buttonRemoveProduct,t.Runtime.debounce((function(e){return n.basket.handlerRemove(e)}),500,this));r.EventEmitter.subscribe(i.EventType.basket.buttonPlusProduct,(function(e){return n.basket.handlerQuantityPlus(e)}));r.EventEmitter.subscribe(i.EventType.basket.buttonMinusProduct,(function(e){return n.basket.handlerQuantityMinus(e)}));r.EventEmitter.subscribe(i.EventType.basket.inputChangeQuantityProduct,(function(e){return n.basket.handlerChangeQuantity(e)}));r.EventEmitter.subscribe(i.EventType.basket.buttonRestoreProduct,t.Runtime.debounce((function(e){return n.basket.handlerRestore(e)}),500,this));r.EventEmitter.subscribe(i.EventType.basket.needRefresh,(function(e){return n.basket.handlerNeedRefreshY(e)}));r.EventEmitter.subscribe(i.EventType.basket.refreshAfter,(function(e){return n.basket.handlerNeedRefreshN(e)}));r.EventEmitter.subscribe(i.EventType.basket.changeSku,(function(e){return n.basket.handlerChangeSku(e)}));r.EventEmitter.subscribe(i.EventType.consent.refused,(function(e){return n.handlerConsentRefused(e)}));r.EventEmitter.subscribe(i.EventType.consent.accepted,(function(e){return n.handlerConsentAccepted(e)}));r.EventEmitter.subscribe(i.EventType.property.validate,(function(e){return n.handlerValidateProperty(e)}));r.EventEmitter.subscribe(i.EventType.element.buttonCheckout,t.Runtime.debounce((function(){return n.handlerCheckout()}),1e3,this));r.EventEmitter.subscribe(i.EventType.element.buttonShipping,t.Runtime.debounce((function(){return n.handlerShipping()}),1e3,this));r.EventEmitter.subscribe(i.EventType.paysystem.beforeInitList,(function(){return n.paySystemSetStatusWait()}));r.EventEmitter.subscribe(i.EventType.paysystem.afterInitList,(function(){return n.paySystemSetStatusNone()}))}},{key:"subscribeToStoreChanges",value:function e(){return new Promise((function(e,t){return e()}))}},{key:"paySystemSetStatusWait",value:function e(){var t={status:i.Loader.status.wait};return this.store.dispatch("pay-system/setStatus",t)}},{key:"paySystemSetStatusNone",value:function e(){var t={status:i.Loader.status.none};return this.store.dispatch("pay-system/setStatus",t)}},{key:"appSetStatusWait",value:function e(){var t={status:i.Loader.status.wait};return this.store.dispatch("application/setStatus",t)}},{key:"appSetStatusNone",value:function e(){var t={status:i.Loader.status.none};return this.store.dispatch("application/setStatus",t)}},{key:"handlerConsentAccepted",value:function e(t){var r=t.getData()[0];this.store.dispatch("consent/setChecked",{id:r.config.id,checked:"Y"});if(this.isAllowOrderSave()){this.handlerCheckout()}}},{key:"handlerConsentRefused",value:function e(t){var r=t.getData()[0];this.store.dispatch("consent/setChecked",{id:r.config.id,checked:"N"});this.disallowOrderSave()}},{key:"sendEventsForCheckedConsents",value:function e(){var t=this.store.getters["consent/get"];t.items.forEach((function(e){if(e.checked==="Y"){r.EventEmitter.emit("".concat(i.Consent.validate.submit,"-").concat(e.id),[])}}))}},{key:"getFirstRequiredUncheckedConsentItem",value:function e(){var t=this.store.getters["consent/get"];return t.items.find((function(e){return e.required==="Y"&&e.checked==="N"}))}},{key:"handlerCheckout",value:function e(){var t=this;this.allowOrderSave();if(!this.preselectedConsentsIsSubmitted){this.sendEventsForCheckedConsents();this.preselectedConsentsIsSubmitted=true}var n=this.getFirstRequiredUncheckedConsentItem();if(n){r.EventEmitter.emit("".concat(i.Consent.validate.submit,"-").concat(n.id),[]);return}this.appSetStatusWait();this.saveOrder().then((function(){t.appSetStatusNone().then((function(){var e=t.store.getters["order/getOrder"];if(e.id>0){var r=s.History.pushState(t.store.getters["application/getPathLocation"],{accountNumber:e.accountNumber,access:e.hash});t.store.dispatch("application/setPathLocation",r)}}))}))["catch"]((function(){return t.appSetStatusNone()}))}},{key:"handlerShipping",value:function e(){this.store.dispatch("application/setStage",{stage:i.Application.stage.view});delete BX.UserConsent;var r=this.store.getters["order/getOrder"];if(r.id>0){var n=i.Component.bitrixSaleOrderCheckout;var s=i.RestMethod.saleEntityPaymentPay;return t.ajax.runComponentAction(n,s,{data:{fields:{orderId:r.id,accessCode:r.hash}},signedParameters:this.store.getters["application/getSignedParameters"]})}}},{key:"saveOrder",value:function e(){var r=this;var n=i.Component.bitrixSaleOrderCheckout;var s=i.RestMethod.saleEntitySaveOrder;return t.ajax.runComponentAction(n,s,{data:{fields:{siteId:this.store.getters["application/getSiteId"],personTypeId:this.store.getters["application/getPersonTypeId"],tradingPlatformId:this.store.getters["application/getTradingPlatformId"],properties:this.preparePropertyFields(this.getPropertyList())}},signedParameters:this.store.getters["application/getSignedParameters"]}).then((function(e){return r.executeRestAnswer(s,e)}))["catch"]((function(e){return r.executeRestAnswer(s,{error:e.errors})}))}},{key:"handlerValidateProperty",value:function e(t){var r={};r.index=t.getData().index;r.fields=this.getPropertyItem(r.index);this.changeValidatedProperty(r)}},{key:"getPropertyItem",value:function e(t){return this.store.getters["property/get"](t)}},{key:"changeValidatedProperty",value:function e(t){var r=t.fields;var n=this.store.getters["property/getErrors"];if(this.propertyDataValidate(r)){n=this.deletePropertyError(r,n)}else{n=this.addPropertyError(r,n)}this.provider.setModelPropertyError(n)}},{key:"propertyDataValidate",value:function e(t){return!(t.required==="Y"&&t.value==="")}},{key:"deletePropertyError",value:function e(t,r){for(var n in r){if(r[n].propertyId===t.id){r.splice(n,1)}}return r}},{key:"addPropertyError",value:function e(t,r){var n=r.map((function(e){return e.propertyId}));if(!n.includes(t.id)){r.push({propertyId:t.id})}return r}},{key:"getPropertyList",value:function e(){var t=[];var r=this.store.getters["property/getProperty"];try{for(var n in r){if(!r.hasOwnProperty(n)){continue}t[r[n].id]=r[n]}}catch(e){}return t}},{key:"preparePropertyFields",value:function e(t){var r={};t.forEach((function(e,t){r[t]=e.value}));return r}}]);return e}();e.Basket=a;e.Application=u})(this.BX.Sale.Checkout.Controller=this.BX.Sale.Checkout.Controller||{},BX,BX.Event,BX.Sale.Checkout.Provider,BX.Sale.Checkout.Const,BX.Sale.Checkout.Lib);
//# sourceMappingURL=controller.bundle.map.js