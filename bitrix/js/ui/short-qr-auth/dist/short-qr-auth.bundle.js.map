{"version":3,"file":"short-qr-auth.bundle.js","sources":["../src/short-qr-auth.js"],"sourcesContent":["import { ajax, Cache, Dom, Tag, Type, Loc } from 'main.core';\nimport 'main.qrcode';\nimport { AirButtonStyle, Button } from 'ui.buttons';\nimport { PULL } from 'pull.client';\nimport { Loader } from 'main.loader';\nimport './style.css';\n\nexport type ShortQrAuthOptions = {\n\tintent?: string;\n\tttl?: number;\n\tsmall?: boolean;\n\tstub?: boolean;\n};\n\nexport class ShortQrAuth\n{\n\t#cache = new Cache.MemoryCache();\n\t#intent: string;\n\t#ttl: number;\n\t#ttlInterval: number;\n\t#small: boolean;\n\t#stub: boolean;\n\n\tconstructor(options: ShortQrAuthOptions = {})\n\t{\n\t\tthis.#intent = Type.isString(options.intent) ? options.intent : 'default';\n\t\tthis.#small = Type.isBoolean(options.small) ? options.small : false;\n\t\tthis.#ttl = Type.isNumber(options.ttl) ? options.ttl : 60;\n\t\tthis.#stub = Type.isBoolean(options.stub) ? options.stub : true;\n\t}\n\n\trender(): HTMLElement\n\t{\n\t\treturn this.#getContainer();\n\t}\n\n\t#getContainer(): HTMLElement\n\t{\n\t\treturn this.#cache.remember('container', () => {\n\t\t\tconst qrNode = this.#getQrNode();\n\n\t\t\tif (!this.#stub)\n\t\t\t{\n\t\t\t\tthis.#addQrCodeImage();\n\t\t\t}\n\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-short-qr-auth__container ${this.#small ? '--small' : ''}\">\n\t\t\t\t\t<div class=\"ui-short-qr-auth__corner --top-left\"></div>\n\t\t\t\t\t<div class=\"ui-short-qr-auth__corner --top-right\"></div>\n\t\t\t\t\t<div class=\"ui-short-qr-auth__corner --bottom-left\"></div>\n\t\t\t\t\t<div class=\"ui-short-qr-auth__corner --bottom-right\"></div>\n\t\t\t\t\t${qrNode}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getQrNode(): HTMLElement\n\t{\n\t\treturn this.#cache.remember('qrNode', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-short-qr-auth__qr\">\n\t\t\t\t\t${this.#stub ? this.#getQrStub() : null}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getQrStub(): HTMLElement\n\t{\n\t\treturn this.#cache.remember('qrStub', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"ui-short-qr-auth__qr-stub\">\n\t\t\t\t\t<i class=\"ui-icon-set --o-qr-code ui-short-qr-auth__qr-stub-icon\"></i>\n\t\t\t\t\t${this.#getShowQrButton().render()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#getShowQrButton(): Button\n\t{\n\t\treturn this.#cache.remember('showQrButton', () => {\n\t\t\treturn new Button({\n\t\t\t\tsize: Button.Size.EXTRA_SMALL,\n\t\t\t\ttext: Loc.getMessage('UI_SHORT_QR_AUTH_BUTTON_TITLE'),\n\t\t\t\tuseAirDesign: true,\n\t\t\t\tmaxWidth: 117,\n\t\t\t\tstyle: AirButtonStyle.TINTED,\n\t\t\t\tnoCaps: true,\n\t\t\t\twide: true,\n\t\t\t\tonclick: () => {\n\t\t\t\t\tthis.#addQrCodeImage();\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n\n\t#addQrCodeImage(): void\n\t{\n\t\tthis.#createQrCodeImage();\n\n\t\tif (!this.#ttlInterval)\n\t\t{\n\t\t\tthis.#ttlInterval = setInterval(() => {\n\t\t\t\tthis.#createQrCodeImage();\n\t\t\t}, this.#ttl * 1000);\n\t\t}\n\t}\n\n\t#clean(): void\n\t{\n\t\tDom.clean(this.#getQrNode());\n\t}\n\n\t#loading(): void\n\t{\n\t\tthis.#clean();\n\t\t(new Loader({ size: 60 })).show(this.#getQrNode());\n\t}\n\n\t#createQrCodeImage(): void\n\t{\n\t\tthis.#loading();\n\t\tajax.runAction('mobile.deeplink.get', {\n\t\t\tdata: {\n\t\t\t\tintent: this.#intent,\n\t\t\t\tttl: this.#ttl,\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tconst link = response.data?.link;\n\t\t\tif (link)\n\t\t\t{\n\t\t\t\tthis.#clean();\n\t\t\t\t// eslint-disable-next-line no-undef\n\t\t\t\tnew QRCode(this.#getQrNode(), {\n\t\t\t\t\ttext: link,\n\t\t\t\t\twidth: this.#getQrSize(),\n\t\t\t\t\theight: this.#getQrSize(),\n\t\t\t\t});\n\n\t\t\t\tif (!this.isSubscribe)\n\t\t\t\t{\n\t\t\t\t\tthis.isSubscribe = true;\n\t\t\t\t\tthis.#subscribeEventRefresh();\n\t\t\t\t}\n\t\t\t}\n\t\t}).catch(() => {});\n\t}\n\n\t#getQrSize(): number\n\t{\n\t\treturn this.#small ? 98 : 151;\n\t}\n\n\t#subscribeEventRefresh()\n\t{\n\t\tif (PULL)\n\t\t{\n\t\t\tPULL.subscribe({\n\t\t\t\ttype: 'BX.PullClient.SubscriptionType.Server',\n\t\t\t\tmoduleId: 'mobile',\n\t\t\t\tcommand: 'onDeeplinkShouldRefresh',\n\t\t\t\tcallback: () => {\n\t\t\t\t\tthis.#createQrCodeImage();\n\t\t\t\t},\n\t\t\t});\n\t\t}\n\t}\n}\n"],"names":["ShortQrAuth","constructor","options","Cache","MemoryCache","Type","isString","intent","isBoolean","small","isNumber","ttl","stub","render","remember","qrNode","Tag","Button","size","Size","EXTRA_SMALL","text","Loc","getMessage","useAirDesign","maxWidth","style","AirButtonStyle","TINTED","noCaps","wide","onclick","setInterval","Dom","clean","Loader","show","ajax","runAction","data","then","response","link","QRCode","width","height","isSubscribe","catch","PULL","subscribe","type","moduleId","command","callback"],"mappings":"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"}