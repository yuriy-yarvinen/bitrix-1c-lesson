{"version":3,"file":"menu-configurable.bundle.js","sources":["../src/menu-configurable.js"],"sourcesContent":["import { Dom, Loc, Runtime, Type } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport type { MenuItemOptions } from 'main.popup';\nimport { Menu as MainMenu, MenuManager } from 'main.popup';\nimport { Draggable } from 'ui.draganddrop.draggable';\n\nexport type Parameters = {\n\tid: string,\n\titems: Item[],\n\tbindElement: ?HTMLElement,\n\tmaxVisibleItems: ?number,\n\tmaxWidth: ?number,\n}\n\nexport type Item = {\n\tisHidden: boolean,\n\ttext: ?string,\n\thtml: ?string,\n\tid: ?string,\n\tonclick: ?Function,\n}\n\nexport class Menu extends EventEmitter\n{\n\t#id: string;\n\t#items: Array;\n\t#menu: MainMenu;\n\t#bindElement: ?HTMLElement;\n\t#draggable: Draggable;\n\t#promise: Promise;\n\t#closeResolver: Function;\n\t#maxVisibleItems: number = 0;\n\t#maxWidth: ?number;\n\n\tconstructor(parameters: Parameters)\n\t{\n\t\tsuper();\n\n\t\tthis.#id = Type.isStringFilled(parameters.id)\n\t\t\t? parameters.id\n\t\t\t: `settings-popup-${Math.random().toString().slice(2)}`\n\t\t;\n\t\tthis.#items = parameters.items;\n\t\tthis.#bindElement = parameters.bindElement;\n\t\tthis.#maxVisibleItems = Number(parameters.maxVisibleItems);\n\t\tthis.#maxWidth = Type.isNumber(parameters.maxWidth) ? parameters.maxWidth : null;\n\t\tthis.#createMenu();\n\n\t\tthis.setEventNamespace('BX.UI.MenuConfigurable.Menu');\n\t}\n\n\topen(bindElement: ?HTMLElement): Promise\n\t{\n\t\tif (bindElement)\n\t\t{\n\t\t\tthis.#menu?.getPopupWindow().setBindElement(bindElement);\n\t\t}\n\t\tthis.#menu?.show();\n\n\t\tif (!this.#promise)\n\t\t{\n\t\t\tthis.#promise = new Promise((resolve) => {\n\t\t\t\tthis.#closeResolver = resolve;\n\t\t\t});\n\t\t}\n\n\t\treturn this.#promise;\n\t}\n\n\t#resolveWithCancel(): void\n\t{\n\t\tthis.#promise = null;\n\t\tif (this.#closeResolver)\n\t\t{\n\t\t\tthis.#closeResolver({ isCanceled: true });\n\t\t}\n\t\tthis.#closeResolver = null;\n\t}\n\n\t#resolveWithItems(): void\n\t{\n\t\tthis.#promise = null;\n\t\tif (this.#closeResolver)\n\t\t{\n\t\t\tthis.#closeResolver({ items: this.#items });\n\t\t}\n\t\tthis.#closeResolver = null;\n\t}\n\n\tclose(): void\n\t{\n\t\tthis.#createMenu();\n\t\tthis.#resolveWithCancel();\n\t}\n\n\tsetItems(items: Item[]): this\n\t{\n\t\tthis.#items = items;\n\n\t\treturn this;\n\t}\n\n\t#getItemById(id: string): ?Item\n\t{\n\t\treturn this.#items.find((item) => item.id === id);\n\t}\n\n\tgetItemsFromMenu(): Item[]\n\t{\n\t\tconst items = [];\n\t\tlet isHidden = false;\n\n\t\tthis.#menu.itemsContainer.querySelectorAll('.menu-configurable-item').forEach((node: HTMLElement) => {\n\t\t\tif (Dom.hasClass(node, 'menu-configurable-hidden-section-title'))\n\t\t\t{\n\t\t\t\tisHidden = true;\n\t\t\t}\n\t\t\tconst itemId = node.dataset.id;\n\t\t\tconst item = this.#getItemById(itemId);\n\t\t\tif (item)\n\t\t\t{\n\t\t\t\tconst clonedItem = Runtime.clone(item);\n\t\t\t\tclonedItem.isHidden = isHidden;\n\t\t\t\titems.push(clonedItem);\n\t\t\t}\n\t\t});\n\n\t\treturn items;\n\t}\n\n\t#createMenu(bindElement: ?HTLMElement): Menu\n\t{\n\t\tif (this.#menu)\n\t\t{\n\t\t\tthis.#menu.destroy();\n\t\t\tthis.#draggable = null;\n\t\t}\n\n\t\tconst menuItems = [];\n\t\tmenuItems.push(this.#getVisibleSectionTitleItem());\n\t\tconst visibleItems = this.#items.filter((item) => !item.isHidden);\n\t\tconst hiddenItems = this.#items.filter((item) => item.isHidden);\n\t\tvisibleItems.forEach((item) => {\n\t\t\tmenuItems.push(this.#getMenuItem(item));\n\t\t});\n\t\tmenuItems.push(this.#getHiddenSectionTitleItem());\n\t\thiddenItems.forEach((item) => {\n\t\t\tmenuItems.push(this.#getMenuItem(item));\n\t\t});\n\t\tmenuItems.push(\n\t\t\tthis.#getSaveItem(),\n\t\t\tthis.#getCancelItem(),\n\t\t);\n\n\t\tthis.#menu = MenuManager.create({\n\t\t\tid: this.#id,\n\t\t\titems: menuItems,\n\t\t\tbindElement: bindElement ?? this.#bindElement,\n\t\t\tevents: {\n\t\t\t\tonClose: this.close.bind(this),\n\t\t\t},\n\t\t\tmaxWidth: this.#maxWidth,\n\t\t});\n\n\t\tthis.#initDraggable();\n\n\t\treturn this.#menu;\n\t}\n\n\t#getSaveItem(): MenuItemOptions\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('UI_JS_MENU_CONFIGURABLE_SAVE'),\n\t\t\tonclick: this.#save.bind(this),\n\t\t};\n\t}\n\n\t#getCancelItem(): MenuItemOptions\n\t{\n\t\treturn {\n\t\t\ttext: Loc.getMessage('UI_JS_MENU_CONFIGURABLE_CANCEL'),\n\t\t\tonclick: this.#cancel.bind(this),\n\t\t};\n\t}\n\n\t#save(): void\n\t{\n\t\tconst event = new BaseEvent();\n\t\tthis.emit('Save', event);\n\t\tif (event.isDefaultPrevented())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#saveItemsFromMenu();\n\t\tthis.#resolveWithItems();\n\t\tthis.#createMenu();\n\t}\n\n\t#cancel(): void\n\t{\n\t\tconst event = new BaseEvent();\n\t\tthis.emit('Cancel', event);\n\t\tif (event.isDefaultPrevented())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.close();\n\t}\n\n\t#getMenuItem(item: Item): MenuItemOptions\n\t{\n\t\treturn {\n\t\t\tid: item.id,\n\t\t\ttext: item.text,\n\t\t\thtml: item.html,\n\t\t\tclassName: 'menu-configurable-item',\n\t\t\tdataset: {\n\t\t\t\tid: item.id,\n\t\t\t},\n\t\t};\n\t}\n\n\t#getVisibleSectionTitleItem(): MenuItemOptions\n\t{\n\t\treturn {\n\t\t\tdelimiter: true,\n\t\t\thtml: `<span>${Loc.getMessage('UI_JS_MENU_CONFIGURABLE_VISIBLE')}</span>`,\n\t\t\tclassName: 'menu-configurable-visible-section-title menu-configurable-delimiter-item',\n\t\t};\n\t}\n\n\t#getHiddenSectionTitleItem(): MenuItemOptions\n\t{\n\t\treturn {\n\t\t\tdelimiter: true,\n\t\t\thtml: `<span>${Loc.getMessage('UI_JS_MENU_CONFIGURABLE_HIDDEN')}</span>`,\n\t\t\tclassName: 'menu-configurable-hidden-section-title menu-configurable-delimiter-item menu-configurable-item',\n\t\t};\n\t}\n\n\t#initDraggable(): void\n\t{\n\t\tthis.#draggable = new Draggable({\n\t\t\tcontainer: this.#menu.itemsContainer,\n\t\t\tdraggable: '.menu-configurable-item',\n\t\t\tdragElement: '.menu-popup-item-icon',\n\t\t\ttype: Draggable.MOVE,\n\t\t});\n\t\tthis.#draggable.subscribe('end', this.#adjustMaxVisibleItems.bind(this));\n\t}\n\n\t#saveItemsFromMenu(): void\n\t{\n\t\tthis.setItems(this.getItemsFromMenu());\n\t}\n\n\t#getItemNode(item: Item): ?HTMLElement\n\t{\n\t\treturn this.#menu.itemsContainer.querySelector(`.menu-configurable-item[data-id=\"${item.id}\"]`);\n\t}\n\n\t#getHiddenSectionTitleNode(): ?HTMLElement\n\t{\n\t\treturn this.#menu.itemsContainer.querySelector('.menu-configurable-hidden-section-title');\n\t}\n\n\t#adjustMaxVisibleItems(): void\n\t{\n\t\tif (this.#maxVisibleItems <= 0)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst runtimeItems = this.getItemsFromMenu();\n\t\tconst visibleItems = runtimeItems.filter((item) => !item.isHidden);\n\t\tconst visibleItemsCount = visibleItems.length;\n\t\tconst hiddenSectionTitleNode = this.#getHiddenSectionTitleNode();\n\t\tif (hiddenSectionTitleNode && visibleItemsCount > this.#maxVisibleItems)\n\t\t{\n\t\t\tfor (let index = this.#maxVisibleItems; index < visibleItemsCount; index++)\n\t\t\t{\n\t\t\t\tconst item = visibleItems[index];\n\t\t\t\tconst node = this.#getItemNode(item);\n\t\t\t\tif (node)\n\t\t\t\t{\n\t\t\t\t\tDom.insertAfter(node, hiddenSectionTitleNode);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n"],"names":["Menu","EventEmitter","constructor","parameters","Type","isStringFilled","id","Math","random","toString","slice","items","bindElement","Number","maxVisibleItems","isNumber","maxWidth","setEventNamespace","open","getPopupWindow","setBindElement","show","Promise","resolve","close","setItems","getItemsFromMenu","isHidden","itemsContainer","querySelectorAll","forEach","node","Dom","hasClass","itemId","dataset","item","clonedItem","Runtime","clone","push","isCanceled","find","destroy","menuItems","visibleItems","filter","hiddenItems","MenuManager","create","events","onClose","bind","text","Loc","getMessage","onclick","event","BaseEvent","emit","isDefaultPrevented","html","className","delimiter","Draggable","container","draggable","dragElement","type","MOVE","subscribe","querySelector","runtimeItems","visibleItemsCount","length","hiddenSectionTitleNode","index","insertAfter"],"mappings":"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"}