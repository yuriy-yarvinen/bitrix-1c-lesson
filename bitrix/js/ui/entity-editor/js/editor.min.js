BX.namespace("BX.UI");if(typeof BX.UI.EntityEditor==="undefined"){BX.UI.EntityEditor=function(){this._id="";this._settings={};this._entityTypeName="";this._entityId=0;this._userFieldManager=null;this.additionalFieldsData={};this._container=null;this._layoutContainer=null;this._buttonContainer=null;this._createSectionButton=null;this._configMenuButton=null;this._configIcon=null;this._pageTitle=null;this._pageTitleInput=null;this._buttonWrapper=null;this._editPageTitleButton=null;this._copyPageUrlButton=null;this._actionTypes=null;this._formElement=null;this._ajaxForm=null;this._ajaxForms=null;this._reloadAjaxForm=null;this._formSubmitHandler=BX.delegate(this.onFormSubmit,this);this._controllers=null;this._controls=null;this._activeControls=null;this._toolPanel=null;this._model=null;this._scheme=null;this._config=null;this._context=null;this._contextId="";this._externalContextId="";this._mode=BX.UI.EntityEditorMode.intermediate;this._isNew=false;this._readOnly=false;this._enableRequiredUserFieldCheck=true;this._enableAjaxForm=true;this._enableSectionEdit=false;this._enableSectionCreation=false;this._enableModeToggle=true;this._enableVisibilityPolicy=true;this._enablePageTitleControls=true;this._enableToolPanel=true;this._isToolPanelAlwaysVisible=false;this._enableBottomPanel=true;this._enableConfigControl=true;this._enableFieldsContextMenu=true;this._canHideField=true;this._serviceUrl="";this._htmlEditorConfigs=null;this._pageTitleExternalClickHandler=BX.delegate(this.onPageTitleExternalClick,this);this._pageTitleKeyPressHandler=BX.delegate(this.onPageTitleKeyPress,this);this._toolbarBeforeStartEditingHandler=BX.delegate(this.onToolbarBeforeStartEditing,this);this._toolbarFinishEditingHandler=BX.delegate(this.onToolbarFinishEditing,this);this._validators=null;this._modeSwitch=null;this._delayedSaveHandle=0;this._isEmbedded=false;this._isRequestRunning=false;this._isConfigMenuShown=false;this._isReleased=false;this._enableCloseConfirmation=true;this._closeConfirmationHandler=BX.delegate(this.onCloseConfirmButtonClick,this);this._cancelConfirmationHandler=BX.delegate(this.onCancelConfirmButtonClick,this);this._windowResizeHandler=BX.debounce(BX.delegate(this.onResize,this),50);this._sliderOpenHandler=BX.delegate(this.onSliderOpen,this);this._sliderCloseHandler=BX.delegate(this.onSliderClose,this);this._areAvailableSchemeElementsChanged=false;this._availableSchemeElements=null;this._dragPlaceHolder=null;this._dragContainerController=null;this._dropHandler=BX.delegate(this.onDrop,this);this._dragConfig={};this.eventsNamespace="BX.UI.EntityEditor";this.pageTitleInputClassName="pagetitle-item";this._configurationFieldManager=null;this._commonConfigEditUrl=BX.prop.getString(this._settings,"commonConfigEditUrl","/configs/editor/?ENTITY_TYPE_ID=#ENTITY_TYPE_ID_VALUE#&MODULE_ID=#MODULE_ID#");this._canBeMultipleFields=true;this.moduleId=null;this._restrictions={};this.eventIds=new Set;this.needReloadStorageKey="UI.EntityEditor.needReload";this._attributeManager=null;this._validationEnabled=true};BX.UI.EntityEditor.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._model=BX.prop.get(this._settings,"model",null);this._scheme=BX.prop.get(this._settings,"scheme",null);this._config=BX.prop.get(this._settings,"config",null);this._serviceUrl=BX.prop.getString(this._settings,"serviceUrl","");this._entityTypeName=BX.prop.getString(this._settings,"entityTypeName","");this._entityTypeTitle=BX.prop.getString(this._settings,"entityTypeTitle","");this._useFieldsSearch=BX.prop.getBoolean(this._settings,"useFieldsSearch",false);this._useForceFieldsAdd=BX.prop.getBoolean(this._settings,"useForceFieldsAdd",true);this._entityId=BX.prop.getInteger(this._settings,"entityId",0);this.moduleId=BX.prop.getString(this._settings,"moduleId","");this._isNew=this._entityId<=0&&this._model.isIdentifiable();this.additionalFieldsData=BX.prop.getObject(this._settings,"additionalFieldsData",{});this._isEmbedded=BX.prop.getBoolean(this._settings,"isEmbedded",false);this._creationFieldPageUrl=BX.prop.getBoolean(this._settings,"creationFieldPageUrl",false);var i=BX.prop.get(this._settings,"container");if(!BX.type.isElementNode(i)){i=BX(BX.prop.get(this._settings,"containerId"))||top.BX(BX.prop.get(this._settings,"containerId"))}this._container=i;this._parentContainer=BX.findParent(this._container,{className:"ui-entity-section"},false);this._buttonContainer=BX(BX.prop.get(this._settings,"buttonContainerId"));this._configIcon=BX(BX.prop.get(this._settings,"configIconId"));this._canHideField=BX.prop.getBoolean(this._settings,"canHideField",true);this._canBeMultipleFields=BX.prop.getBoolean(this._settings,"canBeMultipleFields",true);this._enableShowAlwaysFeauture=BX.prop.getBoolean(this._settings,"enableShowAlwaysFeauture",true);this._enableVisibilityPolicy=BX.prop.getBoolean(this._settings,"enableVisibilityPolicy",true);this.initializePageTitleControls();this.adjustSize();this.adjustTitle();var n=BX.prop.getString(this._settings,"formTagName","form");this._formElement=BX.create(n,{props:{name:this._id+"_form"}});this._container.appendChild(this._formElement);this._layoutContainer=BX.create("div",{props:{className:"ui-entity-editor-column-wrapper"}});this._formElement.appendChild(this._layoutContainer);this._enableRequiredUserFieldCheck=BX.prop.getBoolean(this._settings,"enableRequiredUserFieldCheck",true);this._enableAjaxForm=BX.prop.getBoolean(this._settings,"enableAjaxForm",true);if(this._enableAjaxForm){this.initializeAjaxForm()}this._restrictions=BX.prop.getObject(this._settings,"restrictions",{});this.initializeManagers();this._context=BX.prop.getObject(this._settings,"context",{});this._contextId=BX.prop.getString(this._settings,"contextId","");this._externalContextId=BX.prop.getString(this._settings,"externalContextId","");this._readOnly=BX.prop.getBoolean(this._settings,"readOnly",false);if(this._readOnly){this._enableSectionEdit=this._enableSectionCreation=false}else{this._enableSectionEdit=BX.prop.getBoolean(this._settings,"enableSectionEdit",false);this._enableSectionCreation=BX.prop.getBoolean(this._settings,"enableSectionCreation",false)}this._controllers=[];this._controls=[];this._activeControls=[];this._modeSwitch=BX.UI.EntityEditorModeSwitch.create(this._id,{editor:this});this._htmlEditorConfigs=BX.prop.getObject(this._settings,"htmlEditorConfigs",{});var o=BX.UI.EntityEditorMode.view;if(!this._readOnly){o=BX.UI.EntityEditorMode.parse(BX.prop.getString(this._settings,"initialMode",""))}this._mode=o!==BX.UI.EntityEditorMode.intermediate?o:BX.UI.EntityEditorMode.view;this._enableModeToggle=false;if(!this._readOnly){this._enableModeToggle=BX.prop.getBoolean(this._settings,"enableModeToggle",true)}if(this._isNew&&!this._readOnly){this._mode=BX.UI.EntityEditorMode.edit}this._availableSchemeElements=this._scheme.getAvailableElements();this.initializeControllers();this.initializeControls();if(this._mode===BX.UI.EntityEditorMode.edit&&this._controls.length>0){this.initializeControlsEditMode()}this.initializeValidators();this._enableToolPanel=BX.prop.getBoolean(this._settings,"enableToolPanel",true);this._isToolPanelAlwaysVisible=BX.prop.getBoolean(this._settings,"isToolPanelAlwaysVisible",false);if(this._enableToolPanel){this.initializeToolPanel();if(this.isToolPanelAlwaysVisible()){this.showToolPanel()}}this._enableBottomPanel=BX.prop.getBoolean(this._settings,"enableBottomPanel",true);this._enableConfigControl=BX.prop.getBoolean(this._settings,"enableConfigControl",true);this._enableFieldsContextMenu=BX.prop.getBoolean(this._settings,"enableFieldsContextMenu",true);this.initializeDragDrop();this.layout();this.attachToEvents();this.initPull();var s={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,this.eventsNamespace+":onInit",[this,s])},initializeControllers:function(){var e,t;var i=BX.prop.getArray(this._settings,"controllers",[]);for(e=0,t=i.length;e<t;e++){var n=this.createController(i[e]);if(n){this._controllers.push(n)}}},initializeControls:function(){var e=this._scheme.getElements();var t,i,n,o;for(t=0,i=e.length;t<i;t++){n=e[t];o=this.createControl(n.getType(),n.getName(),{schemeElement:n,mode:BX.UI.EntityEditorMode.view});if(!o){continue}this._controls.push(o)}},initializeControlsEditMode:function(){var e,t;for(e=0,t=this._controls.length;e<t;e++){this._controls[e].setMode(BX.UI.EntityEditorMode.edit,{notify:false})}},initializeValidators:function(){var e,t;this._validators=[];var i=BX.prop.getArray(this._settings,"validators",[]);for(e=0,t=i.length;e<t;e++){var n=this.createValidator(i[e]);if(n){this._validators.push(n)}}},initializeToolPanel:function(){var e=BX.prop.getObject(this._settings,"toolPanelButtonsOrder",{});var t=BX.prop.getArray(this._settings,"customToolPanelButtons",[]);this._toolPanel=BX.UI.EntityEditorToolPanel.create(this._id,{container:this._isEmbedded?this._formElement:document.body,editor:this,visible:false,buttonsOrder:e,customButtons:t})},initializeDragDrop:function(){this._dragConfig={};var e={};e[BX.UI.EntityEditorMode.names.view]=e[BX.UI.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableSectionDragDrop",true);this._dragConfig[BX.UI.EditorDragObjectType.section]={scope:BX.UI.EditorDragScope.form,modes:e};var t={};t[BX.UI.EntityEditorMode.names.view]=t[BX.UI.EntityEditorMode.names.edit]=BX.prop.getBoolean(this._settings,"enableFieldDragDrop",true);this._dragConfig[BX.UI.EditorDragObjectType.field]={scope:BX.UI.EditorDragScope.form,modes:t}},initializeManagers:function(){this._userFieldManager=BX.prop.get(this._settings,"userFieldManager",null);this._configurationFieldManager=BX.UI.EntityConfigurationManager.create(this._id,{editor:this});let e={id:this._id,editor:this,type:"editor",configurationFieldManager:this._configurationFieldManager};BX.onCustomEvent(window,"BX.UI.EntityConfigurationManager:onInitialize",[this,e]);this._configurationFieldManager=e.configurationFieldManager},initializeCustomEditors:function(){},initializePageTitleControls:function(){this._enablePageTitleControls=BX.prop.getBoolean(this._settings,"enablePageTitleControls",true);if(!this._enablePageTitleControls){return}this._enablePageTitleControlsViaToolbar=BX.prop.getBoolean(this._settings,"enablePageTitleControlsViaToolbar",false);if(!this._enablePageTitleControlsViaToolbar){this._pageTitle=BX("pagetitle");this._buttonWrapper=BX("pagetitle_btn_wrapper");this._editPageTitleButton=BX("pagetitle_edit");this._copyPageUrlButton=BX("page_url_copy_btn");return}const e=BX.Reflection.getClass("BX.UI.ToolbarManager")&&BX.UI.ToolbarManager.getDefaultToolbar();if(!e){return}this._toolbar=e},attachToEvents:function(){BX.bind(window,"resize",this._windowResizeHandler);BX.addCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.addCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);if(this._enablePageTitleControls&&this._enablePageTitleControlsViaToolbar&&this._toolbar){this._toolbar.subscribe(BX.UI.ToolbarEvents.beforeStartEditing,this._toolbarBeforeStartEditingHandler);this._toolbar.subscribe(BX.UI.ToolbarEvents.finishEditing,this._toolbarFinishEditingHandler)}},deattachFromEvents:function(){BX.unbind(window,"resize",this._windowResizeHandler);BX.removeCustomEvent("SidePanel.Slider:onOpenComplete",this._sliderOpenHandler);BX.removeCustomEvent("SidePanel.Slider:onClose",this._sliderCloseHandler);if(this._enablePageTitleControls&&this._enablePageTitleControlsViaToolbar&&this._toolbar){this._toolbar.unsubscribe(BX.UI.ToolbarEvents.beforeStartEditing,this._toolbarBeforeStartEditingHandler);this._toolbar.unsubscribe(BX.UI.ToolbarEvents.finishEditing,this._toolbarFinishEditingHandler)}},initPull:function(){const e=this._settings;BX.Event.ready((()=>{if(!e.pullTag||!e.pullModuleId||!e.canUsePull){return}const t=BX.PULL;if(!t){console.error("pull is not initialized");return}const i=new BX.UI.EntityPull({editor:this});t.subscribe({moduleId:e.pullModuleId,callback:t=>{if(t.command!==e.pullTag){return}const n=t.params.eventId??null;if(n&&this.eventIds.has(n)){return}if(t.params.eventName==="ITEMUPDATED"){i.onItemUpdated()}}});t.extendWatch(e.pullTag);BX.Event.bind(document,"visibilitychange",(()=>{if(document.hidden){return}const e=window.sessionStorage.getItem(this.needReloadStorageKey);if(e==="Y"){window.sessionStorage.removeItem(this.needReloadStorageKey);BX.Crm.EntityEditor.getDefault().reload()}}))}))},release:function(){for(var e=0,t=this._controls.length;e<t;e++){this._controls[e].clearLayout()}this.deattachFromEvents();this.releaseAjaxForm();this.releaseReloadAjaxForm();this._attributeManager=null;this._container=BX.remove(this._container);this._isReleased=true},onSliderOpen:function(e){this._enableCloseConfirmation=true;var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeId:this._entityTypeId,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,this.eventsNamespace+":onOpen",[this,t])},onSliderClose:function(e){if(!this._enableCloseConfirmation||this.isEmbedded()){return}var t=top.BX.SidePanel.Instance.getSliderByWindow(window);if(t!==e.getSlider()){return}if(!t.isOpen()){return}if(!this.hasChangedControls()&&!this.hasChangedControllers()){return}e.denyAction();if(BX.UI.EditorAuxiliaryDialog.isItemOpened("close_confirmation")){return}BX.UI.EditorAuxiliaryDialog.create("close_confirmation",{title:BX.message("UI_ENTITY_EDITOR_CONFIRMATION"),content:BX.message("UI_ENTITY_EDITOR_CLOSE_CONFIRMATION"),zIndex:100,buttons:[{id:"close",type:BX.UI.DialogButtonType.accept,text:BX.message("JS_CORE_WINDOW_CLOSE"),callback:this._closeConfirmationHandler},{id:"cancel",type:BX.UI.DialogButtonType.cancel,text:BX.message("JS_CORE_WINDOW_CANCEL"),callback:this._closeConfirmationHandler}]}).open()},onCloseConfirmButtonClick:function(e){e.getDialog().close();if(e.getId()==="close"){this._enableCloseConfirmation=false;top.BX.SidePanel.Instance.getSliderByWindow(window).close()}},initializeAjaxForm:function(){if(this._ajaxForm){return}var e=BX.prop.getObject(this._settings,"ajaxData",{});var t=BX.prop.getString(e,"ACTION_NAME","");var i=BX.prop.getString(e,"COMPONENT_NAME","");var n=BX.prop.getString(e,"SIGNED_PARAMETERS","");this._ajaxForms={};this._actionTypes={};this._actionTypes[BX.UI.EntityEditorActionIds.defaultActionId]=BX.UI.EntityEditorActionTypes.save;var o=this.createAjaxForm({componentName:i,actionName:t,elementNode:this._formElement,signedParameters:n,enableRequiredUserFieldCheck:this._enableRequiredUserFieldCheck},{onSuccess:this.onSaveSuccess.bind(this),onFailure:this.onSaveFailure.bind(this)});this._ajaxForms[BX.UI.EntityEditorActionIds.defaultActionId]=o;BX.addCustomEvent(o,"onAfterSubmit",this._formSubmitHandler);if(e.ADDITIONAL_ACTIONS&&e.ADDITIONAL_ACTIONS.length>0){var s=e.ADDITIONAL_ACTIONS;for(var r=0;r<s.length;r++){var a=s[r];this._actionTypes[a.ID]=a.ACTION_TYPE;var l=this.createAjaxForm({componentName:i,actionName:a.ACTION,elementNode:this._formElement,signedParameters:n,enableRequiredUserFieldCheck:this._enableRequiredUserFieldCheck},{onSuccess:this.onSaveSuccess.bind(this),onFailure:this.onSaveFailure.bind(this)});BX.addCustomEvent(l,"onAfterSubmit",this._formSubmitHandler);this._ajaxForms[a.ID]=l}}this._ajaxForm=this._ajaxForms[BX.UI.EntityEditorActionIds.defaultActionId];this._formElement.setAttribute("onsubmit","return false;")},createAjaxForm:function(e,t){var i=BX.prop.getString(e,"componentName","");var n=BX.prop.getString(e,"actionName","");var o=BX.prop.getElementNode(e,"elementNode",null);var s=BX.prop.getObject(e,"formData",null);if(i!==""){if(n===""){n="save"}return BX.UI.ComponentAjax.create(this._id,{elementNode:o,formData:s,className:i,signedParameters:BX.prop.getString(e,"signedParameters",null),actionName:n,callbacks:{onSuccess:t?t.onSuccess:null,onFailure:t?t.onFailure:null}})}else{if(n===""){n="SAVE"}return BX.UI.AjaxForm.create(this._id,{elementNode:o,formData:s,config:{url:this._serviceUrl,method:"POST",dataType:"json",processData:true,onsuccess:t?t.onSuccess:null,data:Object.assign({ACTION:n,ENABLE_REQUIRED_USER_FIELD_CHECK:BX.prop.getBoolean(e,"enableRequiredUserFieldCheck",false)?"Y":"N"},this.getAjaxFormConfigData())}})}},getAjaxFormConfigData:function(){return{ACTION_ENTITY_TYPE:this._entityTypeName}},releaseAjaxForm:function(){if(!this._ajaxForm){return}var e=this;if(BX.Type.isObject(this._ajaxForms)){Object.keys(this._ajaxForms).forEach((function(t){BX.removeCustomEvent(e._ajaxForms[t],"onAfterSubmit",e._formSubmitHandler);e._ajaxForms[t]=null}))}BX.removeCustomEvent(this._ajaxForm,"onAfterSubmit",this._formSubmitHandler);this._ajaxForm=null},releaseReloadAjaxForm:function(){if(!this._reloadAjaxForm){return}this._reloadAjaxForm=null},getId:function(){return this._id},getEntityTypeName:function(){return this._entityTypeName},getEntityId:function(){return this._entityId},getOwnerInfo:function(){return this._model.getOwnerInfo()},getMode:function(){return this._mode},getContextId:function(){return this._contextId},getContext:function(){return this._context},getExternalContextId:function(){return this._externalContextId},getScheme:function(){return this._scheme},canHideField:function(){return this._canHideField},isVisible:function(){return this._container.offsetParent!==null},isShowAlwaysFeautureEnabled:function(){return this._enableShowAlwaysFeauture},isVisibilityPolicyEnabled:function(){return this._enableVisibilityPolicy},isToolPanelAlwaysVisible:function(){return this._isToolPanelAlwaysVisible},isBottomPanelEnabled:function(){return this._enableBottomPanel},isConfigControlEnabled:function(){return this._enableConfigControl},isSectionEditEnabled:function(){return this._enableSectionEdit},isSectionCreationEnabled:function(){return this._enableSectionCreation&&this.canChangeScheme()},isFieldsContextMenuEnabled:function(){return this._enableFieldsContextMenu},isModeToggleEnabled:function(){return this._enableModeToggle},isNew:function(){return this._isNew},isReadOnly:function(){return this._readOnly},isEmbedded:function(){return this._isEmbedded},isEditInViewEnabled:function(){return this._entityId>0},getDetailManager:function(){if(typeof BX.UI.EntityDetailManager==="undefined"){return null}return BX.UI.EntityDetailManager.get(BX.prop.getString(this._settings,"detailManagerId",""))},getConfigurationFieldManager:function(){return this._configurationFieldManager},getUserFieldManager:function(){return this._userFieldManager},setAttributeManager:function(e){if(BX.Type.isObject(e)){this._attributeManager=e}return this._attributeManager},getAttributeManager:function(){return this._attributeManager},getHtmlEditorConfig:function(e){return BX.prop.getObject(this._htmlEditorConfigs,e,null)},getAdditionalFieldsData:function(){return this.additionalFieldsData},createValidator:function(e){e["editor"]=this;return BX.UI.EntityEditorValidatorFactory.create(BX.prop.getString(e,"type",""),e)},getControlByIndex:function(e){return e>=0&&e<this._controls.length?this._controls[e]:null},getControlIndex:function(e){for(var t=0,i=this._controls.length;t<i;t++){if(this._controls[t]===e){return t}}return-1},getControls:function(){return this._controls},getControlCount:function(){return this._controls.length},createControl:function(e,t,i){i["serviceUrl"]=this._serviceUrl;i["container"]=this._layoutContainer;i["model"]=this._model;i["editor"]=this;return BX.UI.EntityEditorControlFactory.create(e,t,i)},addControlAt:function(e,t){var i={};if(t<this._controls.length){i["anchor"]=this._controls[t].getWrapper();this._controls.splice(t,0,e)}else{this._controls.push(e)}e.layout(i)},moveControl:function(e,t){var i=this._controls.length;var n=i-1;if(t<0||t>i){t=n}var o=this.getControlIndex(e);if(o<0||o===t){return false}e.clearLayout();this._controls.splice(o,1);i--;var s=t<i?this._controls[t].getWrapper():null;if(t<i){this._controls.splice(t,0,e)}else{this._controls.push(e)}if(s){e.layout({anchor:s})}else{e.layout()}this._config.moveSchemeElement(e.getSchemeElement(),t)},removeControl:function(e){var t=this.getControlIndex(e);if(t<0){return false}this.processControlRemove(e);e.clearLayout();this._controls.splice(t,1)},getControlById:function(e){for(var t=0,i=this._controls.length;t<i;t++){var n=this._controls[t];if(n.getId()===e){return n}var o=n.getChildById(e);if(o){return o}}return null},getControlByIdRecursive:function(e,t){if(!t){t=this.getControls()}for(let i=0;i<t.length;i++){if(!t[i]instanceof BX.UI.EntityEditorControl){continue}if(t[i].getId()===e){return t[i]}else if(t[i]instanceof BX.UI.EntityEditorColumn||t[i]instanceof BX.UI.EntityEditorSection){const n=this.getControlByIdRecursive(e,t[i].getChildren());if(n){return n}}}return null},quoteRegExp:function(e){return e.replace(/([\\.+*?\[^\]$(){}=!<>|:])/g,"\\$1")},getCombinedIdRegExp:function(e){return new RegExp(this.quoteRegExp(e).replace(/\\\[n?\d+\\]/gi,"\\[n?\\d+\\]"))},getControlByCombinedIdRecursive:function(e,t){if(!BX.type.isNotEmptyString(e)){return null}let i=this.getCombinedIdRegExp(e);if(!t){t=this.getControls()}for(let n=0;n<t.length;n++){if(!t[n]instanceof BX.UI.EntityEditorControl){continue}if(i.test(t[n].getId())){return t[n]}else if(t[n]instanceof BX.UI.EntityEditorColumn||t[n]instanceof BX.UI.EntityEditorSection){const i=this.getControlByCombinedIdRecursive(e,t[n].getChildren());if(i instanceof BX.UI.EntityEditorControl){return i}}}return null},getAvailableControlByCombinedId:function(e){let t=null;let i=this.getAvailableSchemeElementByCombinedName(e);if(i){t=this.createControl(i.getType(),i.getName(),{schemeElement:i,model:this._model,mode:this._mode})}return t},getAllControls:function(e){let t=[];if(!e){e=this.getControls()}for(var i=0;i<e.length;i++){if(e[i]instanceof BX.UI.EntityEditorControl){if(e[i]instanceof BX.UI.EntityEditorColumn||e[i]instanceof BX.UI.EntityEditorSection){const n=this.getAllControls(e[i].getChildren());if(n){t=t.concat(n)}}else{t.push(e[i])}}}return t},getActiveControlCount:function(){return this._activeControls.length},getActiveControlIndex:function(e){var t=this._activeControls.length;if(t===0){return-1}for(var i=0;i<t;i++){if(this._activeControls[i]===e){return i}}return-1},getActiveControlById:function(e,t){t=!!t;var i=this._activeControls.length;if(i===0){return null}for(var n=0;n<i;n++){var o=this._activeControls[n];if(o.getId()===e){return o}if(t){var s=o.getChildById(e);if(s){return s}}}return null},getActiveControlByIndex:function(e){return e>=0&&e<this._activeControls.length?this._activeControls[e]:null},registerActiveControl:function(e){var t=this.getActiveControlIndex(e);if(t>=0){return}this._activeControls.push(e);e.setActive(true);if(this._mode!==BX.UI.EntityEditorMode.edit){this._mode=BX.UI.EntityEditorMode.edit}},unregisterActiveControl:function(e){var t=this.getActiveControlIndex(e);if(t<0){return}this._activeControls.splice(t,1);e.setActive(false);if(this._activeControls.length===0&&this._mode!==BX.UI.EntityEditorMode.view){this._mode=BX.UI.EntityEditorMode.view}},releaseActiveControls:function(e){var t={id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model};BX.onCustomEvent(window,this.eventsNamespace+":onRelease",[this,t]);var i=[];for(var n=0,o=this._activeControls.length;n<o;n++){var s=this._activeControls[n];if(s.isModeToggleEnabled()){s.setActive(false);s.toggleMode(false,e)}else{i.push(s)}}this._activeControls=i},hasChangedControls:function(){for(var e=0,t=this._activeControls.length;e<t;e++){if(this._activeControls[e].isChanged()){return true}}return false},hasChangedControllers:function(){for(var e=0,t=this._controllers.length;e<t;e++){if(this._controllers[e].isChanged()){return true}}return false},isWaitingForInput:function(){if(this._mode!==BX.UI.EntityEditorMode.edit){return false}for(var e=0,t=this._activeControls.length;e<t;e++){if(this._activeControls[e].isWaitingForInput()){return true}}return false},processControlModeChange:function(e,t){if(e.getMode()===BX.UI.EntityEditorMode.edit){this.registerActiveControl(e)}else{this.unregisterActiveControl(e)}if(this.getActiveControlCount()>0){this.showToolPanel()}else if(!this.isToolPanelAlwaysVisible()){this.hideToolPanel()}var i={control:e};BX.onCustomEvent(window,this.eventsNamespace+":onControlModeChange",[this,i])},processControlChange:function(e,t,i){this.showToolPanel();if(!BX.prop.getBoolean(i,"skipEvents",false)){BX.onCustomEvent(window,this.eventsNamespace+":onControlChange",[this,{control:e,params:t}])}},processControlAdd:function(e,t){this.removeAvailableSchemeElement(e.getSchemeElement());if(!BX.prop.getBoolean(t,"skipEvents",false)){BX.onCustomEvent(this,this.eventsNamespace+":onControlAdd",[this,{control:e,params:{}}])}},processControlMove:function(e,t){if(!BX.prop.getBoolean(t,"skipEvents",false)){BX.onCustomEvent(this,this.eventsNamespace+":onControlMove",[this,{control:e,params:t}])}},processControlRemove:function(e,t){if(e instanceof BX.UI.EntityEditorField){this.addAvailableSchemeElement(e.getSchemeElement())}else if(e instanceof BX.UI.EntityEditorSection){var i=e.getChildren();for(var n=0,o=i.length;n<o;n++){this.addAvailableSchemeElement(i[n].getSchemeElement())}}if(!BX.prop.getBoolean(t,"skipEvents",false)){BX.onCustomEvent(this,this.eventsNamespace+":onControlRemove",[this,{control:e,params:{}}])}},processSchemeChange:function(){for(var e=0,t=this._controls.length;e<t;e++){this._controls[e].processSchemeChange()}},getAvailableSchemeElements:function(){return this._availableSchemeElements},addAvailableSchemeElement:function(e){this._availableSchemeElements.push(e);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},removeAvailableSchemeElement:function(e){var t=this.getAvailableSchemeElementIndex(e);if(t<0){return}this._availableSchemeElements.splice(t,1);this._areAvailableSchemeElementsChanged=true;this.notifyAvailableSchemeElementsChanged()},getAvailableSchemeElementIndex:function(e){var t=this._availableSchemeElements;for(var i=0,n=t.length;i<n;i++){if(t[i]===e){return i}}return-1},getAvailableSchemeElementByName:function(e){var t=this._availableSchemeElements;for(var i=0,n=t.length;i<n;i++){var o=t[i];if(o.getName()===e){return o}}return null},getAvailableSchemeElementByCombinedName:function(e){if(!BX.type.isNotEmptyString(e)){return null}let t=this.getCombinedIdRegExp(e);const i=this._availableSchemeElements;for(let e=0,n=i.length;e<n;e++){if(t.test(i[e].getName())){return i[e]}}return null},hasAvailableSchemeElements:function(){return this._availableSchemeElements.length>0},getSchemeElementByName:function(e){return this._scheme.findElementByName(e,{isRecursive:true})},notifyAvailableSchemeElementsChanged:function(){for(var e=0,t=this._controls.length;e<t;e++){this._controls[e].processAvailableSchemeElementsChange()}},hasTransferableElements:function(e){var t=0;if(BX.type.isArray(e)){t=e.length}var i=this._scheme.getElements();for(var n=0,o=i.length;n<o;n++){var s=i[n].getElements();for(var r=0,a=s.length;r<a;r++){var l=s[r];var h=false;if(t>0){var d=l.getName();for(var c=0;c<t;c++){if(e[c]===d){h=true;break}}}if(h){continue}var u=l.getElements();for(var g=0,_=u.length;g<_;g++){if(u[g].isTransferable()&&u[g].getName()!==""){return true}}}}return false},createController:function(e){return BX.UI.EntityEditorControllerFactory.create(BX.prop.getString(e,"type",""),BX.prop.getString(e,"name",""),{config:BX.prop.getObject(e,"config",{}),model:this._model,editor:this})},processControllerChange:function(e){this.showToolPanel();var t={controller:e};BX.onCustomEvent(window,this.eventsNamespace+":onControllerChange",[this,t])},getControllers:function(){return this._controllers},getContainer:function(){return this._container},prepareContextDataLayout:function(e,t){for(var i in e){if(!e.hasOwnProperty(i)){continue}var n=e[i];var o=i;if(BX.type.isNotEmptyString(t)){o=t+"["+o+"]"}if(BX.type.isPlainObject(n)){this.prepareContextDataLayout(n,o)}else{this._formElement.appendChild(BX.create("input",{props:{type:"hidden",name:o,value:n}}))}}},layout:function(){var e={cancel:false};BX.onCustomEvent(window,this.eventsNamespace+":onBeforeLayout",[this,e]);if(e["cancel"]){return}this.prepareContextDataLayout(this._context,"");if(this._toolPanel){this._toolPanel.layout()}var t={edit:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this})};var i,n,o;for(i=0,n=this._controls.length;i<n;i++){o=this._controls[i];var s=o.getMode();var r={userFieldLoader:t[BX.UI.EntityEditorMode.getName(s)],enableFocusGain:!this._isEmbedded};o.layout(r);if(s===BX.UI.EntityEditorMode.edit){this.registerActiveControl(o)}}for(var a in t){if(t.hasOwnProperty(a)){t[a].runBatch()}}if(this.getActiveControlCount()>0){this.showToolPanel()}if(this._enablePageTitleControls&&!this._enablePageTitleControlsViaToolbar&&this._model.isCaptionEditable()){BX.bind(this._pageTitle,"click",BX.delegate(this.onPageTileClick,this));if(this._editPageTitleButton){BX.bind(this._editPageTitleButton,"click",BX.delegate(this.onPageTileClick,this))}}if(this._buttonContainer&&this.isBottomPanelEnabled()){if(this.isSectionCreationEnabled()){this._createSectionButton=BX.create("span",{props:{className:"ui-entity-add-widget-link"},text:BX.message("UI_ENTITY_EDITOR_CREATE_SECTION"),events:{click:BX.delegate(this.onCreateSectionButtonClick,this)}});this._buttonContainer.appendChild(this._createSectionButton)}if(this.isConfigControlEnabled()){var l=this._config.getScope();var h=BX.UI.EntityConfigScope.getCaption(l);this._buttonContainer.appendChild(BX.create("span",{props:{className:l===BX.UI.EntityConfigScope.common?"ui-entity-card-common":"ui-entity-card-private",title:h}}));this._configMenuButton=BX.create("span",{props:{className:"ui-entity-settings-link"},text:h,events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}});this._buttonContainer.appendChild(this._configMenuButton)}}this.adjustButtons()},refreshLayout:function(e){var t={edit:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.edit,enableBatchMode:true,owner:this}),view:BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this})};if(!BX.type.isPlainObject(e)){e={}}for(var i=0,n=this._controls.length;i<n;i++){var o=this._controls[i];var s=o.getMode();var r=BX.mergeEx(e,{userFieldLoader:t[BX.UI.EntityEditorMode.getName(s)],enableFocusGain:!this._isEmbedded});o.refreshLayout(r)}for(var a in t){if(t.hasOwnProperty(a)){t[a].runBatch()}}this.adjustButtons();BX.onCustomEvent(window,this.eventsNamespace+":onRefreshLayout",[this])},refreshViewModeLayout:function(e){var t=BX.UI.EntityUserFieldLayoutLoader.create(this._id,{mode:BX.UI.EntityEditorMode.view,enableBatchMode:true,owner:this});if(!BX.type.isPlainObject(e)){e={}}for(var i=0,n=this._controls.length;i<n;i++){var o=this._controls[i];var s=BX.mergeEx(e,{userFieldLoader:t,enableFocusGain:false,isRefreshViewModeLayout:true});o.refreshViewModeLayout(s)}t.runBatch();BX.onCustomEvent(window,this.eventsNamespace+":onRefreshViewModeLayout",[this])},switchControlMode:function(e,t,i){if(!this.isModeToggleEnabled()){return}if(t===BX.UI.EntityEditorMode.view){if(e.checkModeOption(BX.UI.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(e,BX.UI.EntityEditorMode.view);this._modeSwitch.run()}else{e.setMode(t,{options:i,notify:true});e.refreshLayout()}}else{if(!BX.UI.EntityEditorModeOptions.check(i,BX.UI.EntityEditorModeOptions.exclusive)){e.setMode(BX.UI.EntityEditorMode.edit,{options:i,notify:true});e.refreshLayout()}else{var n=0;for(var o=0,s=this._activeControls.length;o<s;o++){var r=this._activeControls[o];if(r.checkModeOption(BX.UI.EntityEditorModeOptions.saveOnExit)){this._modeSwitch.getQueue().add(r,BX.UI.EntityEditorMode.view,i);n++}}if(n>0){this._modeSwitch.getQueue().add(e,BX.UI.EntityEditorMode.edit,i);this._modeSwitch.run()}else{e.setMode(BX.UI.EntityEditorMode.edit,{options:i,notify:true});e.refreshLayout()}}}},switchToViewMode:function(e){this.releaseActiveControls(e);if(this.getActiveControlCount()>0){return}if(!this.isToolPanelAlwaysVisible()){this.hideToolPanel()}var t={options:e};BX.onCustomEvent(window,this.eventsNamespace+":onSwitchToViewMode",[this,t])},switchTitleMode:function(e){if(this._enablePageTitleControlsViaToolbar){return}if(e===BX.UI.EntityEditorMode.edit){this._pageTitle.style.display="none";document.body.classList.add("--edit__title-input");if(this._buttonWrapper){this._buttonWrapper.style.display="none"}this._pageTitleInput=BX.create("input",{props:{type:"text",className:this.pageTitleInputClassName,value:this._model.getCaption()}});this._pageTitle.parentNode.insertBefore(this._pageTitleInput,this._pageTitle);this._pageTitleInput.focus();window.setTimeout(BX.delegate((function(){BX.bind(document,"mousedown",this._pageTitleExternalClickHandler);BX.bind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler)}),this),300)}else{if(this._pageTitleInput){this._pageTitleInput=BX.remove(this._pageTitleInput)}this._pageTitle.style.display="";if(this._buttonWrapper){this._buttonWrapper.style.display=""}BX.unbind(document,"mousedown",this._pageTitleExternalClickHandler);BX.unbind(this._pageTitleInput,"keyup",this._pageTitleKeyPressHandler);this.adjustTitle()}},adjustTitle:function(){if(!this._enablePageTitleControls||this._isNew){return}const e=this._model.getCaption().trim();if(this._enablePageTitleControlsViaToolbar&&this._toolbar){this._toolbar.setTitle(e)}else if(!this._enablePageTitleControlsViaToolbar&&this._pageTitle&&this._buttonWrapper){this._pageTitle.textContent=e}},adjustSize:function(){if(!this._enablePageTitleControls||!this._pageTitle){return}if(this._enablePageTitleControlsViaToolbar){return}var e=this._pageTitle.parentNode?this._pageTitle.parentNode:this._pageTitle;var t=e.offsetWidth<=480&&this._model.getCaption().length>=40;if(t&&!BX.hasClass(e,"pagetitle-narrow")){BX.addClass(e,"pagetitle-narrow")}else if(!t&&BX.hasClass(e,"pagetitle-narrow")){BX.removeClass(e,"pagetitle-narrow")}},adjustButtons:function(){if(this._config.isScopeToggleEnabled()&&!this._enableBottomPanel&&this._controls.length>0){var e=this._controls[this._controls.length-1];if(e instanceof BX.UI.EntityEditorColumn){if(e._sections.length>0){e=e._sections[e._sections.length-1]}else{return}}e.addButtonElement(BX.create("span",{props:{className:this._config.getScope()===BX.UI.EntityConfigScope.common?"ui-entity-card-common":"ui-entity-card-private"},events:{click:BX.delegate(this.onConfigMenuButtonClick,this)}}),{position:"right"})}},showToolPanel:function(){if(!this._toolPanel||this._toolPanel.isVisible()){return}this._toolPanel.setVisible(true);if(this._parentContainer){this._parentContainer.style.paddingBottom="50px";document.body.style.paddingBottom="60px";document.body.style.height="auto"}},hideToolPanel:function(){if(!this._toolPanel||!this._toolPanel.isVisible()){return}this._toolPanel.setVisible(false);if(this._parentContainer){this._parentContainer.style.paddingBottom="";document.body.style.paddingBottom="";document.body.style.height=""}},showMessageDialog:function(e,t,i){var n=BX.UI.EditorAuxiliaryDialog.create(e,{title:t,content:i,buttons:[{id:"continue",type:BX.UI.DialogButtonType.accept,text:BX.message("UI_ENTITY_EDITOR_CONTINUE"),callback:function(e){e.getDialog().close()}}]});n.open()},getMessage:function(e){var t=BX.UI.EntityEditor.messages;return t.hasOwnProperty(e)?t[e]:e},getGlobalEventName:function(e){return e},getFormElement:function(){return this._formElement},isChanged:function(){return this._isNew||this.hasChangedControls()||this.hasChangedControllers()},getEntityTypeForAction:function(){return this._entityTypeName},prepareControllersData:function(e){if(!BX.type.isPlainObject(e)){e={}}for(var t=0,i=this._controllers.length;t<i;t++){if(BX.Type.isFunction(this._controllers[t].onBeforesSaveControl)){e=this._controllers[t].onBeforesSaveControl(e)}}return e},savePageTitle:function(e){if(!this._enablePageTitleControls){return}e=BX.util.trim(e);if(e===""){return}this._model.setCaption(e);var t={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this.getEntityTypeForAction(),PARAMS:BX.prop.getObject(this._context,"PARAMS",{})};this._model.prepareCaptionData(t);t=BX.mergeEx(t,this.prepareControllersData(t));BX.ajax({url:this._serviceUrl,method:"POST",dataType:"json",data:t,onsuccess:BX.delegate(this.onSaveSuccess,this)})},performAction:function(e){if(!this._actionTypes){return}if(this._actionTypes[e]===BX.UI.EntityEditorActionTypes.save){this.performSaveChangedAction(e)}else if(this._actionTypes[e]===BX.UI.EntityEditorActionTypes.direct){this.performDirectAction(e)}},performDirectAction:function(e){if(this._toolPanel){this._toolPanel.setLocked(true)}var t=this.getActionEventArguments();t.actionId=e;BX.onCustomEvent(window,this.eventsNamespace+":onDirectAction",[this,t]);if(t["cancel"]){return}this._ajaxForms[e].submit()},saveChanged:function(){this.performSaveChangedAction(BX.UI.EntityEditorActionIds.defaultActionId)},performSaveChangedAction:function(e){if(!this._isNew&&!this.hasChangedControls()&&!this.hasChangedControllers()&&!this.isWaitingForInput()){this._modeSwitch.reset();this.releaseActiveControls();this.refreshLayout({reset:true});if(!this.isToolPanelAlwaysVisible()){this.hideToolPanel()}BX.onCustomEvent(window,this.eventsNamespace+":onNothingChanged",[this])}else{this._modeSwitch.reset();this._modeSwitch.getQueue().addBatch(this._activeControls,BX.UI.EntityEditorMode.view);this._modeSwitch.setRunAction(e);this._modeSwitch.run()}},saveDelayed:function(e){this.performSaveDelayedAction(BX.UI.EntityEditorActionIds.defaultActionId,e)},performSaveDelayedAction:function(e,t){if(typeof t==="undefined"){t=0}if(this._delayedSaveHandle>0){window.clearTimeout(this._delayedSaveHandle)}this._delayedSaveHandle=window.setTimeout(BX.delegate((function(){this.performSaveAction(e)}),this),t)},save:function(){this.performSaveAction(BX.UI.EntityEditorActionIds.defaultActionId)},performSaveAction:function(e){if(this._toolPanel){this._toolPanel.setLocked(true)}var t=BX.UI.EntityValidationResult.create();this.validate(t).then(BX.delegate((function(){if(this._bizprocManager){return this._bizprocManager.onBeforeSave(t)}var e=new BX.Promise;window.setTimeout((function(){e.fulfill()}),0);return e}),this)).then(BX.delegate((function(){if(t.getStatus()){if(this.performInnerSaveAction(e)!==false){if(this._bizprocManager){this._bizprocManager.onAfterSave()}}else{if(this._toolPanel){this._toolPanel.setLocked(false)}this.registerSaveAnalyticsEvent("error")}}else{if(this.isVisible()){var i=t.getTopmostField();if(i){i.focus();var n=130;window.scroll(window.pageXOffset,window.pageYOffset+n)}}if(this._toolPanel){this._toolPanel.setLocked(false)}this.registerSaveAnalyticsEvent("error");BX.onCustomEvent(window,this.eventsNamespace+":onFailedValidation",[this,t])}}),this));if(this._delayedSaveHandle>0){this._delayedSaveHandle=0}},saveControl:function(e){if(this._entityId<=0&&this._model.isIdentifiable()){return}var t=BX.UI.EntityValidationResult.create();e.validate(t);if(!t.getStatus()){return}var i={ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this.getEntityTypeForAction()};i=BX.mergeEx(i,this._context);e.save();e.prepareSaveData(i);i=BX.mergeEx(i,this.prepareControllersData(i));BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:i,onsuccess:function(e){this.onSaveSuccess(e,{switchMode:false})}.bind(this)})},saveData:function(e){if(this._entityId<=0&&this._model.isIdentifiable()){return}e=BX.mergeEx(e,this._context);e=BX.mergeEx(e,{ACTION:"SAVE",ACTION_ENTITY_ID:this._entityId,ACTION_ENTITY_TYPE:this.getEntityTypeForAction()});BX.ajax({method:"POST",dataType:"json",url:this._serviceUrl,data:e,onsuccess:BX.delegate(this.onSaveSuccess,this)})},reload:function(){if(this._isRequestRunning){return}if(this._entityId<=0&&this._model.isIdentifiable()){return}var e=this.getActionEventArguments();BX.onCustomEvent(window,this.eventsNamespace+":onEntityStartReload",[this,e]);if(e["cancel"]){return}var t=BX.prop.getObject(this._settings,"ajaxData",{});var i=BX.prop.getString(t,"COMPONENT_NAME","");var n=BX.prop.getString(t,"SIGNED_PARAMETERS","");var o=BX.prop.getObject(t,"RELOAD_FORM_DATA",{});var s=BX.prop.getString(t,"RELOAD_ACTION_NAME","");if(s===""){console.warn("Can't reload entity editor because RELOAD_ACTION_NAME is not defined");return}this._reloadAjaxForm=this.createAjaxForm({componentName:i,actionName:s,signedParameters:n,formData:o,enableRequiredUserFieldCheck:false},{onSuccess:this.onReloadSuccess.bind(this)});if(this._reloadAjaxForm){this._reloadAjaxForm.submit()}},setValidationEnabled:function(e){e=!!e;this._validationEnabled=e;if(this._userFieldManager){this._userFieldManager.setValidationEnabled(e)}},validate:function(e){const t=new BX.Promise;if(this._validationEnabled){for(let t=0,i=this._activeControls.length;t<i;t++){this._activeControls[t].validate(e)}if(this._userFieldManager){this._userFieldManager.validate(e).then(BX.delegate((function(){t.fulfill()}),this))}else{t.fulfill()}}else{t.fulfill()}return t},isRequestRunning:function(){return this._isRequestRunning},getActionEventArguments:function(){return{id:this._id,externalContext:this._externalContextId,context:this._contextId,entityTypeName:this._entityTypeName,entityId:this._entityId,model:this._model,cancel:false}},innerSave:function(){this.performInnerSaveAction(BX.UI.EntityEditorActionIds.defaultActionId)},performInnerSaveAction:function(e){if(this._isRequestRunning){return true}var t,i;for(t=0,i=this._controllers.length;t<i;t++){this._controllers[t].onBeforeSubmit()}for(t=0,i=this._activeControls.length;t<i;t++){var n=this._activeControls[t];n.save();n.onBeforeSubmit();if(n.isSchemeChanged()){this._config.updateSchemeElement(n.getSchemeElement())}}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}if(this._config&&this._config.isChanged()){this._config.save(false)}var o=this.getActionEventArguments();o.actionId=e;BX.onCustomEvent(window,this.eventsNamespace+":onSave",[this,o]);if(o["cancel"]){return false}var s=BX.prop.getBoolean(o,"enableCloseConfirmation",null);if(BX.type.isBoolean(s)){this._enableCloseConfirmation=s}var r=null;if(this._ajaxForms&&this._ajaxForms[e]){r=this._ajaxForms[e]}else{r=this._ajaxForm}if(r){const e=BX.Text.getRandom();this.eventIds.add(e);return r.submit({data:{EVENT_ID:e}})}return true},cancel:function(){var e=this.getActionEventArguments();BX.onCustomEvent(window,this.eventsNamespace+":onCancel",[this,e]);if(e["cancel"]){return}var t=BX.prop.getBoolean(e,"enableCloseConfirmation",null);if(BX.type.isBoolean(t)){this._enableCloseConfirmation=t}if(this.hasChangedControls()||this.hasChangedControllers()){window.setTimeout(BX.delegate(this.openCancellationConfirmationDialog,this),250);return}this.innerCancel()},innerCancel:function(){var e,t;for(e=0,t=this._controllers.length;e<t;e++){this._controllers[e].innerCancel()}this.rollback();if(this._isNew){this.refreshLayout();if(typeof top.BX.SidePanel!=="undefined"){window.setTimeout((function(){var e=top.BX.SidePanel.Instance.getSliderByWindow(window);if(e&&e.isOpen()){e.close(false)}}),250)}}else{this.switchToViewMode({refreshLayout:false});this.refreshLayout()}},openCancellationConfirmationDialog:function(){if(this._confirmationCancelDialog){return}this._confirmationCancelDialog=BX.UI.EditorAuxiliaryDialog.create("cancel_confirmation",{title:BX.message("UI_ENTITY_EDITOR_CONFIRMATION"),content:BX.message("UI_ENTITY_EDITOR_CANCEL_CONFIRMATION"),buttons:[{id:"yes",type:BX.UI.DialogButtonType.accept,text:BX.message("UI_ENTITY_EDITOR_YES"),callback:this._cancelConfirmationHandler},{id:"no",type:BX.UI.DialogButtonType.cancel,text:BX.message("UI_ENTITY_EDITOR_NO"),callback:this._cancelConfirmationHandler}]});this._confirmationCancelDialog.open()},onCancelConfirmButtonClick:function(e){e.getDialog().close();this._confirmationCancelDialog=null;if(e.getId()==="yes"){this.innerCancel()}},rollback:function(){this._model.rollback();var e,t;for(e=0,t=this._controllers.length;e<t;e++){this._controllers[e].rollback()}for(e=0,t=this._activeControls.length;e<t;e++){this._activeControls[e].rollback()}if(this._areAvailableSchemeElementsChanged){this._availableSchemeElements=this._scheme.getAvailableElements();this._areAvailableSchemeElementsChanged=false}},addSchemeElementAt:function(e,t){if(this._config){this._config.addSchemeElementAt(e,t)}},updateSchemeElement:function(e){if(this._config){this._config.updateSchemeElement(e)}},removeSchemeElement:function(e){if(this._config){this._config.removeSchemeElement(e)}},canChangeScheme:function(){return this._config&&this._config.isChangeable()},isSchemeChanged:function(){return this._config&&this._config.isChanged()},saveScheme:function(){if(!this._config){return false}var e=this._config.save(false);if(e){this._areAvailableSchemeElementsChanged=false;this.processSchemeChange();BX.onCustomEvent(this,this.eventsNamespace+":onSchemeSave",[this,{params:{}}])}return e},saveSchemeChanges:function(){this.commitSchemeChanges();return this.saveScheme()},commitSchemeChanges:function(){for(var e=0,t=this._controls.length;e<t;e++){this._controls[e].commitSchemeChanges()}if(this._areAvailableSchemeElementsChanged){this._scheme.setAvailableElements(this._availableSchemeElements);this._areAvailableSchemeElementsChanged=false}},canChangeCommonConfiguration:function(){return this._config.isCanChangeCommonConfiguration()},registerSaveAnalyticsEvent:function(e){const t=BX.prop.getObject(this._settings,"analyticsConfig",{});let i=BX.prop.getObject(t,"data",null);if(!BX.Type.isPlainObject(i)){return}i.status=e;if(e==="success"&&this._isNew&&this._entityId>0){i.p2=`id_${this._entityId}`}if(BX.prop.getBoolean(t,"appendParamsFromCurrentUrl",false)){const e=new BX.Uri(decodeURI(window.location.href));i=Object.assign(e.getQueryParam("st")||{},i)}BX.UI.Analytics.sendData(i)},onSaveSuccess:function(result,params){this._isRequestRunning=false;if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}if(result.ADDITIONAL_FIELDS_DATA){this.additionalFieldsData=BX.prop.getObject(result,"ADDITIONAL_FIELDS_DATA",{})}const eventParams=this.prepareEventParams(result);var checkErrors=BX.prop.getObject(result,"CHECK_ERRORS",null);var error=BX.prop.getString(result,"ERROR","");var hasRestriction=BX.prop.getBoolean(result,"RESTRICTION",false);if(checkErrors||error!==""||hasRestriction){this.registerSaveAnalyticsEvent("error");if(checkErrors){var firstField=null;var errorMessages=[];for(var fieldId in checkErrors){if(!checkErrors.hasOwnProperty(fieldId)){return}var field=this.getActiveControlById(fieldId,true);if(field){field.showError(checkErrors[fieldId]);if(!firstField){firstField=field}}else{errorMessages.push(checkErrors[fieldId])}}if(firstField){firstField.scrollAnimate()}error=errorMessages.join("<br/>")}var restrictionAction=BX.prop.getString(result,"RESTRICTION_ACTION","");if(hasRestriction&&restrictionAction.length){eval(restrictionAction);BX.onCustomEvent(window,this.eventsNamespace+":onRestrictionAction",[])}else{if(error!==""&&this._toolPanel){this._toolPanel.addError(error)}eventParams["checkErrors"]=checkErrors;eventParams["error"]=error;if(this._isNew){BX.onCustomEvent(window,this.getGlobalEventName("onEntityCreateError"),[eventParams])}else{eventParams["entityId"]=this._entityId;BX.onCustomEvent(window,this.getGlobalEventName("onEntityUpdateError"),[eventParams])}}this.releaseAjaxForm();this.initializeAjaxForm();return}var entityData=BX.prop.getObject(result,"ENTITY_DATA",null);eventParams["entityData"]=entityData;if(!this._model.isIdentifiable()){eventParams["sender"]=this;BX.onCustomEvent(window,this.getGlobalEventName("onEntityUpdate"),[eventParams])}else{if(this._isNew){this._entityId=BX.prop.getInteger(result,"ENTITY_ID",0);if(this._entityId<=0){if(this._toolPanel){let e=this.getMessage("couldNotFindEntityIdError");if(e==="couldNotFindEntityIdError"){e=BX.message("UI_ENTITY_EDITOR_COULD_NOT_FIND_ENTITY_ID")}this._toolPanel.addError(e)}this.registerSaveAnalyticsEvent("error");return}eventParams["sender"]=this;eventParams["entityId"]=this._entityId;BX.onCustomEvent(window,this.getGlobalEventName("onEntityCreate"),[eventParams]);if(BX.prop.getBoolean(eventParams,"isCancelled",true)){this.registerSaveAnalyticsEvent("success");this._entityId=0;this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}this._isNew=false}else{eventParams["sender"]=this;eventParams["entityId"]=this._entityId;BX.onCustomEvent(window,this.getGlobalEventName("onEntityUpdate"),[eventParams]);if(BX.prop.getBoolean(eventParams,"isCancelled",true)){this.registerSaveAnalyticsEvent("success");this.rollback();this.releaseAjaxForm();this.initializeAjaxForm();return}}}const redirectUrl=BX.prop.getString(result,"REDIRECT_URL","");const isOpenInNewSlide=BX.prop.getBoolean(result,"OPEN_IN_NEW_SLIDE",false);const additionalEventParams=BX.prop.getObject(result,"EVENT_PARAMS",null);if(additionalEventParams){const e=BX.prop.getString(additionalEventParams,"name","");const t=BX.prop.getObject(additionalEventParams,"args",null);if(BX.Type.isStringFilled(e)&&t!==null){if(BX.Type.isStringFilled(redirectUrl)){t.redirectUrl=redirectUrl}BX.localStorage.set(e,t,10)}}this.registerSaveAnalyticsEvent("success");if(this._isReleased){return}if(BX.Type.isStringFilled(redirectUrl)){setTimeout((()=>{eventParams.redirectUrl=redirectUrl;BX.onCustomEvent(window,this.getGlobalEventName("beforeEntityRedirect"),[eventParams]);const e=BX.util.add_url_param(redirectUrl,{IFRAME:"Y",IFRAME_TYPE:"SIDE_SLIDER"});const t=window.top.BX.SidePanel?window.top.BX.SidePanel.Instance:null;if(isOpenInNewSlide&&t&&t.isOpen()){t.close(false,(()=>t.open(e)))}else{window.location.replace(e)}}))}else{if(BX.prop.getBoolean(params,"switchMode",true)){if(BX.type.isPlainObject(entityData)){this._model.setData(entityData,{enableNotification:false})}this.adjustTitle();this.adjustSize();this.releaseAjaxForm();this.initializeAjaxForm();for(var i=0,length=this._controllers.length;i<length;i++){this._controllers[i].onAfterSave()}if(this._modeSwitch.isRunning()){this._modeSwitch.complete()}else{this.switchToViewMode({refreshLayout:false})}this.refreshLayout({reset:true});if(!this.isToolPanelAlwaysVisible()){this.hideToolPanel()}}else if(BX.type.isPlainObject(entityData)){var previousModel=Object.create(this._model);previousModel.setData(BX.clone(this._model.getData()),{enableNotification:false});this._model.setData(entityData,{enableNotification:false});this.adjustTitle();this.adjustSize();for(var i=0,length=this._controllers.length;i<length;i++){this._controllers[i].onReload()}this.refreshViewModeLayout({previousModel:previousModel,reset:true})}}},prepareEventParams:function(e){var t=BX.prop.getObject(e,"EVENT_PARAMS",{});t["entityTypeName"]=this._entityTypeName;t["isCancelled"]=false;if(typeof window.top.BX.SidePanel!=="undefined"){var i=window.top.BX.SidePanel.Instance.getTopSlider();if(i){t["sliderUrl"]=i.getUrl()}}return t},onSaveFailure:function(e){this._isRequestRunning=false;this.registerSaveAnalyticsEvent("error");if(this._toolPanel){this._toolPanel.setLocked(false);this._toolPanel.clearErrors()}var t=BX.prop.getArray(e,"ERRORS",[]);if(this._toolPanel){for(var i=0,n=t.length;i<n;i++){this._toolPanel.addError(t[i])}}var o={errors:t};o["sender"]=this;o["entityTypeName"]=this._entityTypeName;o["entityId"]=this._entityId;BX.onCustomEvent(window,this.eventsNamespace+":onEntitySaveFailure",[o])},onReloadSuccess:function(e){var t=BX.prop.getObject(e,"EVENT_PARAMS",{});t["entityId"]=this._entityId;t["entityTypeName"]=this._entityTypeName;var i=BX.prop.getObject(e,"CHECK_ERRORS",null);var n=BX.prop.getString(e,"ERROR","");if(i||n!==""){t["checkErrors"]=i;t["error"]=n;BX.onCustomEvent(window,this.eventsNamespace+":onEntityReloadError",[t]);return}var o=BX.prop.getObject(e,"ENTITY_DATA",null);if(e.ADDITIONAL_FIELDS_DATA){this.additionalFieldsData=BX.prop.getObject(e,"ADDITIONAL_FIELDS_DATA",{})}t["entityData"]=o;t["sender"]=this;t["entityId"]=this._entityId;BX.onCustomEvent(window,this.eventsNamespace+":onEntityReload",[t]);if(BX.type.isPlainObject(o)){var s=Object.create(this._model);s.setData(BX.clone(this._model.getData()),{enableNotification:false});this._model.setData(o,{enableNotification:false});this.adjustTitle();this.adjustSize();for(var r=0,a=this._controllers.length;r<a;r++){this._controllers[r].onReload()}this.refreshViewModeLayout({previousModel:s,reset:true})}},formatMoney:function(e,t,i){BX.ajax({url:BX.prop.getString(this._settings,"serviceUrl",""),method:"POST",dataType:"json",data:{ACTION:"GET_FORMATTED_SUM",CURRENCY_ID:t,SUM:e},onsuccess:i})},findOption:function(e,t){for(var i=0,n=t.length;i<n;i++){if(e===t[i].VALUE){return t[i].NAME}}return e},prepareConfigMenuItems:function(){var e=[];var t=BX.delegate(this.onMenuItemClick,this);if(this._config.isScopeToggleEnabled()){var i=this._config.getScope();e.push({id:"switchToPersonalConfig",text:BX.message("UI_ENTITY_EDITOR_SWITCH_TO_PERSONAL_CONFIG_MSGVER_2"),onclick:t,className:i===BX.UI.EntityConfigScope.personal?"menu-popup-item-accept":"menu-popup-item-none"});e.push({id:"switchToCommonConfig",text:BX.message("UI_ENTITY_EDITOR_SWITCH_TO_COMMON_CONFIG_MSGVER_2"),onclick:t,className:i===BX.UI.EntityConfigScope.common?"menu-popup-item-accept":"menu-popup-item-none"})}if(this._config._userScopes){for(var n in this._config._userScopes){const i={text:BX.Loc.getMessage("UI_ENTITY_EDITOR_CHECK_SCOPE",{"#SCOPE_NAME#":this._config._userScopes[n]["NAME"]}),onclick:t,attributes:{"data-id":n},className:this._config.getScope()===BX.UI.EntityConfigScope.custom&&this._config._userScopeId===n?"menu-popup-item-accept":"menu-popup-item-none"};if(this._entityId<=0&&this._config._userScopes[n]["ON_ADD"]==="Y"){e.push(i)}else if(this._entityId>0&&this._config._userScopes[n]["ON_UPDATE"]==="Y"){e.push(i)}}}if(this.canChangeScheme()){if(this._config.isScopeToggleEnabled()){e.push({delimiter:true})}if(!this._config._userScopeId){e.push({id:"resetConfig",text:BX.message("UI_ENTITY_EDITOR_RESET_CONFIG_MSGVER_2"),onclick:t,className:"menu-popup-item-none"})}if(BX.prop.getBoolean(this._settings,"enableSettingsForAll",false)){e.push({id:"forceCommonConfigForAllUsers",text:BX.message("UI_ENTITY_EDITOR_FORCE_COMMON_CONFIG_FOR_ALL_MSGVER_2"),onclick:t,className:"menu-popup-item-none"})}if(this.moduleId&&this.canChangeCommonConfiguration()){e.push({delimiter:true});e.push({id:"createConfigForCheckedUsers",text:BX.message("UI_ENTITY_EDITOR_CREATE_SCOPE_MSGVER_1"),onclick:t,className:"menu-popup-item-none"});e.push({id:"editCommonConfig",text:BX.message("UI_ENTITY_EDITOR_UPDATE_SCOPE_MSGVER_2"),onclick:t,className:"menu-popup-item-none"})}}BX.onCustomEvent(window,this.eventsNamespace+":onPrepareConfigMenuItems",[this,e]);return e},getServiceUrl:function(){return this._serviceUrl},loadCustomHtml:function(e,t,i){t["ACTION"]=e;t["ACTION_ENTITY_ID"]=this._entityId;BX.ajax({url:this._serviceUrl,method:"POST",dataType:"html",data:t,onsuccess:i})},onFormSubmit:function(e,t){this._isRequestRunning=true;if(this._toolPanel){this._toolPanel.setLocked(true)}},onResize:function(e){this.adjustSize()},onPageTileClick:function(e){if(this._readOnly){return}if(this.isChanged()){this.showMessageDialog("titleEditDenied",BX.message("UI_ENTITY_EDITOR_TITLE_EDIT"),BX.message("UI_ENTITY_EDITOR_TITLE_EDIT_UNSAVED_CHANGES"));return}this.switchTitleMode(BX.UI.EntityEditorMode.edit)},onCreateSectionButtonClick:function(e){if(!this.isSectionCreationEnabled()){return}var t=this.getControlCount();var i="user_"+BX.util.getRandomString(8).toLowerCase();var n=BX.UI.EntitySchemeElement.create({type:"section",name:i,title:BX.message("UI_ENTITY_EDITOR_NEW_SECTION_TITLE")});var o={schemeElement:n,model:this._model};var s=this.getControlByIndex(0);if(!s){this.addSchemeElementAt(n,t);o.container=this._formElement}var r=this.createControl("section",i,o);if(s){s.addChild(r,{enableSaving:false})}else{this.addControlAt(r,0);this.saveScheme()}r.setMode(BX.UI.EntityEditorMode.edit,{notify:false});r.refreshLayout();r.setTitleMode(BX.UI.EntityEditorMode.edit);this.registerActiveControl(r)},onConfigMenuButtonClick:function(e){if(this._isConfigMenuShown){return}var t=this.prepareConfigMenuItems();if(t.length>0){BX.PopupMenu.show(this._id+"_config_menu",BX.getEventTarget(e),t,{angle:false,autoHide:true,closeByEsc:true,events:{onPopupShow:function(){this._isConfigMenuShown=true}.bind(this),onPopupClose:function(){BX.PopupMenu.destroy(this._id+"_config_menu")}.bind(this),onPopupDestroy:function(){this._isConfigMenuShown=false}.bind(this)}})}},onPageTitleExternalClick:function(e){if(this._enablePageTitleControlsViaToolbar){return}var t=BX.getEventTarget(e);if(t!==this._pageTitleInput){this.savePageTitle(this._pageTitleInput.value);this.switchTitleMode(BX.UI.EntityEditorMode.view)}},onPageTitleKeyPress:function(e){if(this._enablePageTitleControlsViaToolbar){return}var t=e.keyCode;if(t===13){this.savePageTitle(this._pageTitleInput.value);this.switchTitleMode(BX.UI.EntityEditorMode.view)}else if(t===27){this.switchTitleMode(BX.UI.EntityEditorMode.view)}},onToolbarBeforeStartEditing:function(e){if(this._readOnly||!this._model.isCaptionEditable()){e.preventDefault();return}if(this.isChanged()){e.preventDefault();this.showMessageDialog("titleEditDenied",BX.message("UI_ENTITY_EDITOR_TITLE_EDIT"),BX.message("UI_ENTITY_EDITOR_TITLE_EDIT_UNSAVED_CHANGES"));return}},onToolbarFinishEditing:function(e){const t=e.getData().updatedTitle;this.savePageTitle(t);this.adjustTitle()},onInterfaceToolbarMenuBuild:function(e,t){var i=BX.prop.getArray(t,"items",null);if(!i){return}var n=this.prepareConfigMenuItems();if(n.length>0){if(i.length>0){i.push({delimiter:true})}for(var o=0,s=n.length;o<s;o++){i.push(n[o])}}},getCommonConfigEditUrl:function(e,t){let i=this._commonConfigEditUrl.replace(/#ENTITY_TYPE_ID_VALUE#/gi,e).replace(/#MODULE_ID#/gi,t);let n=BX.prop.getInteger(this._context.PARAMS,"CATEGORY_ID");if(BX.Type.isUndefined(n)){n=BX.prop.getInteger(this._context,"CATEGORY_ID")}if(t==="crm"&&BX.Type.isInteger(n)){i=i+`&apply_filter=Y&CATEGORY=${n}`}return i},onMenuItemClick:function(e,t){var i=BX.prop.getString(t,"id","");switch(i){case"resetConfig":this.resetConfig();break;case"switchToPersonalConfig":this.setConfigScope(BX.UI.EntityConfigScope.personal);break;case"switchToCommonConfig":this.setConfigScope(BX.UI.EntityConfigScope.common);break;case"forceCommonConfigForAllUsers":this.forceCommonConfigScopeForAll();break;case"createConfigForCheckedUsers":this.createConfigScopeForCheckedUsers();break;case"editCommonConfig":BX.SidePanel.Instance.open(this.getCommonConfigEditUrl(this._config._id,this.moduleId),{cacheable:false});break;default:var n=BX.prop.getObject(t,"attributes","");if(n["data-id"]!==undefined){this.setConfigScope(BX.UI.EntityConfigScope.custom,n["data-id"])}}if(t.menuWindow){t.menuWindow.close()}},setConfigScope:function(e,t){if(e===this._config.getScope()&&this._config.getScope()!==BX.UI.EntityConfigScope.custom||e===BX.UI.EntityConfigScope.custom&&(t===undefined||t===this._config._userScopeId)){return}this._config.setScope(e,t,this.moduleId,this._entityId).then(function(){var i={id:this._id,moduleId:this.moduleId,scope:e,userScopeId:t,enableReload:true};BX.onCustomEvent(window,this.eventsNamespace+":onConfigScopeChange",[this,i]);if(i["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},createConfigScopeForCheckedUsers:function(){const e=BX.prop.getObject(this._settings,"options",{});const t=BX.prop.getString(e,"useHumanResourcesModule","N");const i=BX.prop.getString(e,"useOnAddOnUpdateSegregation","N");const n=BX.UI.EntityEditorScopeConfig.create(this._id+"_config",{editor:this,config:this._config.toJSON(),entityTypeId:this._config._id,isCommonConfig:true,moduleId:this.moduleId,useHumanResourcesModule:t==="Y",useOnAddOnUpdateSegregation:i==="Y"});n.open()},forceCommonConfigScopeForAll:function(){this._config.forceCommonScopeForAll(this._entityId).then(function(){var e=this._config.getScope();var t={id:this._id,scope:e,enableReload:true};BX.onCustomEvent(window,this.eventsNamespace+":onForceCommonConfigScopeForAll",[this,t]);if(t["enableReload"]&&!this._isEmbedded&&e!==BX.UI.EntityConfigScope.common){window.location.reload(true)}}.bind(this))},resetConfig:function(){this._config.reset(false,this._entityId).then(function(){var e=this._config.getScope();var t={id:this._id,scope:e,enableReload:true};BX.onCustomEvent(window,this.eventsNamespace+":onConfigReset",[this,t]);if(t["enableReload"]&&!this._isEmbedded){window.location.reload(true)}}.bind(this))},getConfigOption:function(e,t){return this._config.getOption(e,t)},setConfigOption:function(e,t){return this._config.setOption(e,t)},getOption:function(e,t){return BX.prop.getString(this._settings["options"],e,t)},setOption:function(e,t){if(typeof t==="undefined"||t===null){return}if(BX.prop.getString(this._settings["options"],e,null)===t){return}this._settings["options"][e]=t},getDragConfig:function(e){return BX.prop.getObject(this._dragConfig,e,{})},hasPlaceHolder:function(){return!!this._dragPlaceHolder},createPlaceHolder:function(e){var t=this.getControlCount();if(e<0||e>t){e=t>0?t:0}if(this._dragPlaceHolder){if(this._dragPlaceHolder.getIndex()===e){return this._dragPlaceHolder}this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}this._dragPlaceHolder=BX.UI.EditorDragSectionPlaceholder.create({container:this._formElement,anchor:e<t?this._controls[e].getWrapper():null,index:e});this._dragPlaceHolder.layout();return this._dragPlaceHolder},getPlaceHolder:function(){return this._dragPlaceHolder},removePlaceHolder:function(){if(this._dragPlaceHolder){this._dragPlaceHolder.clearLayout();this._dragPlaceHolder=null}},processDraggedItemDrop:function(e,t){var i=e.getCharge();if(!(i instanceof BX.UI.EditorSectionDragContainer&&i.getEditor()===this)){return}var n=t.getContextData();var o=BX.type.isNotEmptyString(n["contextId"])?n["contextId"]:"";if(o!==BX.UI.EditorSectionDragItem.contextId){return}var s=typeof n["charge"]!=="undefined"?n["charge"]:null;if(!(s instanceof BX.UI.EditorSectionDragItem)){return}var r=s.getControl();if(!r){return}var a=this.getControlIndex(r);if(a<0){return}var l=this.getPlaceHolder();var h=l?l.getIndex():-1;if(h<0){return}var d=h<=a?h:h-1;if(d!==a){this.moveControl(r,d);this.saveScheme()}},onDrop:function(e){this.processDraggedItemDrop(e.data["dropContainer"],e.data["draggedItem"])},getConfigScope:function(){return this._config.getScope()},prepareFieldLayoutOptions:function(e){var t=e.hasContentToDisplay();var i={isNeedToDisplay:t||this._showEmptyFields};if(this.isExternalLayoutResolversEnabled()){var n={id:this._id,field:e,hasContent:t,showEmptyFields:this._showEmptyFields,layoutOptions:i};BX.onCustomEvent(window,this.eventsNamespace+":onResolveFieldLayoutOptions",[this,n])}return i},isExternalLayoutResolversEnabled:function(){return!!this._enableExternalLayoutResolvers},getRestriction:function(e){return BX.prop.getObject(this._restrictions,e,null)}};BX.UI.EntityEditor.defaultInstance=null;BX.UI.EntityEditor.items={};BX.UI.EntityEditor.get=function(e){return this.items.hasOwnProperty(e)?this.items[e]:null};if(typeof BX.UI.EntityEditor.messages==="undefined"){BX.UI.EntityEditor.messages={}}BX.UI.EntityEditor.setDefault=function(e){BX.UI.EntityEditor.defaultInstance=e};BX.UI.EntityEditor.getDefault=function(){return BX.UI.EntityEditor.defaultInstance};BX.UI.EntityEditor.create=function(e,t){var i=new BX.UI.EntityEditor;i.initialize(e,t);this.items[i.getId()]=i;return i}}if(typeof BX.UI.EntityEditorModeQueue==="undefined"){BX.UI.EntityEditorModeQueue=function(){this._id="";this._settings={};this._items=[]};BX.UI.EntityEditorModeQueue.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{}},findIndex:function(e){for(var t=0,i=this._items.length;t<i;t++){if(this._items[t]["control"]===e){return t}}return-1},getLength:function(){return this._items.length},add:function(e,t,i){if(typeof i==="undefined"){i=BX.UI.EntityEditorModeOptions.none}var n=this.findIndex(e);if(n>=0){this._items[n]={control:e,mode:t,options:i}}else{this._items.push({control:e,mode:t,options:i})}},addBatch:function(e,t,i){for(var n=0,o=e.length;n<o;n++){this.add(e[n],t,i)}},remove:function(e){var t=this.findIndex(e);if(t>=0){this._items.splice(t,1)}},clear:function(){this._items=[]},process:function(){var e=this._items.length;if(e===0){return 0}for(var t=0;t<e;t++){var i=this._items[t];i["control"].setMode(i["mode"],{options:i["options"],notify:true})}return e}};BX.UI.EntityEditorModeQueue.create=function(e,t){var i=new BX.UI.EntityEditorModeQueue;i.initialize(e,t);return i}}if(typeof BX.UI.EntityEditorModeSwitch==="undefined"){BX.UI.EntityEditorModeSwitch=function(){this._id="";this._settings={};this._queue=null;this._isRunning=false;this._runHandle=0;this._runAction=""};BX.UI.EntityEditorModeSwitch.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._editor=BX.prop.get(this._settings,"editor");this._queue=BX.UI.EntityEditorModeQueue.create(this._id,{})},getQueue:function(){return this._queue},reset:function(){this._queue.clear();this._isRunning=false},isRunning:function(){return this._isRunning},setRunAction:function(e){this._runAction=e},run:function(){if(this._isRunning){return}if(this._runHandle>0){window.clearTimeout(this._runHandle)}this._runHandle=window.setTimeout(BX.delegate(this.doRun,this),50)},doRun:function(){this._editor.performSaveDelayedAction(this._runAction);this._isRunning=true;this._runHandle=0},complete:function(){this._queue.process();this.reset()}};BX.UI.EntityEditorModeSwitch.create=function(e,t){var i=new BX.UI.EntityEditorModeSwitch;i.initialize(e,t);return i}}if(typeof BX.UI.EntityEditorScopeConfig==="undefined"){BX.UI.EntityEditorScopeConfig=function(){this._id="";this._settings={};this._editor={};this._config={};this._isCommonConfig=false;this._popup=null;this._selector=null;this._popupSaveButton={};this._name="";this._items=[];this._nameInput={};this._usersInput={};this._usersInputTagSelector={};this._forceSetInput={};this._nameInputError=null;this._usersInputError=null;this._entityId="";this._entityTypeId="";this._isOpened=false;this._closeNotifier=null;this.moduleId=null;this._onSquareClick=BX.delegate(this.onSquareClick,this);this._onAddInput={};this._onUpdateInput={}};BX.UI.EntityEditorScopeConfig.prototype={initialize:function(e,t){this._id=BX.type.isNotEmptyString(e)?e:BX.util.getRandomString(4);this._settings=t?t:{};this._editor=this.getSetting("editor",{});this._config=this.getSetting("config",{});this._isCommonConfig=this.getSetting("isCommonConfig",false);this._name=this.getSetting("name","");this._items=this.getSetting("items",[]);this._entityId=this.getSetting("entityId",null);this._entityTypeId=this.getSetting("entityTypeId",null);this.moduleId=this.getSetting("moduleId",null);this.useHumanResourcesModule=this.getSetting("useHumanResourcesModule",false);this.useOnAddOnUpdateSegregation=this.getSetting("useOnAddOnUpdateSegregation",false)},getId:function(){return this._id},getSetting:function(e,t){return this._settings.hasOwnProperty(e)?this._settings[e]:t},isOpened:function(){return this._isOpened},open:function(){if(this._isOpened){return}this._popup=this.createPopup();this._popup.show()},createPopup:function(){return this._popup||new BX.PopupWindow(this._id,null,{className:"ui-entity-editor-content-user-scope-popup",titleBar:BX.message("UI_ENTITY_EDITOR_CREATE_SCOPE_MSGVER_1"),closeIcon:true,autoHide:false,closeByEsc:true,padding:0,contentPadding:0,contentBackground:"none",draggable:true,minWidth:550,maxWidth:550,content:this.prepareContent(),buttons:this.prepareButtons(),events:{onPopupShow:BX.delegate(this.onPopupShow,this),onPopupClose:BX.delegate(this.onPopupClose,this),onPopupDestroy:BX.delegate(this.onPopupDestroy,this)}})},prepareContent:function(){var e=BX.create("div",{style:{padding:"0 20px"}});e.appendChild(this.prepareNameControl());e.appendChild(this.prepareUserSelectControl());e.appendChild(this.prepareForceSetToUsersControl());if(this.useOnAddOnUpdateSegregation){e.appendChild(this.prepareAvailableOnAddControl());e.appendChild(this.prepareAvailableonUpdateControl())}return e},prepareNameControl:function(){var e=BX.create("div",{style:{paddingBottom:"25px",marginBottom:"20px",borderBottom:"1px solid #f2f2f4"}});e.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"},text:BX.message("UI_ENTITY_EDITOR_CONFIG_SCOPE_NAME_MSGVER_1")}));var t=BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}});this._nameInput=BX.create("input",{props:{className:"ui-ctl-element",value:this.getName(),type:"text"}});t.appendChild(this._nameInput);e.appendChild(t);return e},prepareUserSelectControl:function(){var e=BX.create("div",{style:{paddingBottom:"25px",marginBottom:"10px",borderBottom:"1px solid #f2f2f4"}});e.appendChild(BX.create("div",{props:{className:"ui-ctl-label-text"},text:BX.message("UI_ENTITY_EDITOR_CONFIG_SCOPE_MEMBERS_MSGVER_1")}));var t=BX.create("div",{props:{className:"ui-ctl ui-ctl-textbox ui-ctl-w100"}});this._usersInput=BX.create("div",{style:{width:"100%"},attrs:{id:"user-selector-item"}});t.appendChild(this._usersInput);e.appendChild(t);this._usersInputTagSelector=new BX.UI.EntitySelector.TagSelector({dialogOptions:{context:"UI_ENTITY_EDITOR_SCOPE",entities:[{id:"user"},{id:"project"},{id:this.useHumanResourcesModule===true?"structure-node":"department",options:{selectMode:"usersAndDepartments"}}]}});this._usersInputTagSelector.renderTo(this._usersInput);return e},prepareInputCheckboxTag(){return BX.Tag.render`
					<input class="ui-ctl-element" type="checkbox" checked="checked">
				`},prepareCheckBoxField(e,t,i){if(!BX.Type.isElementNode(e)||!BX.Type.isString(t)){return}const n=BX.Tag.render`
					<div style="padding-bottom: 10px; border-bottom: 1px solid #f2f2f4"></div>
				`;const o=BX.Tag.render`
					<div class="ui-ctl ui-ctl-checkbox ui-ctl-w100"></div
				`;BX.Dom.append(e,o);BX.Dom.append(BX.Tag.render`
					<div class="ui-ctl-label-text">${t}</div
				`,o);if(BX.Type.isElementNode(i)){BX.Dom.append(i,o)}BX.Dom.append(o,n);return n},prepareForceSetToUsersControl:function(){this._forceSetInput=this.prepareInputCheckboxTag();return this.prepareCheckBoxField(this._forceSetInput,BX.Loc.getMessage("UI_ENTITY_EDITOR_CONFIG_SCOPE_FORCE_INSTALL_TO_USERS_MSGVER_1"),BX.UI.Hint.createNode(BX.message("UI_ENTITY_EDITOR_CONFIG_HINT_SCOPE_FORCE_INSTALL_TO_USERS")))},prepareAvailableOnAddControl:function(){this._onAddInput=this.prepareInputCheckboxTag();return this.prepareCheckBoxField(this._onAddInput,BX.Loc.getMessage("UI_ENTITY_EDITOR_CONFIG_SCOPE_SET_AVAILABLE_ON_ADD"),BX.UI.Hint.createNode(BX.message("UI_ENTITY_EDITOR_CONFIG_HINT_SCOPE_SET_AVAILABLE_ON_ADD")))},prepareAvailableonUpdateControl:function(){this._onUpdateInput=this.prepareInputCheckboxTag();return this.prepareCheckBoxField(this._onUpdateInput,BX.Loc.getMessage("UI_ENTITY_EDITOR_CONFIG_SCOPE_SET_AVAILABLE_ON_UPDATE"),BX.UI.Hint.createNode(BX.message("UI_ENTITY_EDITOR_CONFIG_HINT_SCOPE_SET_AVAILABLE_ON_UPDATE")))},prepareButtons:function(){return[this._popupSaveButton=new BX.UI.Button({text:BX.message("UI_ENTITY_EDITOR_CONFIG_SCOPE_SAVE"),tag:BX.UI.Button.Tag.LINK,color:BX.UI.Button.Color.PRIMARY,events:{click:function(e,t){t.preventDefault();this.processSave()}.bind(this)},useAirDesign:true,style:BX.UI.Button.AirStyle.FILLED}),new BX.UI.Button({text:BX.message("UI_ENTITY_EDITOR_CONFIG_SCOPE_CANCEL"),tag:BX.UI.Button.Tag.LINK,color:BX.UI.Button.Color.LINK,events:{click:function(e,t){t.preventDefault();this.processCancel()}.bind(this)},useAirDesign:true,style:BX.UI.Button.AirStyle.PLAIN})]},close:function(){if(this._popup){this._popup.close()}},addCloseListener:function(e){this._closeNotifier.addListener(e)},removeCloseListener:function(e){this._closeNotifier.removeListener(e)},createUserInfo:function(e){return{ID:e.id,FORMATTED_NAME:BX.util.htmlspecialcharsback(BX.prop.getString(e,"name",""))}},isCustomized:function(){var e=BX.prop.getObject(this._config,"accessCodes",[]);return!!Object.keys(e).length},getName:function(){return this._name},setName:function(e){this._name=e},processSave:function(){if(this._popupSaveButton.isWaiting()){return}this._popupSaveButton.setWaiting();this.clearErrors();this.setName(this._nameInput.value);BX.ajax.runComponentAction("bitrix:ui.form.config","save",{data:{moduleId:this.moduleId,entityTypeId:this._entityTypeId,name:this.getName(),accessCodes:this.getSelectedItems(),config:this._config,params:{forceSetToUsers:this._forceSetInput.checked,categoryName:this._editor._config.categoryName,common:"Y",availableOnAdd:this._onAddInput.checked,availableOnUpdate:this._onUpdateInput.checked}}}).then(function(e){this._popupSaveButton.setWaiting(false);this.close();BX.UI.EntityEditorScopeConfig.prototype.notifyShow(e);var t=parseInt(e.data,10);this._editor.setConfigScope(BX.UI.EntityConfigScope.custom,t)}.bind(this)).catch(function(e){this._popupSaveButton.setWaiting(false);this.fillErrors(e.data)}.bind(this))},getSelectedItems:function(){var e=this._usersInputTagSelector.getTags();return e.map((function(e){return{id:e.id,entityId:e.entityId}}))},fillErrors:function(e){if(e.name){this._nameInputError=this.createErrorElement(this._nameInput,e.name.message)}if(e.accessCodes){this._usersInputError=this.createErrorElement(this._usersInput,e.accessCodes.message)}},createErrorElement:function(e,t){var i=BX.create("div",{props:{className:"ui-entity-section-control-error-text"}});i.innerHTML=t;e.parentNode.parentNode.appendChild(i);return i},clearErrors:function(){if(this._nameInputError){this._nameInputError.remove()}if(this._usersInputError){this._usersInputError.remove()}},notifyShow:function(e){window.top.BX.UI.Notification.Center.notify({content:BX.message("UI_ENTITY_EDITOR_CONFIG_SCOPE_SAVED_MSGVER_1"),width:"auto"})},processCancel:function(){this.close()},onPopupShow:function(){this._isOpened=true},onPopupClose:function(){if(this._popup){this._popup.destroy()}},onPopupDestroy:function(){this._isOpened=false;this._popup=null}};if(BX.UI.EntityEditorScopeConfig.messages===undefined){BX.UI.EntityEditorScopeConfig.messages={}}BX.UI.EntityEditorScopeConfig.create=function(e,t){var i=new BX.UI.EntityEditorScopeConfig;i.initialize(e,t);return i}}
//# sourceMappingURL=editor.map.js